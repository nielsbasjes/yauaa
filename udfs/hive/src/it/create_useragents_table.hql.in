--
-- Copyright (C) 2018-2021 Niels Basjes
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
-- https://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.
--

!echo "==========================================================================";
!echo "Create the database testdb";
create database if not exists testdb;
use testdb;

!echo "=-------------------------------------------------------------------------";
!echo "Create the table clickLogs with the test record";
drop table clickLogs;

!echo "=-------------------------------------------------------------------------";
create table if not exists clickLogs (
  useragent string
);

!echo "=-------------------------------------------------------------------------";
describe clickLogs;

!echo "=-------------------------------------------------------------------------";
insert into clickLogs
values ('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36');

!echo "=-------------------------------------------------------------------------";
select * from clickLogs;


!echo "==========================================================================";
!echo "Make the function available as a temporary function";
ADD JAR hdfs:///udf/@JARNAME@;
DROP     FUNCTION IF EXISTS ParseUserAgentTmp;
CREATE   FUNCTION ParseUserAgentTmp AS 'nl.basjes.parse.useragent.hive.ParseUserAgent';
DESCRIBE FUNCTION EXTENDED ParseUserAgentTmp;

!echo "=-------------------------------------------------------------------------";
!echo "[1] Run query using table";
SELECT ParseUserAgentTmp(useragent).DeviceClass,
       ParseUserAgentTmp(useragent).OperatingsystemNameVersion,
       ParseUserAgentTmp(useragent).AgentNameVersionMajor
FROM   clickLogs;

!echo "=-------------------------------------------------------------------------";
!echo "[2] Run query using direct value";
SELECT ParseUserAgentTmp('Mozilla/5.0 (Linux\; Android 6.0\; Nexus 6 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36');


!echo "==========================================================================";
!echo "Make the function available as a permanent function";
DROP     FUNCTION IF EXISTS ParseUserAgent;
CREATE   FUNCTION ParseUserAgent AS 'nl.basjes.parse.useragent.hive.ParseUserAgent' USING JAR 'hdfs:///udf/@JARNAME@';
DESCRIBE FUNCTION EXTENDED ParseUserAgent;

!echo "=-------------------------------------------------------------------------";
!echo "[1] Run query using table";
SELECT ParseUserAgent(useragent).DeviceClass,
       ParseUserAgent(useragent).OperatingsystemNameVersion,
       ParseUserAgent(useragent).AgentNameVersionMajor
FROM   clickLogs;

!echo "=-------------------------------------------------------------------------";
!echo "[2] Run query using direct value";
SELECT ParseUserAgent('Mozilla/5.0 (Linux\; Android 6.0\; Nexus 6 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36');
!echo "==========================================================================";

--
-- This only works on released versions.
--
-- !echo "==========================================================================";
-- !echo "Make the function available as a externally loaded permanent function";
-- DROP     FUNCTION IF EXISTS ParseUserAgent;
-- CREATE FUNCTION ParseUserAgent
-- AS 'nl.basjes.parse.useragent.hive.ParseUserAgent'
-- USING JAR 'ivy://nl.basjes.parse.useragent:yauaa-hive:6.0?classifier=udf';
-- DESCRIBE FUNCTION EXTENDED ParseUserAgent;
--
-- !echo "=-------------------------------------------------------------------------";
-- !echo "[1] Run query using table";
-- SELECT ParseUserAgent(useragent).DeviceClass,
--        ParseUserAgent(useragent).OperatingsystemNameVersion,
--        ParseUserAgent(useragent).AgentNameVersionMajor
-- FROM   clickLogs GROUP BY useragent;
--
-- !echo "=-------------------------------------------------------------------------";
-- !echo "[2] Run query using direct value";
-- SELECT ParseUserAgent('Mozilla/5.0 (Linux\; Android 6.0\; Nexus 6 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36');
-- !echo "==========================================================================";
--
