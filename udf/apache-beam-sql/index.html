<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.2"><meta name=description content="This is a java library that tries to parse and analyze the useragent string (and when available the User-Agent Client Hints) and extract as many relevant attributes as possible."><meta name=author content="Niels Basjes"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#2d89ef"><meta name=msapplication-TileImage content="/favicon/mstile-144x144.png"><meta name=theme-color content="#ffffff"><title>Apache Beam SQL | Yauaa - Yet Another UserAgent Analyzer</title>
<link href=/css/nucleus.css?1726767262 rel=stylesheet><link href=/css/fontawesome-all.min.css?1726767262 rel=stylesheet><link href=/css/hybrid.css?1726767262 rel=stylesheet><link href=/css/featherlight.min.css?1726767262 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1726767262 rel=stylesheet><link href=/css/auto-complete.css?1726767262 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1726767262 rel=stylesheet><link href=/css/theme.css?1726767262 rel=stylesheet><link href=/css/tabs.css?1726767262 rel=stylesheet><link href=/css/hugo-theme.css?1726767262 rel=stylesheet><link href=/css/theme-yauaa.css?1726767262 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1726767262></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style><script type=text/javascript>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="https://wa.basjes.nl/",_paq.push(["setTrackerUrl",t+"wa.php"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src=t+"wa.js",s.parentNode.insertBefore(e,s)}()</script></head><body data-url=/udf/apache-beam-sql/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class=logo-bar>Yauaa</p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1726767262></script><script type=text/javascript src=/js/auto-complete.js?1726767262></script><script type=text/javascript>var baseurl="/"</script><script type=text/javascript src=/js/search.js?1726767262></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Yauaa</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/expect/ title="What to expect" class=dd-item><a href=/expect/>What to expect</a><ul><li data-nav-id=/expect/fieldvalues/ title="Field values" class=dd-item><a href=/expect/fieldvalues/>Field values</a></li><li data-nav-id=/expect/performance/ title=Performance class=dd-item><a href=/expect/performance/>Performance</a></li><li data-nav-id=/expect/limitations/ title=Limitations class=dd-item><a href=/expect/limitations/>Limitations</a></li><li data-nav-id=/expect/manipulations/ title=Manipulations class=dd-item><a href=/expect/manipulations/>Manipulations</a></li><li data-nav-id=/expect/tryit/ title="Try it!" class=dd-item><a href=/expect/tryit/>Try it!</a></li></ul></li><li data-nav-id=/using/ title="Using the analyzer" class=dd-item><a href=/using/>Using Yauaa</a><ul><li data-nav-id=/using/clienthints/ title="User-Agent Client Hints" class=dd-item><a href=/using/clienthints/>User-Agent Client Hints</a></li><li data-nav-id=/using/memoryusage/ title="Memory usage" class=dd-item><a href=/using/memoryusage/>Memory usage</a></li><li data-nav-id=/using/webservlet/ title="The demonstration webservlet" class=dd-item><a href=/using/webservlet/>Webservlet</a></li><li data-nav-id=/using/kubernetes/ title=Kubernetes class=dd-item><a href=/using/kubernetes/>Kubernetes</a></li><li data-nav-id=/using/license/ title=Licence class=dd-item><a href=/using/license/>Licence</a></li></ul></li><li data-nav-id=/udf/ title="User Defined Functions" class="dd-item
parent"><a href=/udf/>User Defined Functions</a><ul><li data-nav-id=/udf/apache-beam/ title="Apache Beam" class=dd-item><a href=/udf/apache-beam/>Apache Beam</a></li><li data-nav-id=/udf/apache-beam-sql/ title="Apache Beam SQL" class="dd-item active"><a href=/udf/apache-beam-sql/>Apache Beam SQL</a></li><li data-nav-id=/udf/apache-drill/ title="Apache Drill" class=dd-item><a href=/udf/apache-drill/>Apache Drill</a></li><li data-nav-id=/udf/apache-flink/ title="Apache Flink" class=dd-item><a href=/udf/apache-flink/>Apache Flink</a></li><li data-nav-id=/udf/apache-flink-table/ title="Apache Flink Table/SQL" class=dd-item><a href=/udf/apache-flink-table/>Apache Flink Table/SQL</a></li><li data-nav-id=/udf/apache-hive/ title="Apache Hive" class=dd-item><a href=/udf/apache-hive/>Apache Hive</a></li><li data-nav-id=/udf/apache-nifi/ title="Apache Nifi" class=dd-item><a href=/udf/apache-nifi/>Apache Nifi</a></li><li data-nav-id=/udf/apache-pig/ title="Apache Pig" class=dd-item><a href=/udf/apache-pig/>Apache Pig</a></li><li data-nav-id=/udf/commandline/ title="Commandline usage" class=dd-item><a href=/udf/commandline/>Commandline usage</a></li><li data-nav-id=/udf/elastic-logstash/ title="Elastic LogStash" class=dd-item><a href=/udf/elastic-logstash/>Elastic LogStash</a></li><li data-nav-id=/udf/elastic-search/ title="Elastic Search" class=dd-item><a href=/udf/elastic-search/>Elastic Search</a></li><li data-nav-id=/udf/logparser/ title=LogParser class=dd-item><a href=/udf/logparser/>LogParser</a></li><li data-nav-id=/udf/snowflake/ title=Snowflake class=dd-item><a href=/udf/snowflake/>Snowflake</a></li><li data-nav-id=/udf/snowplow/ title=Snowplow class=dd-item><a href=/udf/snowplow/>Snowplow</a></li><li data-nav-id=/udf/trino/ title=Trino class=dd-item><a href=/udf/trino/>Trino</a></li></ul></li><li data-nav-id=/developer/ title=Development class=dd-item><a href=/developer/>Development</a><ul><li data-nav-id=/developer/building/ title="Building from source" class=dd-item><a href=/developer/building/>Building from source</a></li><li data-nav-id=/developer/basedesign/ title="Base Design" class=dd-item><a href=/developer/basedesign/>Base Design</a></li><li data-nav-id=/developer/makingnewrules/ title="Making new rules" class=dd-item><a href=/developer/makingnewrules/>Making new rules</a></li><li data-nav-id=/developer/shadingdependencies/ title="Shading dependencies" class=dd-item><a href=/developer/shadingdependencies/>Shading dependencies</a></li><li data-nav-id=/developer/reportingissues/ title="Reporting issues" class=dd-item><a href=/developer/reportingissues/>Reporting issues</a></li></ul></li><li data-nav-id=/other/ title=Other class=dd-item><a href=/other/>Other</a><ul><li data-nav-id=/other/article/ title=Blogpost class=dd-item><a href=/other/article/>Blogpost</a></li><li data-nav-id=/other/relatedprojects/ title="Related projects" class=dd-item><a href=/other/relatedprojects/>Related projects</a></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/nielsbasjes/yauaa><i class='fab fa-git-square'></i> Git repo</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/discussions><i class='fa fa-comment-alt'></i> Discussions</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/blob/main/CHANGELOG.md><i class='fa fa-file-alt'></i> Changelog</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/issues><i class='fa fa-bug'></i> Issue tracker</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/actions><img alt="Github actions Build status" src="https://img.shields.io/github/actions/workflow/status/nielsbasjes/yauaa/build.yml?branch=main"></a></li><li><a class=padding href=https://app.codecov.io/gh/nielsbasjes/yauaa><img alt="Coverage Status" src=https://img.shields.io/codecov/c/github/nielsbasjes/yauaa></a></li><li><a class=padding href=https://www.apache.org/licenses/LICENSE-2.0.html><img alt=License src=https://img.shields.io/:license-apache-blue.svg></a></li><li><a class=padding href=https://central.sonatype.com/namespace/nl.basjes.parse.useragent><img alt="Maven Central" src=https://img.shields.io/maven-central/v/nl.basjes.parse.useragent/yauaa-parent.svg></a></li><li><a class=padding href=https://github.com/jvm-repo-rebuild/reproducible-central#nl.basjes.parse.useragent:yauaa><img alt="Reproducible Builds" src="https://img.shields.io/badge/Reproducible_Builds-ok-success?labelColor=1e5b96"></a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/stargazers><img alt="GitHub stars" src="https://img.shields.io/github/stars/nielsbasjes/yauaa?label=GitHub%20stars"></a></li><li><a class=padding href=https://hub.docker.com/r/nielsbasjes/yauaa><img alt="Docker Hub" src=https://img.shields.io/docker/pulls/nielsbasjes/yauaa></a></li><li><a class=padding href=https://github.com/sponsors/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Sponsor%20me-via%20Github-red.svg></a></li><li><a class=padding href=https://www.paypal.me/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Donations-via%20Paypal-red.svg></a></li></ul></section><section id=footer><p>&copy;2013-2023 by <a href=https://niels.basjes.nl>Niels Basjes</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/nielsbasjes/yauaa/tree/main/documentation/content/udf/Apache-Beam-Sql.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/>Yauaa: Yet Another UserAgent Analyzer</a> > <a href=/udf/>User Defined Functions</a> > Apache Beam SQL</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#getting-the-udf>Getting the UDF</a></li><li><a href=#available-functions>Available functions</a><ul><li><a href=#getting-a-single-value>Getting a single value</a></li><li><a href=#getting-several-values-as-a-map-requires-apache-beam-2300-or-newer>Getting several values as a Map (requires Apache Beam 2.30.0 or newer)</a></li><li><a href=#getting-several-values-as-json>Getting several values as JSon</a></li></ul></li><li><a href=#example-usage>Example usage</a></li><li><a href=#limitations--future>Limitations / Future</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Apache Beam SQL</h1><h2 id=introduction>Introduction</h2><p>This is a User Defined Function for <a href=https://beam.apache.org>Apache Beam SQL</a>.</p><h2 id=getting-the-udf>Getting the UDF</h2><p>You can get the prebuilt UDF from <a href=https://central.sonatype.com/artifact/nl.basjes.parse.useragent/yauaa-beam-sql/7.28.1/jar>maven central</a>.</p><p>If you use a maven based project simply add this dependency to your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>nl.basjes.parse.useragent<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>yauaa-beam-sql<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>7.28.1<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=available-functions>Available functions</h2><h3 id=getting-a-single-value>Getting a single value</h3><p>To get a single value from the parse result use this one:</p><pre><code>ParseUserAgentField(userAgent, 'DeviceClass')  AS deviceClassField
</code></pre><p>to give</p><pre><code>Phone
</code></pre><h3 id=getting-several-values-as-a-map-requires-apache-beam-2300-or-newer>Getting several values as a Map (requires Apache Beam 2.30.0 or newer)</h3><p>You can ask for all fields and return the full map with all of them in there.</p><pre><code>ParseUserAgent(userAgent)                                    AS allFields
</code></pre><p>If you want to make use of the support for the <code>User-Agent Client Hints</code> you must call the function from your SQL with a list of <code>header name</code> and <code>value</code>. The header names must be the same as what a browser would send to the webserver (see: <a href=https://wicg.github.io/ua-client-hints/#http-ua-hints>Specification</a>).</p><p>Essentially two forms are now possible:</p><pre><code>ParseUserAgent ( &lt;useragent&gt; , [&lt;header name&gt;,&lt;value&gt;]+ )
</code></pre><p>and the variant which requires the presense of a <code>User-Agent</code> header.</p><pre><code>ParseUserAgent ( [&lt;header name&gt;,&lt;value&gt;]+ )
</code></pre><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>ParseUserAgent(
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#39;User-Agent&#39;</span>,                   useragent,
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#39;Sec-CH-UA-Platform&#39;</span>,           chPlatform,
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#39;Sec-CH-UA-Platform-Version&#39;</span>,   chPlatformVersion
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>AS</span> parsedUseragent
</span></span></code></pre></div><p>If you need multiple fields but not all of them you can ask for only those specific fields:</p><pre><code>ParseUserAgent(userAgent, 'DeviceClass', 'AgentNameVersion') AS someFields
</code></pre><p>With such a map you can then extract the field you really need with SQL syntax similar to this:</p><pre><code>ParseUserAgent(userAgent, 'DeviceClass')['DeviceClass']      AS deviceClass

ParseUserAgent(userAgent)['AgentNameVersion']                AS agentNameVersion
</code></pre><p>Because a Beam SQL UDF cannot have a constructor there is no performance gain from limiting the required fields during the analysis phase. It does make the returned set smaller and thus in terms of transport and serialization a bit faster.</p><p>If you als want the client hints all of these parameters can be combined like this:</p><pre><code>ParseUserAgent(
     'user-Agent',                   userAgent,
     'sec-CH-UA-Platform',           chPlatform,
     'sec-CH-UA-Platform-Version',   chPlatformVersion
     'DeviceClass',
     'AgentNameVersionMajor',
     'OperatingSystemNameVersion',
)
</code></pre><p>which is equivalent to (i.e. the ordering of the &ldquo;wanted fields&rdquo; and the &ldquo;request headers with value&rdquo; can be shuffled):</p><pre><code>ParseUserAgent(
     'DeviceClass',
     'user-Agent',                   userAgent,
     'AgentNameVersionMajor',
     'sec-CH-UA-Platform',           chPlatform,
     'OperatingSystemNameVersion',
     'sec-CH-UA-Platform-Version',   chPlatformVersion
)
</code></pre><h3 id=getting-several-values-as-json>Getting several values as JSon</h3><p>Assuming the input</p><pre><code>Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36
</code></pre><p>To parse this input value into all possible values and returns the complete result as a single JSon string use this:</p><pre><code>ParseUserAgentJson(userAgent)
</code></pre><p>to give (single line)</p><pre><code>{&quot;Useragent&quot;:&quot;Mozilla\/5.0 (Linux; Android 7.0; Nexus 6 Build\/NBD90Z) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/53.0.2785.124 Mobile Safari\/537.36&quot;,
&quot;DeviceClass&quot;:&quot;Phone&quot;,&quot;DeviceName&quot;:&quot;Google Nexus 6&quot;,&quot;DeviceBrand&quot;:&quot;Google&quot;,
&quot;OperatingSystemClass&quot;:&quot;Mobile&quot;,&quot;OperatingSystemName&quot;:&quot;Android&quot;,&quot;OperatingSystemVersion&quot;:&quot;7.0&quot;,&quot;OperatingSystemVersionMajor&quot;:&quot;7&quot;,&quot;OperatingSystemNameVersion&quot;:&quot;Android 7.0&quot;,&quot;OperatingSystemNameVersionMajor&quot;:&quot;Android 7&quot;,&quot;OperatingSystemVersionBuild&quot;:&quot;NBD90Z&quot;,
&quot;LayoutEngineClass&quot;:&quot;Browser&quot;,&quot;LayoutEngineName&quot;:&quot;Blink&quot;,&quot;LayoutEngineVersion&quot;:&quot;53.0&quot;,&quot;LayoutEngineVersionMajor&quot;:&quot;53&quot;,&quot;LayoutEngineNameVersion&quot;:&quot;Blink 53.0&quot;,&quot;LayoutEngineNameVersionMajor&quot;:&quot;Blink 53&quot;,
&quot;AgentClass&quot;:&quot;Browser&quot;,&quot;AgentName&quot;:&quot;Chrome&quot;,&quot;AgentVersion&quot;:&quot;53.0.2785.124&quot;,&quot;AgentVersionMajor&quot;:&quot;53&quot;,&quot;AgentNameVersion&quot;:&quot;Chrome 53.0.2785.124&quot;,&quot;AgentNameVersionMajor&quot;:&quot;Chrome 53&quot;}
</code></pre><p>To get a JSon with only specific fields you can do (up to 10 fields van be requested this way)</p><pre><code>ParseUserAgentJson(userAgent, 'DeviceClass', 'AgentNameVersion')
</code></pre><p>to give</p><pre><code>{&quot;DeviceClass&quot;:&quot;Phone&quot;,&quot;AgentNameVersion&quot;:&quot;Chrome 53.0.2785.124&quot;}
</code></pre><p>Note that the Client Hints model also applies here so this works too:</p><pre><code>ParseUserAgentJson(
     'DeviceClass',
     'user-Agent',                   userAgent,
     'AgentNameVersionMajor',
     'sec-CH-UA-Platform',           chPlatform,
     'OperatingSystemNameVersion',
     'sec-CH-UA-Platform-Version',   chPlatformVersion
)
</code></pre><h2 id=example-usage>Example usage</h2><p>Assume you have a PCollection with your records.</p><pre><code>PCollection&lt;Row&gt; input = ...
</code></pre><p>You can then put that through an SQL statement to transform it.
You have to name the input (in this example we call it InputStream),
and you have to register the UDF classes you want to use with the name you want to have in your SQL statement.</p><pre><code>PCollection&lt;Row&gt; result =
  // This way we give a name to the input stream for use in the SQL
  PCollectionTuple.of(&quot;InputStream&quot;, input)
    // Apply the SQL with the UDFs we need.
    .apply(&quot;Execute SQL&quot;, SqlTransform
      .query(
        &quot;SELECT&quot; +
        &quot;    userAgent                                                     AS userAgent, &quot; +
        &quot;    ParseUserAgent(userAgent, 'DeviceClass', 'AgentNameVersion')  AS parsedUserAgentMap, &quot; +
        &quot;    ParseUserAgentJson(userAgent)                                 AS parsedUserAgentJson, &quot; +
        &quot;    ParseUserAgentField(userAgent, 'DeviceClass')                 AS deviceClass, &quot; +
        &quot;    ParseUserAgentField(userAgent, 'AgentNameVersion')            AS agentNameVersion &quot; +
        &quot;FROM InputStream&quot;)
      .registerUdf(&quot;ParseUserAgent&quot;,      ParseUserAgent.class)
      .registerUdf(&quot;ParseUserAgentJson&quot;,  ParseUserAgentJson.class)
      .registerUdf(&quot;ParseUserAgentField&quot;, ParseUserAgentField.class)
    );
</code></pre><h2 id=limitations--future>Limitations / Future</h2><p>The <code>ParseUserAgent</code> and <code>ParseUserAgentJson</code> have a limitation of at most 10 fieldnames because Calcite does not yet support variable arguments for UDFs. If you need more than 10 fields you currently need to get <code>all</code> fields and then extract the fields you need from there.</p><ul><li><a href=https://issues.apache.org/jira/browse/CALCITE-2772>https://issues.apache.org/jira/browse/CALCITE-2772</a></li></ul><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1726767262></script><script src=/js/perfect-scrollbar.min.js?1726767262></script><script src=/js/perfect-scrollbar.jquery.min.js?1726767262></script><script src=/js/jquery.sticky.js?1726767262></script><script src=/js/featherlight.min.js?1726767262></script><script src=/js/highlight.pack.js?1726767262></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1726767262></script><script src=/js/learn.js?1726767262></script><script src=/js/hugo-learn.js?1726767262></script></body></html>