<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.124.1"><meta name=description content="This is a java library that tries to parse and analyze the useragent string (and when available the User-Agent Client Hints) and extract as many relevant attributes as possible."><meta name=author content="Niels Basjes"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#2d89ef"><meta name=msapplication-TileImage content="/favicon/mstile-144x144.png"><meta name=theme-color content="#ffffff"><title>Using the analyzer | Yauaa - Yet Another UserAgent Analyzer</title>
<link href=/css/nucleus.css?1712046033 rel=stylesheet><link href=/css/fontawesome-all.min.css?1712046033 rel=stylesheet><link href=/css/hybrid.css?1712046033 rel=stylesheet><link href=/css/featherlight.min.css?1712046033 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1712046033 rel=stylesheet><link href=/css/auto-complete.css?1712046033 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1712046033 rel=stylesheet><link href=/css/theme.css?1712046033 rel=stylesheet><link href=/css/tabs.css?1712046033 rel=stylesheet><link href=/css/hugo-theme.css?1712046033 rel=stylesheet><link href=/css/theme-yauaa.css?1712046033 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1712046033></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style><script type=text/javascript>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="https://wa.basjes.nl/",_paq.push(["setTrackerUrl",t+"wa.php"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src=t+"wa.js",s.parentNode.insertBefore(e,s)}()</script></head><body data-url=/using/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><p class=logo-bar>Yauaa</p></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1712046033></script><script type=text/javascript src=/js/auto-complete.js?1712046033></script><script type=text/javascript>var baseurl="/"</script><script type=text/javascript src=/js/search.js?1712046033></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Yauaa</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/expect/ title="What to expect" class=dd-item><a href=/expect/>What to expect</a><ul><li data-nav-id=/expect/fieldvalues/ title="Field values" class=dd-item><a href=/expect/fieldvalues/>Field values</a></li><li data-nav-id=/expect/performance/ title=Performance class=dd-item><a href=/expect/performance/>Performance</a></li><li data-nav-id=/expect/limitations/ title=Limitations class=dd-item><a href=/expect/limitations/>Limitations</a></li><li data-nav-id=/expect/manipulations/ title=Manipulations class=dd-item><a href=/expect/manipulations/>Manipulations</a></li><li data-nav-id=/expect/tryit/ title="Try it!" class=dd-item><a href=/expect/tryit/>Try it!</a></li></ul></li><li data-nav-id=/using/ title="Using the analyzer" class="dd-item
active"><a href=/using/>Using Yauaa</a><ul><li data-nav-id=/using/clienthints/ title="User-Agent Client Hints" class=dd-item><a href=/using/clienthints/>User-Agent Client Hints</a></li><li data-nav-id=/using/memoryusage/ title="Memory usage" class=dd-item><a href=/using/memoryusage/>Memory usage</a></li><li data-nav-id=/using/webservlet/ title="The demonstration webservlet" class=dd-item><a href=/using/webservlet/>Webservlet</a></li><li data-nav-id=/using/kubernetes/ title=Kubernetes class=dd-item><a href=/using/kubernetes/>Kubernetes</a></li><li data-nav-id=/using/license/ title=Licence class=dd-item><a href=/using/license/>Licence</a></li></ul></li><li data-nav-id=/udf/ title="User Defined Functions" class=dd-item><a href=/udf/>User Defined Functions</a><ul><li data-nav-id=/udf/apache-beam/ title="Apache Beam" class=dd-item><a href=/udf/apache-beam/>Apache Beam</a></li><li data-nav-id=/udf/apache-beam-sql/ title="Apache Beam SQL" class=dd-item><a href=/udf/apache-beam-sql/>Apache Beam SQL</a></li><li data-nav-id=/udf/apache-drill/ title="Apache Drill" class=dd-item><a href=/udf/apache-drill/>Apache Drill</a></li><li data-nav-id=/udf/apache-flink/ title="Apache Flink" class=dd-item><a href=/udf/apache-flink/>Apache Flink</a></li><li data-nav-id=/udf/apache-flink-table/ title="Apache Flink Table/SQL" class=dd-item><a href=/udf/apache-flink-table/>Apache Flink Table/SQL</a></li><li data-nav-id=/udf/apache-hive/ title="Apache Hive" class=dd-item><a href=/udf/apache-hive/>Apache Hive</a></li><li data-nav-id=/udf/apache-nifi/ title="Apache Nifi" class=dd-item><a href=/udf/apache-nifi/>Apache Nifi</a></li><li data-nav-id=/udf/apache-pig/ title="Apache Pig" class=dd-item><a href=/udf/apache-pig/>Apache Pig</a></li><li data-nav-id=/udf/commandline/ title="Commandline usage" class=dd-item><a href=/udf/commandline/>Commandline usage</a></li><li data-nav-id=/udf/elastic-logstash/ title="Elastic LogStash" class=dd-item><a href=/udf/elastic-logstash/>Elastic LogStash</a></li><li data-nav-id=/udf/elastic-search/ title="Elastic Search" class=dd-item><a href=/udf/elastic-search/>Elastic Search</a></li><li data-nav-id=/udf/logparser/ title=LogParser class=dd-item><a href=/udf/logparser/>LogParser</a></li><li data-nav-id=/udf/snowflake/ title=Snowflake class=dd-item><a href=/udf/snowflake/>Snowflake</a></li><li data-nav-id=/udf/snowplow/ title=Snowplow class=dd-item><a href=/udf/snowplow/>Snowplow</a></li><li data-nav-id=/udf/trino/ title=Trino class=dd-item><a href=/udf/trino/>Trino</a></li></ul></li><li data-nav-id=/developer/ title=Development class=dd-item><a href=/developer/>Development</a><ul><li data-nav-id=/developer/building/ title="Building from source" class=dd-item><a href=/developer/building/>Building from source</a></li><li data-nav-id=/developer/basedesign/ title="Base Design" class=dd-item><a href=/developer/basedesign/>Base Design</a></li><li data-nav-id=/developer/makingnewrules/ title="Making new rules" class=dd-item><a href=/developer/makingnewrules/>Making new rules</a></li><li data-nav-id=/developer/shadingdependencies/ title="Shading dependencies" class=dd-item><a href=/developer/shadingdependencies/>Shading dependencies</a></li><li data-nav-id=/developer/reportingissues/ title="Reporting issues" class=dd-item><a href=/developer/reportingissues/>Reporting issues</a></li></ul></li><li data-nav-id=/other/ title=Other class=dd-item><a href=/other/>Other</a><ul><li data-nav-id=/other/article/ title=Blogpost class=dd-item><a href=/other/article/>Blogpost</a></li><li data-nav-id=/other/relatedprojects/ title="Related projects" class=dd-item><a href=/other/relatedprojects/>Related projects</a></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/nielsbasjes/yauaa><i class='fab fa-git-square'></i> Git repo</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/discussions><i class='fa fa-comment-alt'></i> Discussions</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/blob/main/CHANGELOG.md><i class='fa fa-file-alt'></i> Changelog</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/issues><i class='fa fa-bug'></i> Issue tracker</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/actions><img alt="Github actions Build status" src="https://img.shields.io/github/actions/workflow/status/nielsbasjes/yauaa/build.yml?branch=main"></a></li><li><a class=padding href=https://app.codecov.io/gh/nielsbasjes/yauaa><img alt="Coverage Status" src=https://img.shields.io/codecov/c/github/nielsbasjes/yauaa></a></li><li><a class=padding href=https://www.apache.org/licenses/LICENSE-2.0.html><img alt=License src=https://img.shields.io/:license-apache-blue.svg></a></li><li><a class=padding href=https://central.sonatype.com/namespace/nl.basjes.parse.useragent><img alt="Maven Central" src=https://img.shields.io/maven-central/v/nl.basjes.parse.useragent/yauaa-parent.svg></a></li><li><a class=padding href=https://github.com/jvm-repo-rebuild/reproducible-central#nl.basjes.parse.useragent:yauaa><img alt="Reproducible Builds" src="https://img.shields.io/badge/Reproducible_Builds-ok-success?labelColor=1e5b96"></a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/stargazers><img alt="GitHub stars" src="https://img.shields.io/github/stars/nielsbasjes/yauaa?label=GitHub%20stars"></a></li><li><a class=padding href=https://hub.docker.com/r/nielsbasjes/yauaa><img alt="Docker Hub" src=https://img.shields.io/docker/pulls/nielsbasjes/yauaa></a></li><li><a class=padding href=https://github.com/sponsors/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Sponsor%20me-via%20Github-red.svg></a></li><li><a class=padding href=https://www.paypal.me/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Donations-via%20Paypal-red.svg></a></li></ul></section><section id=footer><p>&copy;2013-2023 by <a href=https://niels.basjes.nl>Niels Basjes</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title='Edit this page' href=https://github.com/nielsbasjes/yauaa/tree/main/documentation/content/using/_index.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/>Yauaa: Yet Another UserAgent Analyzer</a> > Using the analyzer</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#using-the-analyzer>Using the analyzer</a></li><li><a href=#using-in-java-applications>Using in Java applications</a></li><li><a href=#custom-caching-implementation>Custom caching implementation</a></li><li><a href=#running-on-java-8>Running on Java 8</a><ul><li><a href=#normal-use>Normal use</a></li><li><a href=#really-only-java-8>Really ONLY Java 8</a></li></ul></li><li><a href=#logging-dependencies>Logging dependencies</a></li><li><a href=#regarding-the-log4j2-issues>Regarding the Log4J2 issues</a><ul><li><a href=#no-batteries-included>NO batteries included</a></li><li><a href=#minimal-logging>Minimal logging</a></li><li><a href=#bring-your-own-batteries>Bring your own batteries</a></li></ul></li><li><a href=#serialization>Serialization</a></li><li><a href=#avoid-using-it-as-a-static-member>Avoid using it as a static member</a></li><li><a href=#cache-size-setting>Cache size setting</a></li><li><a href=#reducing-the-memory-footprint>Reducing the memory footprint</a><ul><li><a href=#limiting-to-only-certain-fields>Limiting to only certain fields</a></li><li><a href=#sharing-the-config-between-instances-new-in-7240>Sharing the config between instances (new in 7.24.0)</a></li></ul></li><li><a href=#building-your-project-with--xlintall>Building your project with -Xlint:all</a></li><li><a href=#important-this-library-is-single-threaded->IMPORTANT: This library is single threaded !</a></li><li><a href=#eclipse-users>Eclipse users</a></li><li><a href=#scala-usage>Scala usage</a></li><li><a href=#snapshots>Snapshots</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Using the analyzer</h1><h2 id=using-the-analyzer>Using the analyzer</h2><p>To use this analyzer you can use it either directly in your Java based applications or use one of
the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, &mldr;) as described <a href=../udf/>here</a>.</p><h2 id=using-in-java-applications>Using in Java applications</h2><p>To use the library you must first add it as a dependency to your application.
The library has been published to <a href=https://central.sonatype.com/artifact/nl.basjes.parse.useragent/yauaa/7.26.0/jar>maven central</a> so that should work in almost any environment.</p><p>If you use a maven based project simply add this dependency to your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>nl.basjes.parse.useragent<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>yauaa<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>7.26.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>To actually use it in your application you need to create an instance of the <code>UserAgentAnalyzer</code>.</p><p>Please instantiate a new UserAgentAnalyzer as few times as possible because the initialization step for a full UserAgentAnalyzer (i.e. all fields) usually takes something in the range of 2-5 seconds and uses a few hundred MiB of memory to store all the analysis datastructures.</p><p>This analyzer can only do a single analysis at a time and to ensure correct working the main method is synchronized. If you have a high load you should simply create multiple instances and spread the load over those instances.
When running in a framework (like <a href=../udf/Apache-Flink.md>Apache Flink</a> or <a href=../udf/Apache-Beam.md>Apache Beam</a>) this is usually automatically managed by these frameworks. In other systems may choose something like a threadpool to do that.</p><p>Note that if you need multiple instances of the UserAgentAnalyzer then you MUST create a new Builder instance for each of those (or serialize an instance and deserialize it multiple times).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>hideMatcherLoadStats</span>()
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><p>Then for each useragent (or set of request headers) you call the <code>parse</code> method to give you the desired result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgent agent <span style=color:#f92672>=</span> uaa.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (String fieldName: agent.<span style=color:#a6e22e>getAvailableFieldNamesSorted</span>()) {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(fieldName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; = &#34;</span> <span style=color:#f92672>+</span> agent.<span style=color:#a6e22e>getValue</span>(fieldName));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that not all fields are available after every parse. So be prepared to receive a <code>null</code>, <code>Unknown</code> or another field specific default.</p><h2 id=custom-caching-implementation>Custom caching implementation</h2><p>Since version 6.7 you can specify a custom implementation for the cache by providing an instance of the factory interface <code>CacheInstantiator</code>.</p><p>Do note that Yauaa assumes the caching implementation to be threadsafe.
If you use a non-threadsafe implementation in a multithreaded context it will break.</p><p>The default caching implementation uses <a href=https://github.com/ben-manes/caffeine>Caffeine</a> (since version 6.8).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>return</span> Caffeine.<span style=color:#a6e22e>newBuilder</span>().<span style=color:#a6e22e>maximumSize</span>(cacheSize).<span style=color:#f92672>&lt;</span>String, ImmutableUserAgent<span style=color:#f92672>&gt;</span>build().<span style=color:#a6e22e>asMap</span>();
</span></span></code></pre></div><p>A custom implementation can be specified via the <code>Builder</code> using the <code>withCacheInstantiator(...)</code> method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCacheInstantiator</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> CacheInstantiator() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String, ImmutableUserAgent<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>instantiateCache</span>(<span style=color:#66d9ef>int</span> cacheSize) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MyMuchBetterCacheImplementation(cacheSize);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withClientHintCacheInstantiator</span>(
</span></span><span style=display:flex><span>        (ClientHintsCacheInstantiator<span style=color:#f92672>&lt;?&gt;</span>) size <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            Collections.<span style=color:#a6e22e>synchronizedMap</span>(<span style=color:#66d9ef>new</span> LRUMap<span style=color:#f92672>&lt;&gt;</span>(size)))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><h2 id=running-on-java-8>Running on Java 8</h2><h3 id=normal-use>Normal use</h3><p>Yauaa 7.x still allows running on Java 8, yet the default caching library needs Java 11.</p><p><strong>Since version 7.19.0 the selection of the caching implementation is automatically based upon the Java version used to run it.</strong> Running in Java 8 - Java 10 the <code>LRUMap</code> (caching implementation that is part of the Apache commons-collections library) is used, Java 11 and newer <code>Caffeine</code> is used.</p><p>If needed (and also for backwards compatibility and testing) you can still force it to use the <code>LRUMap</code> regardless of the Java version by doing something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>useJava8CompatibleCaching</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><h3 id=really-only-java-8>Really ONLY Java 8</h3><p>If you have a very strict requirement that no classes are in the project that are above JDK 8 then you should do 2 things:</p><ol><li><strong>Exclude the caffeine dependency</strong></li></ol><p><em>Maven pom.xml snippet</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>nl.basjes.parse.useragent<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>yauaa<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>7.26.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>com.github.ben-manes.caffeine<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>caffeine<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><em>Gradle snippet</em></p><pre tabindex=0><code>implementation(&#39;nl.basjes.parse.useragent:yauaa:7.26.0&#39;) {
    exclude group: &#39;com.github.ben-manes.caffeine&#39;, module: &#39;caffeine&#39;
}
</code></pre><ol start=2><li><strong>Make sure the used caching library is always the Java 8 compatible one.</strong></li></ol><ul><li>Either by only running on Java 8</li><li>Or by forcing the caching to always use the Java 8 with something like this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>useJava8CompatibleCaching</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><h2 id=logging-dependencies>Logging dependencies</h2><p>The Yauaa engine uses Log4j2 API as the logging framework.</p><p>To minimize the complexity of the dependency handling I have chosen to simply not include ANY logging framework and
expect the consuming system to provide what ever fits best. Even the required log4j-api 2.x dependency is configured as <code>provided</code> to avoid any needless version conflicts.</p><p>To use Yauaa you must provide the desired version of <code>log4j-api</code> and either an implementation or a bridge for Apache Log4j2 to route the logging to where you want it.</p><p>So it all depends on your exact context (i.e. which logging framework are you going to use) what
the best solution is for you to make all of this logging work as intended.</p><p>In case you are using Apache Log4j2 you should have these dependencies in addition to Yauaa in your project</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- The default logging implementation for Yauaa --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.logging.log4j<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>log4j-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>${log4j2.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><hr><h2 id=regarding-the-log4j2-issues>Regarding the Log4J2 issues</h2><p>The Yauaa analyzer uses the Log4J2 API to do the logging.</p><p>TL;DR:</p><ul><li><strong>The core of Yauaa is safe</strong> as it does not include any logging dependencies and expects the application to provide everything.</li><li><strong>In normal operations user input is not logged</strong>.</li><li>The <strong>Snowflake UDF is affected</strong> by these problems (due to shading the dependencies in).</li></ul><h3 id=no-batteries-included>NO batteries included</h3><p>By design the Yauaa library expects the application in which it is used to provide the actual logging dependencies and configuration.
If you do not provide the needed logging classes it will simply fail at startup.</p><p>So by design the Yauaa library expects all of these frameworks to be provided (and configured) and does not include any of them or any configuration for them.</p><p>This is true for most of the released artifacts (including the base library) except for the Snowflake UDF which does include almost all dependencies.
So the Snowflake UDF IS affected by this issue and all users are recommended to update.</p><h3 id=minimal-logging>Minimal logging</h3><p>Note that Yauaa does not log any user input and/or analysis results from user input during normal operation.
Only during development and during unit tests the Useragents are logged.</p><p>This is because it was designed to run in very large scale batch and streaming situations (very large as in &ldquo;Let&rsquo;s analyze these 10^10 records&rdquo;).</p><h3 id=bring-your-own-batteries>Bring your own batteries</h3><p>To assist in running Yauaa without the logj4-core jar an example was created that only uses <a href=https://github.com/nielsbasjes/yauaa/tree/main/analyzer/src/it/Examples/java-slf4j>SLF4J 1.x</a> and and example that only uses <a href=https://github.com/nielsbasjes/yauaa/tree/main/analyzer/src/it/Examples/java-slf4j2>SLF4J 2.x</a>.</p><h2 id=serialization>Serialization</h2><p>If your application needs to serialize the instance of the UserAgentAnalyzer then both the standard Java serialization and
Kryo are supported. Note that with Kryo 5.x you need to register all classes and configure Kryo correctly.</p><p>To facilitate doing this correctly the static method <code>configureKryo</code> was created.
So in general your code should look something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Kryo kryo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Kryo();
</span></span><span style=display:flex><span>UserAgentAnalyzer.<span style=color:#a6e22e>configureKryo</span>(kryo);
</span></span></code></pre></div><p>Note that both the serializing and the deserializing instance of Kryo must be configured in the same way.</p><h2 id=avoid-using-it-as-a-static-member>Avoid using it as a static member</h2><p>If you make the UserAgentAnalyzer a static member of a class then cleaning it up after use may be a problem.
One case where this happens is in the context of something like Tomcat where a webapp is loaded and then unloaded.
If the analyzer is a static member of your servlet then this unloading may retain a lot of the memory used for the internal
data structures.</p><h2 id=cache-size-setting>Cache size setting</h2><p>I recommend you leave the cache to a size that is roughly the unique number of useragents your site finds
in a limited timespan. Something like 15/30/60 minutes usually gives you a fine cache size.
On a very busy website I see ~50K-60K distinct useragents per day and ~10K per hour.
So in my opinion a cache size of 5K-10K elements is a good choice.</p><h2 id=reducing-the-memory-footprint>Reducing the memory footprint</h2><h3 id=limiting-to-only-certain-fields>Limiting to only certain fields</h3><p>In some scenarios you only want a specific field and all others are unwanted.
This can be achieved by creating the analyzer in Java like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(<span style=color:#e6db74>&#34;DeviceClass&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(<span style=color:#e6db74>&#34;AgentNameVersionMajor&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><p>One important effect is that this speeds up the system because it will kick any rules that do not help in getting the desired fields.
The above example showed an approximate 40% speed increase (i.e. times dropped from ~1ms to ~0.6ms).</p><p>Do note that some fields need other fields as input (i.e. intermediate result). For example the <code>DeviceBrand</code> also needs the <code>AgentInformationEmail</code> and <code>AgentInformationUrl</code> because in some cases the actual brand is derived from for example the domainname that usually is present in those. So if you only ask for the <code>DomainBrand</code> you will get those fields also.</p><p>In the nl.basjes.parse.useragent.UserAgent many (not all!!) of the provided variables are provided as a constant String.
You can choose to use these and avoid subtle typos in the requested attribute names.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(DEVICE_CLASS)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(AGENT_NAME_VERSION_MAJOR)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><h3 id=sharing-the-config-between-instances-new-in-7240>Sharing the config between instances (new in 7.24.0)</h3><p>In some situations you may want to have multiple instances to handle the load within in a single JVM.
In those cases you&rsquo;ll also want the configuration of all instances to be identical.</p><p>If you are in exactly that scenario you can create a duplicate instance with the exact same configuration and save a few MiB of memory. The currently estimated savings is at about 20-30MiB for each extra instance (depending on the configuration).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer extraUaa <span style=color:#f92672>=</span> uaa.<span style=color:#a6e22e>cloneWithSharedAnalyzerConfig</span>(<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>);
</span></span></code></pre></div><h2 id=building-your-project-with--xlintall>Building your project with -Xlint:all</h2><p>If you are trying to get rid of all possible problems in your application and set the compiler flag -Xlint:all you will see warnings relating to the Kryo serialization system.</p><pre><code>[WARNING] COMPILATION WARNING :
[INFO] -------------------------------------------------------------
[WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer': class file for com.esotericsoftware.kryo.DefaultSerializer not found
[WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer'
[INFO] 2 warnings
</code></pre><p>The Yauaa analyzer has been prepared in such a way that it can be serialized using both the standard Java serialization and the Kryo serialization library.
The Kryo library has been configured as a &ldquo;provided&rdquo; dependency because many do not need it, and (to avoid version conflicts) those who do need it have this dependency already.</p><p>If your project does not use Kryo and you have this warning then there are several ways to work around this:</p><ol><li>Disable the Xlint check that triggers this warning. Apparently this is the &ldquo;classfile&rdquo; so try to use <strong>-Xlint:all,-classfile</strong> instead.</li><li>Add the otherwise needless Kryo library as a &ldquo;provided&rdquo; dependency to your project.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.esotericsoftware<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>kryo<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>5.4.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>provided<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=important-this-library-is-single-threaded->IMPORTANT: This library is single threaded !</h2><p>Because the internal analyzer code is not reentrant the main method has been synchronized on the instance.
So from the perspective of you the application developer this library is thread safe.</p><p>If you are in a multi threaded situation you should create a separate instance per thread or accept the speed limitation of the shared synchronized instance.</p><p>Note that you should really instantiate it only once per thread (and use a ThreadPool or something similar) because starting a new instance takes several seconds.</p><h2 id=eclipse-users>Eclipse users</h2><p>Be aware of there is a bug in Eclipse which will show you errors in perfectly valid Java code:
<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=527475">https://bugs.eclipse.org/bugs/show_bug.cgi?id=527475</a>
The errors you see are related to the inheritance model used by the Builders in this project and the fact that Eclipse does not interpret it correctly.</p><h2 id=scala-usage>Scala usage</h2><p>When using this library from a Scala application the way the Builders have been constructed turns out to be very unfriendly to use.</p><p>Starting with Yauaa version 5.14 the rewritten builders (contributed by <a href=https://github.com/tegonal>Robert Stoll</a>)
will become available which will make it a lot easier for Scala users to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> uaa <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>UserAgentAnalyzer</span><span style=color:#f92672>.</span>newBuilder
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>withCache<span style=color:#f92672>(</span><span style=color:#ae81ff>10000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>hideMatcherLoadStats
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>withField<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DeviceClass&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>build
</span></span></code></pre></div><h2 id=snapshots>Snapshots</h2><p>Occasionally I publish a snapshot version.
If you want to use such a version then the repository can be configured in your maven with something like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;repositories&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;repository&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;id&gt;</span>sonatype-oss-snapshots<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>Sonatype OSS Snapshots<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/snapshots<span style=color:#f92672>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;releases&gt;&lt;enabled&gt;</span>false<span style=color:#f92672>&lt;/enabled&gt;&lt;/releases&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;snapshots&gt;&lt;enabled&gt;</span>true<span style=color:#f92672>&lt;/enabled&gt;&lt;/snapshots&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/repository&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/repositories&gt;</span>
</span></span></code></pre></div><footer class=footline></footer></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1712046033></script><script src=/js/perfect-scrollbar.min.js?1712046033></script><script src=/js/perfect-scrollbar.jquery.min.js?1712046033></script><script src=/js/jquery.sticky.js?1712046033></script><script src=/js/featherlight.min.js?1712046033></script><script src=/js/highlight.pack.js?1712046033></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1712046033></script><script src=/js/learn.js?1712046033></script><script src=/js/hugo-learn.js?1712046033></script></body></html>