<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.136.3"><meta name=generator content="Relearn 7.0.1"><meta name=description content="Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.
Using in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment."><meta name=author content="Niels Basjes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using the analyzer  |  Yauaa - Yet Another UserAgent Analyzer"><meta name=twitter:description content="Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.
Using in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment."><meta property="og:url" content="/using/index.html"><meta property="og:site_name" content="Yauaa - Yet Another UserAgent Analyzer"><meta property="og:title" content="Using the analyzer  |  Yauaa - Yet Another UserAgent Analyzer"><meta property="og:description" content="Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.
Using in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Using the analyzer  |  Yauaa - Yet Another UserAgent Analyzer"><meta itemprop=description content="Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.
Using in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment."><meta itemprop=wordCount content="1963"><title>Using the analyzer | Yauaa - Yet Another UserAgent Analyzer</title>
<link href=/using/index.xml rel=alternate type=application/rss+xml title="Using the analyzer  |  Yauaa - Yet Another UserAgent Analyzer"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#2d89ef"><meta name=msapplication-TileImage content="/favicon/mstile-144x144.png"><meta name=theme-color content="#ffffff"><link href=/css/fontawesome-all.min.css?1742928032 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1742928032 rel=stylesheet></noscript><link href=/css/nucleus.css?1742928032 rel=stylesheet><link href=/css/auto-complete.css?1742928032 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1742928032 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1742928032 rel=stylesheet><link href=/css/fonts.css?1742928032 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1742928032 rel=stylesheet></noscript><link href=/css/theme.css?1742928032 rel=stylesheet><link href=/css/theme-yauaa.css?1742928032 rel=stylesheet id=R-variant-style><link href=/css/chroma-relearn-light.css?1742928032 rel=stylesheet id=R-variant-chroma-style><link href=/css/print.css?1742928032 rel=stylesheet media=print><script src=/js/variant.js?1742928032></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="..",window.relearn.absBaseUri="",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.variants&&variants.init(["yauaa"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script type=text/javascript>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="https://wa.basjes.nl/",_paq.push(["setTrackerUrl",t+"wa.php"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src=t+"wa.js",s.parentNode.insertBefore(e,s)}()</script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=/using/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#using-the-analyzer>Using the analyzer</a></li><li><a href=#using-in-java-applications>Using in Java applications</a></li><li><a href=#custom-caching-implementation>Custom caching implementation</a></li><li><a href=#running-on-java-8>Running on Java 8</a><ul><li><a href=#normal-use>Normal use</a></li><li><a href=#really-only-java-8>Really ONLY Java 8</a></li></ul></li><li><a href=#logging-dependencies>Logging dependencies</a></li><li><a href=#regarding-the-log4j2-issues>Regarding the Log4J2 issues</a><ul><li><a href=#no-batteries-included>NO batteries included</a></li><li><a href=#minimal-logging>Minimal logging</a></li><li><a href=#bring-your-own-batteries>Bring your own batteries</a></li></ul></li><li><a href=#serialization>Serialization</a></li><li><a href=#avoid-using-it-as-a-static-member>Avoid using it as a static member</a></li><li><a href=#cache-size-setting>Cache size setting</a></li><li><a href=#reducing-the-memory-footprint>Reducing the memory footprint</a><ul><li><a href=#limiting-to-only-certain-fields>Limiting to only certain fields</a></li><li><a href=#sharing-the-config-between-instances-new-in-7240>Sharing the config between instances (new in 7.24.0)</a></li></ul></li><li><a href=#building-your-project-with--xlintall>Building your project with -Xlint:all</a></li><li><a href=#important-this-library-is-single-threaded->IMPORTANT: This library is single threaded !</a></li><li><a href=#eclipse-users>Eclipse users</a></li><li><a href=#scala-usage>Scala usage</a></li><li><a href=#snapshots>Snapshots</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Yauaa</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Using Yauaa</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-edit" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=https://github.com/nielsbasjes/yauaa/tree/main/documentation/content/using/_index.md target=_blank title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable using" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=using-the-analyzer>Using the analyzer</h1><h2 id=using-the-analyzer>Using the analyzer</h2><p>To use this analyzer you can use it either directly in your Java based applications or use one of
the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, &mldr;) as described <a href=/udf/index.html>here</a>.</p><h2 id=using-in-java-applications>Using in Java applications</h2><p>To use the library you must first add it as a dependency to your application.
The library has been published to <a href=https://central.sonatype.com/artifact/nl.basjes.parse.useragent/yauaa/7.30.0/jar rel=external target=_blank>maven central</a> so that should work in almost any environment.</p><p>If you use a maven based project simply add this dependency to your project.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>nl.basjes.parse.useragent<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>yauaa<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>7.30.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span></span></span></code></pre></div><p>To actually use it in your application you need to create an instance of the <code>UserAgentAnalyzer</code>.</p><p>Please instantiate a new UserAgentAnalyzer as few times as possible because the initialization step for a full UserAgentAnalyzer (i.e. all fields) usually takes something in the range of 2-5 seconds and uses a few hundred MiB of memory to store all the analysis datastructures.</p><p>This analyzer can only do a single analysis at a time and to ensure correct working the main method is synchronized. If you have a high load you should simply create multiple instances and spread the load over those instances.
When running in a framework (like <a href=/udf/apache-flink/index.html>Apache Flink</a> or <a href=/udf/apache-beam/index.html>Apache Beam</a>) this is usually automatically managed by these frameworks. In other systems may choose something like a threadpool to do that.</p><p>Note that if you need multiple instances of the UserAgentAnalyzer then you MUST create a new Builder instance for each of those (or serialize an instance and deserialize it multiple times).</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>hideMatcherLoadStats</span>()
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><p>Then for each useragent (or set of request headers) you call the <code>parse</code> method to give you the desired result:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgent agent <span style=color:#f92672>=</span> uaa.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#34;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (String fieldName: agent.<span style=color:#a6e22e>getAvailableFieldNamesSorted</span>()) {
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(fieldName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; = &#34;</span> <span style=color:#f92672>+</span> agent.<span style=color:#a6e22e>getValue</span>(fieldName));
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Note that not all fields are available after every parse. So be prepared to receive a <code>null</code>, <code>Unknown</code> or another field specific default.</p><h2 id=custom-caching-implementation>Custom caching implementation</h2><p>Since version 6.7 you can specify a custom implementation for the cache by providing an instance of the factory interface <code>CacheInstantiator</code>.</p><p>Do note that Yauaa assumes the caching implementation to be threadsafe.
If you use a non-threadsafe implementation in a multithreaded context it will break.</p><p>The default caching implementation uses <a href=https://github.com/ben-manes/caffeine rel=external target=_blank>Caffeine</a> (since version 6.8).</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>return</span> Caffeine.<span style=color:#a6e22e>newBuilder</span>().<span style=color:#a6e22e>maximumSize</span>(cacheSize).<span style=color:#f92672>&lt;</span>String, ImmutableUserAgent<span style=color:#f92672>&gt;</span>build().<span style=color:#a6e22e>asMap</span>();</span></span></code></pre></div><p>A custom implementation can be specified via the <code>Builder</code> using the <code>withCacheInstantiator(...)</code> method:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCacheInstantiator</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> CacheInstantiator() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>String, ImmutableUserAgent<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>instantiateCache</span>(<span style=color:#66d9ef>int</span> cacheSize) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MyMuchBetterCacheImplementation(cacheSize);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withClientHintCacheInstantiator</span>(
</span></span><span style=display:flex><span>        (ClientHintsCacheInstantiator<span style=color:#f92672>&lt;?&gt;</span>) size <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            Collections.<span style=color:#a6e22e>synchronizedMap</span>(<span style=color:#66d9ef>new</span> LRUMap<span style=color:#f92672>&lt;&gt;</span>(size)))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><h2 id=running-on-java-8>Running on Java 8</h2><h3 id=normal-use>Normal use</h3><p>Yauaa 7.x still allows running on Java 8, yet the default caching library needs Java 11.</p><p><strong>Since version 7.19.0 the selection of the caching implementation is automatically based upon the Java version used to run it.</strong> Running in Java 8 - Java 10 the <code>LRUMap</code> (caching implementation that is part of the Apache commons-collections library) is used, Java 11 and newer <code>Caffeine</code> is used.</p><p>If needed (and also for backwards compatibility and testing) you can still force it to use the <code>LRUMap</code> regardless of the Java version by doing something like this:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>useJava8CompatibleCaching</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><h3 id=really-only-java-8>Really ONLY Java 8</h3><p>If you have a very strict requirement that no classes are in the project that are above JDK 8 then you should do 2 things:</p><ol><li><strong>Exclude the caffeine dependency</strong></li></ol><p><em>Maven pom.xml snippet</em></p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>nl.basjes.parse.useragent<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>yauaa<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>7.30.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;exclusion&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>com.github.ben-manes.caffeine<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>caffeine<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependencies&gt;</span></span></span></code></pre></div><p><em>Gradle snippet</em></p><div class="highlight wrap-code"><pre tabindex=0><code>implementation(&#39;nl.basjes.parse.useragent:yauaa:7.30.0&#39;) {
    exclude group: &#39;com.github.ben-manes.caffeine&#39;, module: &#39;caffeine&#39;
}</code></pre></div><ol start=2><li><strong>Make sure the used caching library is always the Java 8 compatible one.</strong></li></ol><ul><li>Either by only running on Java 8</li><li>Or by forcing the caching to always use the Java 8 with something like this:</li></ul><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>useJava8CompatibleCaching</span>()
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>withCache</span>(10000)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><h2 id=logging-dependencies>Logging dependencies</h2><p>The Yauaa engine uses Log4j2 API as the logging framework.</p><p>To minimize the complexity of the dependency handling I have chosen to simply not include ANY logging framework and
expect the consuming system to provide what ever fits best. Even the required log4j-api 2.x dependency is configured as <code>provided</code> to avoid any needless version conflicts.</p><p>To use Yauaa you must provide the desired version of <code>log4j-api</code> and either an implementation or a bridge for Apache Log4j2 to route the logging to where you want it.</p><p>So it all depends on your exact context (i.e. which logging framework are you going to use) what
the best solution is for you to make all of this logging work as intended.</p><p>In case you are using Apache Log4j2 you should have these dependencies in addition to Yauaa in your project</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- The default logging implementation for Yauaa --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.apache.logging.log4j<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>log4j-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;version&gt;</span>${log4j2.version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span></span></span></code></pre></div><hr><h2 id=regarding-the-log4j2-issues>Regarding the Log4J2 issues</h2><p>The Yauaa analyzer uses the Log4J2 API to do the logging.</p><p>TL;DR:</p><ul><li><strong>The core of Yauaa is safe</strong> as it does not include any logging dependencies and expects the application to provide everything.</li><li><strong>In normal operations user input is not logged</strong>.</li><li>The <strong>Snowflake UDF is affected</strong> by these problems (due to shading the dependencies in).</li></ul><h3 id=no-batteries-included>NO batteries included</h3><p>By design the Yauaa library expects the application in which it is used to provide the actual logging dependencies and configuration.
If you do not provide the needed logging classes it will simply fail at startup.</p><p>So by design the Yauaa library expects all of these frameworks to be provided (and configured) and does not include any of them or any configuration for them.</p><p>This is true for most of the released artifacts (including the base library) except for the Snowflake UDF which does include almost all dependencies.
So the Snowflake UDF IS affected by this issue and all users are recommended to update.</p><h3 id=minimal-logging>Minimal logging</h3><p>Note that Yauaa does not log any user input and/or analysis results from user input during normal operation.
Only during development and during unit tests the Useragents are logged.</p><p>This is because it was designed to run in very large scale batch and streaming situations (very large as in &ldquo;Let&rsquo;s analyze these 10^10 records&rdquo;).</p><h3 id=bring-your-own-batteries>Bring your own batteries</h3><p>To assist in running Yauaa without the logj4-core jar an example was created that only uses <a href=https://github.com/nielsbasjes/yauaa/tree/main/analyzer/src/it/Examples/java-slf4j rel=external target=_blank>SLF4J 1.x</a> and and example that only uses <a href=https://github.com/nielsbasjes/yauaa/tree/main/analyzer/src/it/Examples/java-slf4j2 rel=external target=_blank>SLF4J 2.x</a>.</p><h2 id=serialization>Serialization</h2><p>If your application needs to serialize the instance of the UserAgentAnalyzer then both the standard Java serialization and
Kryo are supported. Note that with Kryo 5.x you need to register all classes and configure Kryo correctly.</p><p>To facilitate doing this correctly the static method <code>configureKryo</code> was created.
So in general your code should look something like this:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Kryo kryo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Kryo();
</span></span><span style=display:flex><span>UserAgentAnalyzer.<span style=color:#a6e22e>configureKryo</span>(kryo);</span></span></code></pre></div><p>Note that both the serializing and the deserializing instance of Kryo must be configured in the same way.</p><h2 id=avoid-using-it-as-a-static-member>Avoid using it as a static member</h2><p>If you make the UserAgentAnalyzer a static member of a class then cleaning it up after use may be a problem.
One case where this happens is in the context of something like Tomcat where a webapp is loaded and then unloaded.
If the analyzer is a static member of your servlet then this unloading may retain a lot of the memory used for the internal
data structures.</p><h2 id=cache-size-setting>Cache size setting</h2><p>I recommend you leave the cache to a size that is roughly the unique number of useragents your site finds
in a limited timespan. Something like 15/30/60 minutes usually gives you a fine cache size.
On a very busy website I see ~50K-60K distinct useragents per day and ~10K per hour.
So in my opinion a cache size of 5K-10K elements is a good choice.</p><h2 id=reducing-the-memory-footprint>Reducing the memory footprint</h2><h3 id=limiting-to-only-certain-fields>Limiting to only certain fields</h3><p>In some scenarios you only want a specific field and all others are unwanted.
This can be achieved by creating the analyzer in Java like this:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(<span style=color:#e6db74>&#34;DeviceClass&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(<span style=color:#e6db74>&#34;AgentNameVersionMajor&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><p>One important effect is that this speeds up the system because it will kick any rules that do not help in getting the desired fields.
The above example showed an approximate 40% speed increase (i.e. times dropped from ~1ms to ~0.6ms).</p><p>Do note that some fields need other fields as input (i.e. intermediate result). For example the <code>DeviceBrand</code> also needs the <code>AgentInformationEmail</code> and <code>AgentInformationUrl</code> because in some cases the actual brand is derived from for example the domainname that usually is present in those. So if you only ask for the <code>DomainBrand</code> you will get those fields also.</p><p>In the nl.basjes.parse.useragent.UserAgent many (not all!!) of the provided variables are provided as a constant String.
You can choose to use these and avoid subtle typos in the requested attribute names.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer uaa <span style=color:#f92672>=</span> UserAgentAnalyzer
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(DEVICE_CLASS)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>withField</span>(AGENT_NAME_VERSION_MAJOR)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>();</span></span></code></pre></div><h3 id=sharing-the-config-between-instances-new-in-7240>Sharing the config between instances (new in 7.24.0)</h3><p>In some situations you may want to have multiple instances to handle the load within in a single JVM.
In those cases you&rsquo;ll also want the configuration of all instances to be identical.</p><p>If you are in exactly that scenario you can create a duplicate instance with the exact same configuration and save a few MiB of memory. The currently estimated savings is at about 20-30MiB for each extra instance (depending on the configuration).</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>UserAgentAnalyzer extraUaa <span style=color:#f92672>=</span> uaa.<span style=color:#a6e22e>cloneWithSharedAnalyzerConfig</span>(<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>);</span></span></code></pre></div><h2 id=building-your-project-with--xlintall>Building your project with -Xlint:all</h2><p>If you are trying to get rid of all possible problems in your application and set the compiler flag -Xlint:all you will see warnings relating to the Kryo serialization system.</p><pre><code>[WARNING] COMPILATION WARNING :
[INFO] -------------------------------------------------------------
[WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer': class file for com.esotericsoftware.kryo.DefaultSerializer not found
[WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer'
[INFO] 2 warnings
</code></pre><p>The Yauaa analyzer has been prepared in such a way that it can be serialized using both the standard Java serialization and the Kryo serialization library.
The Kryo library has been configured as a &ldquo;provided&rdquo; dependency because many do not need it, and (to avoid version conflicts) those who do need it have this dependency already.</p><p>If your project does not use Kryo and you have this warning then there are several ways to work around this:</p><ol><li>Disable the Xlint check that triggers this warning. Apparently this is the &ldquo;classfile&rdquo; so try to use <strong>-Xlint:all,-classfile</strong> instead.</li><li>Add the otherwise needless Kryo library as a &ldquo;provided&rdquo; dependency to your project.</li></ol><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.esotericsoftware<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>kryo<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>5.4.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>provided<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span></span></span></code></pre></div><h2 id=important-this-library-is-single-threaded->IMPORTANT: This library is single threaded !</h2><p>Because the internal analyzer code is not reentrant the main method has been synchronized on the instance.
So from the perspective of you the application developer this library is thread safe.</p><p>If you are in a multi threaded situation you should create a separate instance per thread or accept the speed limitation of the shared synchronized instance.</p><p>Note that you should really instantiate it only once per thread (and use a ThreadPool or something similar) because starting a new instance takes several seconds.</p><h2 id=eclipse-users>Eclipse users</h2><p>Be aware of there is a bug in Eclipse which will show you errors in perfectly valid Java code:
<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=527475" rel=external target=_blank>https://bugs.eclipse.org/bugs/show_bug.cgi?id=527475</a>
The errors you see are related to the inheritance model used by the Builders in this project and the fact that Eclipse does not interpret it correctly.</p><h2 id=scala-usage>Scala usage</h2><p>When using this library from a Scala application the way the Builders have been constructed turns out to be very unfriendly to use.</p><p>Starting with Yauaa version 5.14 the rewritten builders (contributed by <a href=https://github.com/tegonal rel=external target=_blank>Robert Stoll</a>)
will become available which will make it a lot easier for Scala users to use:</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> uaa <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>UserAgentAnalyzer</span><span style=color:#f92672>.</span>newBuilder
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>withCache<span style=color:#f92672>(</span><span style=color:#ae81ff>10000</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>hideMatcherLoadStats
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>withField<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DeviceClass&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>build</span></span></code></pre></div><h2 id=snapshots>Snapshots</h2><p>Occasionally I publish a snapshot version.
If you want to use such a version then the repository can be configured in your maven with something like this</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;repositories&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;repository&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;id&gt;</span>sonatype-oss-snapshots<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>Sonatype OSS Snapshots<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;url&gt;</span>https://oss.sonatype.org/content/repositories/snapshots<span style=color:#f92672>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;releases&gt;&lt;enabled&gt;</span>false<span style=color:#f92672>&lt;/enabled&gt;&lt;/releases&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;snapshots&gt;&lt;enabled&gt;</span>true<span style=color:#f92672>&lt;/enabled&gt;&lt;/snapshots&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/repository&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/repositories&gt;</span></span></span></code></pre></div><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a id=logo href=/><p class=logo-bar>Yauaa</p></a></div><script>window.index_js_url="/searchindex.js?1742928032"</script><search><form action=/search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search><script>var contentLangs=["en"]</script><script src=/js/auto-complete.js?1742928032 defer></script><script src=/js/lunr/lunr.min.js?1742928032 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1742928032 defer></script><script src=/js/lunr/lunr.multi.min.js?1742928032 defer></script><script src=/js/lunr/lunr.en.min.js?1742928032 defer></script><script src=/js/search.js?1742928032 defer></script></div><div id=R-homelinks class="default-animation homelinks"><ul><li><a class=padding href=/index.html><i class='fas fa-home'></i> Yauaa</a></li></ul><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/expect/index.html><a class=padding href=/expect/index.html>What to expect</a><ul id=R-subsections-0cc162f4d70118f5b01edda6c8732e77 class=collapsible-menu></ul></li><li class="active parent" data-nav-id=/using/index.html><a class=padding href=/using/index.html>Using Yauaa</a><ul id=R-subsections-790b0ab426eab6dc92cf29e810f15854 class=collapsible-menu><li data-nav-id=/using/clienthints/index.html><a class=padding href=/using/clienthints/index.html>User-Agent Client Hints</a></li><li data-nav-id=/using/memoryusage/index.html><a class=padding href=/using/memoryusage/index.html>Memory usage</a></li><li data-nav-id=/using/webservlet/index.html><a class=padding href=/using/webservlet/index.html>Webservlet</a></li><li data-nav-id=/using/kubernetes/index.html><a class=padding href=/using/kubernetes/index.html>Kubernetes</a></li><li data-nav-id=/using/license/index.html><a class=padding href=/using/license/index.html>Licence</a></li></ul></li><li data-nav-id=/udf/index.html><a class=padding href=/udf/index.html>User Defined Functions</a><ul id=R-subsections-b853d96ac1607b20a47f0b01f30f143a class=collapsible-menu></ul></li><li data-nav-id=/developer/index.html><a class=padding href=/developer/index.html>Development</a><ul id=R-subsections-f87f59ebc94679f99e2683cdd4170483 class=collapsible-menu></ul></li><li data-nav-id=/other/index.html><a class=padding href=/other/index.html>Other</a><ul id=R-subsections-dd17f32865650128ca32bc9ce5ee4fdf class=collapsible-menu></ul></li></ul></div><div id=R-shortcuts><div class="nav-title padding">More</div><ul class=space><li><a class=padding href=https://github.com/nielsbasjes/yauaa><i class='fab fa-git-square'></i> Git repo</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/discussions><i class='fa fa-comment-alt'></i> Discussions</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/blob/main/CHANGELOG.md><i class='fa fa-file-alt'></i> Changelog</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/issues><i class='fa fa-bug'></i> Issue tracker</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/actions><img alt="Github actions Build status" src="https://img.shields.io/github/actions/workflow/status/nielsbasjes/yauaa/build.yml?branch=main"></a></li><li><a class=padding href=https://app.codecov.io/gh/nielsbasjes/yauaa><img alt="Coverage Status" src=https://img.shields.io/codecov/c/github/nielsbasjes/yauaa></a></li><li><a class=padding href=https://www.apache.org/licenses/LICENSE-2.0.html><img alt=License src=https://img.shields.io/:license-apache-blue.svg></a></li><li><a class=padding href=https://central.sonatype.com/namespace/nl.basjes.parse.useragent><img alt="Maven Central" src=https://img.shields.io/maven-central/v/nl.basjes.parse.useragent/yauaa-parent.svg></a></li><li><a class=padding href=https://github.com/jvm-repo-rebuild/reproducible-central#nl.basjes.parse.useragent:yauaa><img alt="Reproducible Builds" src="https://img.shields.io/badge/Reproducible_Builds-ok-success?labelColor=1e5b96"></a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/stargazers><img alt="GitHub stars" src="https://img.shields.io/github/stars/nielsbasjes/yauaa?label=GitHub%20stars"></a></li><li><a class=padding href=https://hub.docker.com/r/nielsbasjes/yauaa><img alt="Docker Hub" src=https://img.shields.io/docker/pulls/nielsbasjes/yauaa></a></li><li><a class=padding href=https://github.com/sponsors/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Sponsor%20me-via%20Github-red.svg></a></li><li><a class=padding href=https://www.paypal.me/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Donations-via%20Paypal-red.svg></a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Language</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"><option id=R-select-language-en value=#R-select-language-en data-url=/using/index.html lang=en-us selected></option></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-yauaa value=yauaa selected>Yauaa</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><p>&copy;2013-2025 by <a href=https://niels.basjes.nl>Niels Basjes</a></p></div></div></div></aside><script src=/js/clipboard.min.js?1742928032 defer></script><script src=/js/perfect-scrollbar.min.js?1742928032 defer></script><script src=/js/theme.js?1742928032 defer></script></body></html>