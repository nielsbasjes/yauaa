<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.136.3"><meta name=generator content="Relearn 7.0.1"><meta name=description content="Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:
Although there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.
The reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature."><meta name=author content="Niels Basjes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Base Design  |  Yauaa - Yet Another UserAgent Analyzer"><meta name=twitter:description content="Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:
Although there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.
The reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature."><meta property="og:url" content="/developer/basedesign/index.html"><meta property="og:site_name" content="Yauaa - Yet Another UserAgent Analyzer"><meta property="og:title" content="Base Design  |  Yauaa - Yet Another UserAgent Analyzer"><meta property="og:description" content="Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:
Although there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.
The reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Development"><meta itemprop=name content="Base Design  |  Yauaa - Yet Another UserAgent Analyzer"><meta itemprop=description content="Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:
Although there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.
The reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature."><meta itemprop=wordCount content="679"><title>Base Design | Yauaa - Yet Another UserAgent Analyzer</title><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/manifest.json><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#2d89ef"><meta name=msapplication-TileImage content="/favicon/mstile-144x144.png"><meta name=theme-color content="#ffffff"><link href=/css/fontawesome-all.min.css?1757311815 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fontawesome-all.min.css?1757311815 rel=stylesheet></noscript><link href=/css/nucleus.css?1757311815 rel=stylesheet><link href=/css/auto-complete.css?1757311815 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/auto-complete.css?1757311815 rel=stylesheet></noscript><link href=/css/perfect-scrollbar.min.css?1757311815 rel=stylesheet><link href=/css/fonts.css?1757311815 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/css/fonts.css?1757311815 rel=stylesheet></noscript><link href=/css/theme.css?1757311815 rel=stylesheet><link href=/css/theme-yauaa.css?1757311815 rel=stylesheet id=R-variant-style><link href=/css/chroma-relearn-light.css?1757311815 rel=stylesheet id=R-variant-chroma-style><link href=/css/print.css?1757311815 rel=stylesheet media=print><script src=/js/variant.js?1757311815></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.variants&&variants.init(["yauaa"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script type=text/javascript>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="https://wa.basjes.nl/",_paq.push(["setTrackerUrl",t+"wa.php"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src=t+"wa.js",s.parentNode.insertBefore(e,s)}()</script></head><body class="mobile-support html disableInlineCopyToClipboard" data-url=/developer/basedesign/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#parsing-useragents>Parsing Useragents</a></li><li><a href=#how-many-other-analyzers-work>How many other analyzers work</a></li><li><a href=#core-design-idea>Core design idea</a></li><li><a href=#high-level-implementation-overview>High level implementation overview</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/index.html><span itemprop=name>Yauaa</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/developer/index.html><span itemprop=name>Development</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Base Design</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-edit" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=https://github.com/nielsbasjes/yauaa/tree/main/documentation/content/developer/BaseDesign.md target=_blank title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable developer" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=base-design>Base Design</h1><h2 id=parsing-useragents>Parsing Useragents</h2><p>Parsing useragents is considered by many to be a ridiculously hard problem.
The main problems are:</p><ul><li>Although there seems to be a specification, many do not follow it.</li><li>Useragents LIE that they are their competing predecessor with an extra flag.</li></ul><p>The pattern the &rsquo;normal&rsquo; browser builders are following is that they all LIE about the ancestor they are trying to improve upon.</p><p>The reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature.</p><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>useragent</span>.<span style=color:#a6e22e>contains</span>(<span style=color:#e6db74>&#34;Chrome&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use the chrome feature we need.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div><p>Some may improve on this an actually check the (major) version that follows.</p><p>A good example of this is the Edge browser:</p><div class="highlight wrap-code"><pre tabindex=0><code>Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36 Edge/12.10136</code></pre></div><p>It says it:</p><ul><li>is Mozilla/5.0</li><li>uses AppleWebKit/537.36</li><li>for &ldquo;compatibility&rdquo; the AppleWebKit lie about being &ldquo;KHTML&rdquo; and that it is similar to &ldquo;Gecko&rdquo; are also copied</li><li>is Chrome 42</li><li>is Safari 537</li><li>is Edge 12</li></ul><p>So any website looking for the word it triggers upon will find it and enable the right features.</p><p>In 2014 an RFC for HTTP was released (<a href=https://tools.ietf.org/html/rfc7231#section-5.5.3 rel=external target=_blank>RFC 7231 section 5.5.3</a>) which now explicitly states:</p><pre><code>... implementations are encouraged not to use the product
tokens of other implementations in order to declare compatibility
with them, as this circumvents the purpose of the field.
</code></pre><p>&mldr; encouraged &mldr;</p><h2 id=how-many-other-analyzers-work>How many other analyzers work</h2><p>When looking at most implementations of analysing the useragents I see that most implementations are based around lists of regular expressions.
These are (in the systems I have seen) executed in a specific order to find the first one that matches.</p><p>In this solution direction the order in which things occur determines if the patterns match or not.</p><p>Regular expressions are notoriously hard to write and debug and (unless you make them really complex) the order in which parts of the pattern occur is fixed.</p><h2 id=core-design-idea>Core design idea</h2><p>I wanted to see if a completely different approach would work: Can we actually parse these things into a tree and work from there.</p><p>The parser (ANTLR4 based) will be able to parse a lot of the agents but not all.
Tests have shown that it will parse >99% of all useragents on a large website which is more than 99.99% of the traffic.</p><p>Now the ones that it is not able to parse are the ones that have been set manually to an invalid value.
So if that happens we assume you are a hacker.
In all other cases we have matchers that are triggered if a specific value is found by the parser.
Such a matcher then tells this class is has found a match for a certain attribute with a certain confidence level (0-10000000).
In the end the matcher that has found a match with the highest confidence for a value &lsquo;wins&rsquo;.</p><h2 id=high-level-implementation-overview>High level implementation overview</h2><p>The main concept of this useragent parser is that we have two things:</p><ol><li>A Parser (ANTLR4) that converts the useragent into a nice tree through which we can walk along.</li><li>A collection of matchers.</li></ol><ul><li>A matcher triggers if a set of patterns is present in the tree.</li><li>Each pattern is detected by a &ldquo;matcher action&rdquo; that triggers and can fill a single attribute.
If a matcher triggers a set of attributes get set with a value and a confidence level</li><li>All results from all triggered matchers (and actions) are combined and for each individual attribute the &lsquo;highest value&rsquo; wins.</li></ul><p>As a performance optimization we walk along the parsed tree once and fire everything we find into a precomputed hashmap that
points to all the applicable matcher actions. As a consequence</p><ul><li>the matching is relatively fast even though the number of matchers already runs into the few hundreds.</li><li>the startup is &ldquo;slow&rdquo;</li><li>the memory footprint is pretty big due to the number of matchers, the size of the hashmap and the cache of the parsed useragents.</li></ul><p>A much more in depth explanation can be found in the documentation on <a href=/developer/makingnewrules/index.html>how to create new rules</a></p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class=default-animation><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a id=logo href=/><p class=logo-bar>Yauaa</p></a></div><script>window.index_js_url="/searchindex.js?1757311815"</script><search><form action=/search/index.html method=get><div class="searchbox default-animation"><button class=search-detail type=submit title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
<label class=a11y-only for=R-search-by>Search</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div></form></search><script>var contentLangs=["en"]</script><script src=/js/auto-complete.js?1757311815 defer></script><script src=/js/lunr/lunr.min.js?1757311815 defer></script><script src=/js/lunr/lunr.stemmer.support.min.js?1757311815 defer></script><script src=/js/lunr/lunr.multi.min.js?1757311815 defer></script><script src=/js/lunr/lunr.en.min.js?1757311815 defer></script><script src=/js/search.js?1757311815 defer></script></div><div id=R-homelinks class="default-animation homelinks"><ul><li><a class=padding href=/index.html><i class='fas fa-home'></i> Yauaa</a></li></ul><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/expect/index.html><a class=padding href=/expect/index.html>What to expect</a><ul id=R-subsections-0cc162f4d70118f5b01edda6c8732e77 class=collapsible-menu></ul></li><li data-nav-id=/using/index.html><a class=padding href=/using/index.html>Using Yauaa</a><ul id=R-subsections-790b0ab426eab6dc92cf29e810f15854 class=collapsible-menu></ul></li><li data-nav-id=/udf/index.html><a class=padding href=/udf/index.html>User Defined Functions</a><ul id=R-subsections-b853d96ac1607b20a47f0b01f30f143a class=collapsible-menu></ul></li><li class=parent data-nav-id=/developer/index.html><a class=padding href=/developer/index.html>Development</a><ul id=R-subsections-f87f59ebc94679f99e2683cdd4170483 class=collapsible-menu><li data-nav-id=/developer/building/index.html><a class=padding href=/developer/building/index.html>Building from source</a></li><li class=active data-nav-id=/developer/basedesign/index.html><a class=padding href=/developer/basedesign/index.html>Base Design</a></li><li data-nav-id=/developer/makingnewrules/index.html><a class=padding href=/developer/makingnewrules/index.html>Making new rules</a></li><li data-nav-id=/developer/shadingdependencies/index.html><a class=padding href=/developer/shadingdependencies/index.html>Shading dependencies</a></li><li data-nav-id=/developer/reportingissues/index.html><a class=padding href=/developer/reportingissues/index.html>Reporting issues</a></li></ul></li><li data-nav-id=/other/index.html><a class=padding href=/other/index.html>Other</a><ul id=R-subsections-dd17f32865650128ca32bc9ce5ee4fdf class=collapsible-menu></ul></li></ul></div><div id=R-shortcuts><div class="nav-title padding">More</div><ul class=space><li><a class=padding href=https://github.com/nielsbasjes/yauaa><i class='fab fa-git-square'></i> Git repo</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/discussions><i class='fa fa-comment-alt'></i> Discussions</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/blob/main/CHANGELOG.md><i class='fa fa-file-alt'></i> Changelog</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/issues><i class='fa fa-bug'></i> Issue tracker</a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/actions><img alt="Github actions Build status" src="https://img.shields.io/github/actions/workflow/status/nielsbasjes/yauaa/build.yml?branch=main"></a></li><li><a class=padding href=https://app.codecov.io/gh/nielsbasjes/yauaa><img alt="Coverage Status" src=https://img.shields.io/codecov/c/github/nielsbasjes/yauaa></a></li><li><a class=padding href=https://www.apache.org/licenses/LICENSE-2.0.html><img alt=License src=https://img.shields.io/:license-apache-blue.svg></a></li><li><a class=padding href=https://central.sonatype.com/namespace/nl.basjes.parse.useragent><img alt="Maven Central" src="https://img.shields.io/maven-central/v/nl.basjes.parse.useragent/yauaa-parent.svg?label=Maven%20central"></a></li><li><a class=padding href=https://github.com/jvm-repo-rebuild/reproducible-central#nl.basjes.parse.useragent:yauaa><img alt="Reproducible Builds" src="https://img.shields.io/badge/Reproducible_Builds-ok-success?labelColor=1e5b96"></a></li><li><a class=padding href=https://github.com/nielsbasjes/yauaa/stargazers><img alt="GitHub stars" src="https://img.shields.io/github/stars/nielsbasjes/yauaa?label=GitHub%20stars"></a></li><li><a class=padding href=https://hub.docker.com/r/nielsbasjes/yauaa><img alt="Docker Image" src="https://img.shields.io/docker/v/nielsbasjes/yauaa/latest?arch=amd64&label=Docker%20image"></a></li><li><a class=padding href=https://hub.docker.com/r/nielsbasjes/yauaa><img alt="Docker Pulls" src="https://img.shields.io/docker/pulls/nielsbasjes/yauaa?label=Docker%20pulls"></a></li><li><a class=padding href=https://github.com/sponsors/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Sponsor%20me-via%20Github-darkgreen.svg></a></li><li><a class=padding href=https://www.paypal.me/nielsbasjes><img alt="If this project has business value for you then dont hesitate to support me with a small donation." src=https://img.shields.io/badge/Donations-via%20Paypal-red.svg></a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fa-fw fas fa-language"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Language</label>
<select id=R-select-language onchange="location=this.querySelector(this.value).dataset.url"><option id=R-select-language-en value=#R-select-language-en data-url=/developer/basedesign/index.html lang=en-us selected></option></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fa-fw fas fa-paint-brush"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Theme</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-select-variant-yauaa value=yauaa selected>Yauaa</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fa-fw fas fa-history"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><p><img alt="NO AI: Deterministic, Predictable, Secure, Private, Offline, Safe, Fast" src=/NoAI_DeterministicPrivateFast-250x250.png></p><p><b>Yauaa does not use any AI at runtime.</b></p><p><i>This makes it Deterministic, Predictable, Offline, Secure, Private, Safe and Fast</i></p><p>&copy;2013-2025 by <a href=https://niels.basjes.nl>Niels Basjes</a></p></div></div></div></aside><script src=/js/clipboard.min.js?1757311815 defer></script><script src=/js/perfect-scrollbar.min.js?1757311815 defer></script><script src=/js/theme.js?1757311815 defer></script></body></html>