var relearn_searchindex = [
  {
    "breadcrumb": "Yauaa \u003e Other",
    "content": "A bit more background about this useragent parser can be found in this blog which I wrote about it: https://techlab.bol.com/making-sense-user-agent-string/",
    "description": "A bit more background about this useragent parser can be found in this blog which I wrote about it: https://techlab.bol.com/making-sense-user-agent-string/",
    "tags": [],
    "title": "Blogpost",
    "uri": "/other/article/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Development",
    "content": "Building Requirements:\nA Linux class machine (can be a VM). Some of the build scripts rely in bash/sed/grep and related tools, so it will not build on a Windows machine. I’m unsure if it will build on a Mac. The normal build tools for a Java project JDK 17, 21 and 25 all need to be installed. All of these are needed to ensure the code works in all UDFs. The ./start-docker.sh script launches a docker based build environment with all needed tools and configs.\nand then simply do:\nmvn clean package",
    "description": "Building Requirements:\nA Linux class machine (can be a VM). Some of the build scripts rely in bash/sed/grep and related tools, so it will not build on a Windows machine. I’m unsure if it will build on a Mac. The normal build tools for a Java project JDK 17, 21 and 25 all need to be installed. All of these are needed to ensure the code works in all UDFs. The ./start-docker.sh script launches a docker based build environment with all needed tools and configs.",
    "tags": [],
    "title": "Building from source",
    "uri": "/developer/building/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e What to expect",
    "content": "Output fields The resulting output fields can be classified into several categories:\nThe Device: The hardware that was used. The Operating System: The base software that runs on the hardware The Layout Engine: The underlying core that converts the ‘HTML’ into a visual/interactive The Agent: The actual “Browser” that was used. Extra fields: In some cases we have additional fields to describe the agent. These fields are among others specific fields for the Facebook and Kobo apps, and fields to describe deliberate useragent manipulation situations (Anonymization, Hackers, etc.) Note that not all fields are always available. So if you look at a specific field you will in general find null values and “Unknown” in there as well.\nThere are as little as possible lookup tables included the system really tries to analyze the useragent and extract values from it. The aim of this approach is to have a system that can classify as much traffic as possible yet require as little as possible maintenance because all versions and in many places also the names of the used components are extracted without knowing them beforehand.\nValues explained Note about the Hacker classification:\nSecurity scanning tools (like nmap, nessus and openvas) are also classified as Hacker. My reasoning is that it is a system that someone uses to find security problems. With tools like this it is clear it is not a normal visitor that is interested in the content of the website. What is uncertain is the reason behind this: is it to fix problems or to abuse them? So I classify all of them as hacking oriented tools. |\nDeviceClass Value Meaning Desktop The device is assessed as a Desktop/Laptop class device Anonymized In some cases the useragent has been altered by anonymization software Unknown We really don’t know, these are usually useragents that look normal yet contain almost no information about the device Mobile A device that is mobile yet we do not know if it is a eReader/Tablet/Phone or Watch Tablet A mobile device with a rather large screen (common \u003e 7\") Phone A mobile device with a small screen (common \u003c 7\") Watch A mobile device with a tiny screen (common \u003c 2\"). Normally these are an additional screen for a phone/tablet type device. Augmented Reality A mobile device with a AR capabilities (like Google Glass) Virtual Reality A mobile device with a VR capabilities eReader Similar to a Tablet yet in most cases with an eInk screen Set-top box A connected device that allows interacting via a TV sized screen TV Similar to Set-top box yet here this is built into the TV Home Appliance A (usally large) home appliance (like a Fridge) Game Console ‘Fixed’ game systems like the PlayStation and XBox Handheld Game Console ‘Mobile’ game systems like the 3DS Voice A voice driven device (i.e. ask a question and the page is read aloud). Like Alexa and Google Home. Smart Display A smart speaker kind of device with a tablet sized screen built in (like Google Nest and Amazon Echo Home) Car A Car based browser as found in for example the Tesla vehicles Robot Robots that visit the site Robot Mobile Robots that visit the site indicating they want to be seen as a Mobile visitor Robot Imitator Robots that visit the site pretending they are robots like google, but they are not. Note that in most cases they ARE Robots. Cloud A cloud based application. Not a Robot or Hacker but a normal application that needs to connect. This includes for example Mastodon servers. Hacker In case scripting is detected in the useragent string, also fallback in really broken situations OperatingSystemClass Value Meaning Desktop The type of OS you would run on a Desktop or Laptop Mobile The type of OS you would run on a Phone, Tablet or Watch Cloud Looks like a thing that runs in a cloud environment Embedded Apparently embedded into something like a TV Game Console A game console like PS4, Xbox Hacker A hacker, so it can really be anything. Anonymized It was explicitly hidden Unknown We don’t know LayoutEngineClass Value Meaning Browser A regular browser Desktop App A desktop app (often a PWA) Mobile App A mobile app which probably includes a regular webbrowser Hacker A hacker, so it can really be anything. Robot A robot spidering the site Cloud A cloud based application where it is unclear what kind of layout engine is really used Special Something special we cannot fully classify Unknown We don’t know AgentClass Value Meaning Browser A regular browser Browser Webview A regular browser being used as part of a mobile app Desktop App A desktop app (often a PWA) Mobile App A mobile app Robot A robot that wants to be treated as a desktop device Robot Mobile A robot that wants to be treated as a mobile device Cloud Application Something running in a cloud that is intended to be Human facing (so not a regular robot) Server Something running in a cloud that is intended to be Server-to-Server (so not a regular robot) Email Client This is an email application that did the request Voice A voice driven ‘browser’ (i.e. ask a question and the page is read aloud). Like Alexa and Google Home. Special Something special we cannot fully classify Testclient A website testing tool Hacker A hacker, so it can really be anything. Unknown We don’t know AgentSecurity Value Meaning Weak security Indicated to use deliberately weakened encryption (usually due to export restrictions or local laws). Strong security Indicated to use strong (normal) encryption. Unknown It was not specified (very common) Hacker A hacker, so it can really be anything.",
    "description": "Output fields The resulting output fields can be classified into several categories:\nThe Device: The hardware that was used. The Operating System: The base software that runs on the hardware The Layout Engine: The underlying core that converts the ‘HTML’ into a visual/interactive The Agent: The actual “Browser” that was used. Extra fields: In some cases we have additional fields to describe the agent. These fields are among others specific fields for the Facebook and Kobo apps, and fields to describe deliberate useragent manipulation situations (Anonymization, Hackers, etc.) Note that not all fields are always available. So if you look at a specific field you will in general find null values and “Unknown” in there as well.",
    "tags": [],
    "title": "Field values",
    "uri": "/expect/fieldvalues/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "This library extracts as many as possible fields from the provided User-Agent value and (if available) the provided Client Hints.\nAs an example the useragent of my phone (from a while ago):\nMozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36 is converted into this set of fields:\nField name Value Device Class Phone Device Name Google Nexus 6 Device Brand Google Operating System Class Mobile Operating System Name Android Operating System Version 7.0 Operating System Name Version Android 7.0 Operating System Version Build NBD90Z Layout Engine Class Browser Layout Engine Name Blink Layout Engine Version 53.0 Layout Engine Version Major 53 Layout Engine Name Version Blink 53.0 Layout Engine Name Version Major Blink 53 Agent Class Browser Agent Name Chrome Agent Version 53.0.2785.124 Agent Version Major 53 Agent Name Version Chrome 53.0.2785.124 Agent Name Version Major Chrome 53",
    "description": "This library extracts as many as possible fields from the provided User-Agent value and (if available) the provided Client Hints.\nAs an example the useragent of my phone (from a while ago):\nMozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36 is converted into this set of fields:\nField name Value Device Class Phone Device Name Google Nexus 6 Device Brand Google Operating System Class Mobile Operating System Name Android Operating System Version 7.0 Operating System Name Version Android 7.0 Operating System Version Build NBD90Z Layout Engine Class Browser Layout Engine Name Blink Layout Engine Version 53.0 Layout Engine Version Major 53 Layout Engine Name Version Blink 53.0 Layout Engine Name Version Major Blink 53 Agent Class Browser Agent Name Chrome Agent Version 53.0.2785.124 Agent Version Major 53 Agent Name Version Chrome 53.0.2785.124 Agent Name Version Major Chrome 53",
    "tags": [],
    "title": "What to expect",
    "uri": "/expect/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Using Yauaa",
    "content": "The User-Agent and the User-Agent Client Hints From about 2019 onward several of the main browsers (Firefox/Chromium/Chrome/Edge/…) have been making steps to reduce the information in the User-Agent. The main reason is that the User-Agents so far have so much detailed information that it became so unique that some could be used as a device id for tracking purposes.\nIn addition, steps are taken to provide information to website builders that is intended to be sufficient for running a website and less prone to tracking people.\nAs part of this an extension to the Client Hints have been documented and implemented in the Chromium based browsers to provide the User-Agent Client Hints via the HTTP request headers.\nSee:\nhttps://wicg.github.io/ua-client-hints/#http-ua-hints https://web.dev/user-agent-client-hints/ https://docs.microsoft.com/en-us/microsoft-edge/web-platform/user-agent-guidance https://docs.microsoft.com/en-us/microsoft-edge/web-platform/how-to-detect-win11 https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-CH-UA#directives Getting the browser to send User-Agent Client Hints Now the User-Agent Client Hints are provided by the browser in each request to the server via additional request headers.\nFirst important thing is that they will only be send if the server is localhost or over a secured connection (https).\nIf you try a remote server over plain http you will see no User-Agent Client Hints at all.\nBy default the browsers that support this will send the “low entropy” values without the need to do anything special (other than going over https).\nThese headers are\nRequest header Example value Sec-Ch-Ua \" Not A;Brand\";v=“99”, “Chromium”;v=“100”, “Google Chrome”;v=“100” Sec-Ch-Ua-Mobile ?0 Sec-Ch-Ua-Platform “Windows” If additional headers are desired then the service should send an Accept-CH response header with the first response and then any subsequent requests will (if allowed) send the requested additional headers.\nAccept-CH: Sec-CH-UA, Sec-CH-UA-Arch, Sec-CH-UA-Bitness, Sec-CH-UA-Form-Factors, Sec-CH-UA-Full-Version, Sec-CH-UA-Full-Version-List, Sec-CH-UA-Mobile, Sec-CH-UA-Model, Sec-CH-UA-Platform, Sec-CH-UA-Platform-Version, Sec-CH-UA-WoW64 If the additional headers are critical to your application you can send Critical-CH in addition of the Accept-CH to indicate which are\nCritical-CH: Sec-CH-UA, Sec-CH-UA-Arch, Sec-CH-UA-Bitness, Sec-CH-UA-Form-Factors, Sec-CH-UA-Full-Version, Sec-CH-UA-Full-Version-List, Sec-CH-UA-Mobile, Sec-CH-UA-Model, Sec-CH-UA-Platform, Sec-CH-UA-Platform-Version, Sec-CH-UA-WoW64 See:\nhttps://chromestatus.com/feature/5727177800679424 https://github.com/WICG/client-hints-infrastructure/blob/main/reliability.md Depending on the situation you may need to also set a Permissions-Policy HTTP header to actually get the desired headers.\nhttps://www.w3.org/TR/permissions-policy/ https://github.com/w3c/webappsec-permissions-policy/blob/main/permissions-policy-explainer.md https://github.com/w3c/webappsec-permissions-policy/issues/129 The headers Yauaa can handle are shown in this table.\nThe shown example values are the real values recorded when running Chrome 100.0.4896.75 with the reduced User-Agent setting enabled on Windows 7.\nRequest header Example value User-Agent Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.0.0 Safari/537.36 Sec-Ch-Ua \" Not A;Brand\";v=“99”, “Chromium”;v=“100”, “Google Chrome”;v=“100” Sec-Ch-Ua-Arch “x86” Sec-Ch-Ua-Bitness “64” Sec-CH-Ua-Full-Version “100.0.4896.75” Sec-Ch-Ua-Full-Version-List \" Not A;Brand\";v=“99.0.0.0”, “Chromium”;v=“100.0.4896.75”, “Google Chrome”;v=“100.0.4896.75” Sec-Ch-Ua-Mobile ?0 Sec-Ch-Ua-Model \"\" Sec-Ch-Ua-Platform “Windows” Sec-Ch-Ua-Platform-Version “0.1.0” Sec-Ch-Ua-Wow64 ?0 Logging the User-Agent Client Hints If you happen to be using the Apache HTTPD webserver you can record these values with a LogFormat configuration something like this:\nLogFormat \"%a %l %u %t \\\"%r\\\" %\u003es %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" \\\"%{Sec-CH-UA}i\\\" \\\"%{Sec-CH-UA-Arch}i\\\" \\\"%{Sec-CH-UA-Bitness}i\\\" \\\"%{Sec-CH-UA-Form-Factors}i\\\" \\\"%{Sec-CH-UA-Full-Version}i\\\" \\\"%{Sec-CH-UA-Full-Version-List}i\\\" \\\"%{Sec-CH-UA-Mobile}i\\\" \\\"%{Sec-CH-UA-Model}i\\\" \\\"%{Sec-CH-UA-Platform}i\\\" \\\"%{Sec-CH-UA-Platform-Version}i\\\" \\\"%{Sec-CH-UA-WoW64}i\\\" %V\" combinedhintsvhost Behind this Apache Httpd webserver is a website that returns the header\nAccept-CH: Sec-CH-UA, Sec-CH-UA-Arch, Sec-CH-UA-Bitness, Sec-CH-UA-Form-Factors, Sec-CH-UA-Full-Version, Sec-CH-UA-Full-Version-List, Sec-CH-UA-Mobile, Sec-CH-UA-Model, Sec-CH-UA-Platform, Sec-CH-UA-Platform-Version, Sec-CH-UA-WoW64 With all of this in place: these are two of the lines that are found in the access log of this Apache Httpd webserver:\n45.138.228.54 - - [02/May/2022:12:25:10 +0200] \"GET / HTTP/1.1\" 200 16141 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36\" \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"\" \"\\\"x86\\\"\" \"\\\"64\\\"\" \"-\" \"\\\"100.0.4896.127\\\"\" \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.127\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.127\\\"\" \"?0\" \"\\\"\\\"\" \"\\\"Linux\\\"\" \"\\\"5.13.0\\\"\" \"?0\" try.yauaa.basjes.nl 45.138.228.54 - - [02/May/2022:12:25:34 +0200] \"GET / HTTP/1.1\" 200 15376 \"-\" \"Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.0.0 Mobile Safari/537.36\" \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"101\\\", \\\"Google Chrome\\\";v=\\\"101\\\"\" \"\\\"\\\"\" \"-\" \"-\" \"\\\"101.0.4951.41\\\"\" \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"101.0.4951.41\\\", \\\"Google Chrome\\\";v=\\\"101.0.4951.41\\\"\" \"?1\" \"\\\"Nokia 7.2\\\"\" \"\\\"Android\\\"\" \"\\\"11.0.0\\\"\" \"?0\" try.yauaa.basjes.nl Parsing these logfiles can easily be done with this library: https://github.com/nielsbasjes/logparser\nAnalyzing the User-Agent Client Hints Starting with Yauaa 7.0.0 the main Java library supports parsing the available client hints along with the User-Agent.\nIn its most basic form you can now do this:\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .build(); Map\u003cString, String\u003e requestHeaders = new TreeMap\u003c\u003e(); requestHeaders.put(\"User-Agent\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.0.0 Safari/537.36\"); requestHeaders.put(\"Sec-Ch-Ua\", \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Arch\", \"\\\"x86\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Full-Version-List\", \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.75\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.75\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Mobile\", \"?0\"); requestHeaders.put(\"Sec-Ch-Ua-Model\", \"\\\"\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform\", \"\\\"Windows\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform-Version\", \"\\\"0.1.0\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Wow64\", \"?0\"); UserAgent userAgent = uaa.parse(requestHeaders); this results in (among other things)\nOperatingSystemNameVersion : 'Windows 7' AgentNameVersion : 'Chrome 100.0.4896.75' Although the User-Agent contains Windows NT 10.0 the (correct) answer provided by Yauaa is Windows 7 because this is the reduced User-Agent (all minor versions of Chrome are 0: 100.0.0.0) and the Client hints indicate Windows and 0.1.0.\nWhich client hints do I really need? A bit deeper dive into the fields and their “added value” and why to request and keep them (or not).\nGeneral considerations:\nThe first request only has the low entropy headers Sec-Ch-Ua, Sec-Ch-Ua-Mobile and Sec-Ch-Ua-Platform. Only later requests can have more headers if requested and allowed. With the reduction/freeze of the useragents several parts are now static and no longer show correct values. This is most obvious are the version of the browser (only the major version), the device brand \u0026 name (absent on mobile) and the version of the operating system (i.e. always Windows 10.0, Android 10 or Mac OS X 10_15_7 ). This is where client hints do contain the correct values. Client hint Example Keep it? Why Sec-Ch-Ua \" Not A;Brand\";v=“99”, “Chromium”;v=“100”, “Google Chrome”;v=“100” Yes You may not have the Sec-Ch-Ua-Full-Version-List with the exact versions. Sec-Ch-Ua-Full-Version-List \" Not A;Brand\";v=“99.0.0.0”, “Chromium”;v=“100.0.4896.75”, “Google Chrome”;v=“100.0.4896.75” Yes Is the better variant of Sec-Ch-Ua but it may not be present. Sec-CH-Ua-Full-Version “100.0.4896.75” No This field is deprecated in the standard. Also this info is also present in the Sec-Ch-Ua-Full-Version-List. Sec-Ch-Ua-Mobile ?0 Yes In the (very rare) case where we cannot determine if it is a phone or tablet this flag determines the end result. Sec-Ch-Ua-Platform “Windows” Yes Needed in the very common case of bad version info in the useragent. Sec-Ch-Ua-Platform-Version “0.1.0” Yes Needed in the very common case of bad version info in the useragent. This “0.1.0” means “Windows 7” because the Platform says “Windows”. Sec-Ch-Ua-Arch “x86” Yes The only way to determine a MacOS system is running an M1/M2 (ARM) instead of an Intel CPU Sec-Ch-Ua-Bitness “64” Yes Often not present in the useragent Sec-CH-UA-Form-Factors “Mobile” Yes New in the specification, in July 2023 no browsers supported this yet. Sec-Ch-Ua-Model “Nokia 7.2” Yes Often not present in the useragent (brand and device info). Sec-Ch-Ua-Wow64 ?0 No The only thing this says is that this is Windows (use Platform) and that it is 32 bit software running on a 64 bit system. To simplify it all I would\nAsk for all of them (regardless if I say No above) because the browsers are currently in flux in what they put in these fields. Persist all headers starting with Sec-Ch-Ua along with the User-Agent. The assumption is that later versions of browsers will change what they put in these fields which may yield possible analysis improvements.",
    "description": "The User-Agent and the User-Agent Client Hints From about 2019 onward several of the main browsers (Firefox/Chromium/Chrome/Edge/…) have been making steps to reduce the information in the User-Agent. The main reason is that the User-Agents so far have so much detailed information that it became so unique that some could be used as a device id for tracking purposes.\nIn addition, steps are taken to provide information to website builders that is intended to be sufficient for running a website and less prone to tracking people.",
    "tags": [],
    "title": "User-Agent Client Hints",
    "uri": "/using/clienthints/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Development",
    "content": "Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:\nAlthough there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.\nThe reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature.\nif (useragent.contains(\"Chrome\")) { // Use the chrome feature we need. } Some may improve on this an actually check the (major) version that follows.\nA good example of this is the Edge browser:\nMozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36 Edge/12.10136 It says it:\nis Mozilla/5.0 uses AppleWebKit/537.36 for “compatibility” the AppleWebKit lie about being “KHTML” and that it is similar to “Gecko” are also copied is Chrome 42 is Safari 537 is Edge 12 So any website looking for the word it triggers upon will find it and enable the right features.\nIn 2014 an RFC for HTTP was released (RFC 7231 section 5.5.3) which now explicitly states:\n... implementations are encouraged not to use the product tokens of other implementations in order to declare compatibility with them, as this circumvents the purpose of the field. … encouraged …\nHow many other analyzers work When looking at most implementations of analysing the useragents I see that most implementations are based around lists of regular expressions. These are (in the systems I have seen) executed in a specific order to find the first one that matches.\nIn this solution direction the order in which things occur determines if the patterns match or not.\nRegular expressions are notoriously hard to write and debug and (unless you make them really complex) the order in which parts of the pattern occur is fixed.\nCore design idea I wanted to see if a completely different approach would work: Can we actually parse these things into a tree and work from there.\nThe parser (ANTLR4 based) will be able to parse a lot of the agents but not all. Tests have shown that it will parse \u003e99% of all useragents on a large website which is more than 99.99% of the traffic.\nNow the ones that it is not able to parse are the ones that have been set manually to an invalid value. So if that happens we assume you are a hacker. In all other cases we have matchers that are triggered if a specific value is found by the parser. Such a matcher then tells this class is has found a match for a certain attribute with a certain confidence level (0-10000000). In the end the matcher that has found a match with the highest confidence for a value ‘wins’.\nHigh level implementation overview The main concept of this useragent parser is that we have two things:\nA Parser (ANTLR4) that converts the useragent into a nice tree through which we can walk along. A collection of matchers. A matcher triggers if a set of patterns is present in the tree. Each pattern is detected by a “matcher action” that triggers and can fill a single attribute. If a matcher triggers a set of attributes get set with a value and a confidence level All results from all triggered matchers (and actions) are combined and for each individual attribute the ‘highest value’ wins. As a performance optimization we walk along the parsed tree once and fire everything we find into a precomputed hashmap that points to all the applicable matcher actions. As a consequence\nthe matching is relatively fast even though the number of matchers already runs into the few hundreds. the startup is “slow” the memory footprint is pretty big due to the number of matchers, the size of the hashmap and the cache of the parsed useragents. A much more in depth explanation can be found in the documentation on how to create new rules",
    "description": "Parsing Useragents Parsing useragents is considered by many to be a ridiculously hard problem. The main problems are:\nAlthough there seems to be a specification, many do not follow it. Useragents LIE that they are their competing predecessor with an extra flag. The pattern the ’normal’ browser builders are following is that they all LIE about the ancestor they are trying to improve upon.\nThe reason this system (historically) works is because a lot of website builders do a very simple check to see if they can use a specific feature.",
    "tags": [],
    "title": "Base Design",
    "uri": "/developer/basedesign/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e What to expect",
    "content": "On my systems I see a speed ranging from 500 to 4000 useragents per second (depending on the length and ambiguities in the useragent). On average the speed is around 2000 per second or ~0.5ms each. A LRU cache is in place that does over 1M per second if they are in the cache.\nPlease note that the current system take approx 220MiB of RAM just for the engine (without any caching!!).\nIn the canonical usecase of analysing clickstream data you will see a \u003c1ms hit per visitor (or better: per new non-cached useragent) and for all the other clicks the values are retrieved from this cache at a speed of \u003c 1 microsecond (i.e. close to 0).\nThe graph below gives you some insight of how the performance of Yauaa has progressed over time.\nYou can clearly see the increase in the time needed when adding a lot more rules. Also the periodic drops in time needed are clearly visible when a performance improvement was found.\nBetween version 5.5 and 5.6 a lot of extra rules to detect more brands of mobile devices on Android (at one point during development the needed time to reached ~ 3ms). Followed by a few steps in a rewrite of that part resulting in effectively the fastest versions to date.\nOutput from the benchmark ( using this code ) on an Intel(R) Core(TM) Ultra 5 125H @ 3GHz from version 4.0 onwards:",
    "description": "On my systems I see a speed ranging from 500 to 4000 useragents per second (depending on the length and ambiguities in the useragent). On average the speed is around 2000 per second or ~0.5ms each. A LRU cache is in place that does over 1M per second if they are in the cache.\nPlease note that the current system take approx 220MiB of RAM just for the engine (without any caching!!).",
    "tags": [],
    "title": "Performance",
    "uri": "/expect/performance/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Other",
    "content": ".NET port Stefano Balzarotti is putting a lot of effort into porting Yauaa to run in .NET standard.\nYou can track his efforts here on GitHub: Yauaa .NET standard and download his releases via Nuget.",
    "description": ".NET port Stefano Balzarotti is putting a lot of effort into porting Yauaa to run in .NET standard.\nYou can track his efforts here on GitHub: Yauaa .NET standard and download his releases via Nuget.",
    "tags": [],
    "title": "Related projects",
    "uri": "/other/relatedprojects/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.\nUsing in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e To actually use it in your application you need to create an instance of the UserAgentAnalyzer.\nPlease instantiate a new UserAgentAnalyzer as few times as possible because the initialization step for a full UserAgentAnalyzer (i.e. all fields) usually takes something in the range of 2-5 seconds and uses a few hundred MiB of memory to store all the analysis datastructures.\nThis analyzer can only do a single analysis at a time and to ensure correct working the main method is synchronized. If you have a high load you should simply create multiple instances and spread the load over those instances. When running in a framework (like Apache Flink or Apache Beam) this is usually automatically managed by these frameworks. In other systems may choose something like a threadpool to do that.\nNote that if you need multiple instances of the UserAgentAnalyzer then you MUST create a new Builder instance for each of those (or serialize an instance and deserialize it multiple times).\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .hideMatcherLoadStats() .withCache(10000) .build(); Then for each useragent (or set of request headers) you call the parse method to give you the desired result:\nUserAgent agent = uaa.parse(\"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11\"); for (String fieldName: agent.getAvailableFieldNamesSorted()) { System.out.println(fieldName + \" = \" + agent.getValue(fieldName)); } Note that not all fields are available after every parse. So be prepared to receive a null, Unknown or another field specific default.\nCustom caching implementation Since version 6.7 you can specify a custom implementation for the cache by providing an instance of the factory interface CacheInstantiator.\nDo note that Yauaa assumes the caching implementation to be threadsafe. If you use a non-threadsafe implementation in a multithreaded context it will break.\nThe default caching implementation uses Caffeine (since version 6.8).\nreturn Caffeine.newBuilder().maximumSize(cacheSize).\u003cString, ImmutableUserAgent\u003ebuild().asMap(); A custom implementation can be specified via the Builder using the withCacheInstantiator(...) method:\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .withCacheInstantiator( new CacheInstantiator() { @Override public Map\u003cString, ImmutableUserAgent\u003e instantiateCache(int cacheSize) { return new MyMuchBetterCacheImplementation(cacheSize); } } ) .withClientHintCacheInstantiator( (ClientHintsCacheInstantiator\u003c?\u003e) size -\u003e Collections.synchronizedMap(new LRUMap\u003c\u003e(size))) .withCache(10000) .build(); Running on Java 8 Normal use Yauaa 7.x still allows running on Java 8, yet the default caching library needs Java 11.\nSince version 7.19.0 the selection of the caching implementation is automatically based upon the Java version used to run it. Running in Java 8 - Java 10 the LRUMap (caching implementation that is part of the Apache commons-collections library) is used, Java 11 and newer Caffeine is used.\nIf needed (and also for backwards compatibility and testing) you can still force it to use the LRUMap regardless of the Java version by doing something like this:\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .useJava8CompatibleCaching() .withCache(10000) .build(); Really ONLY Java 8 If you have a very strict requirement that no classes are in the project that are above JDK 8 then you should do 2 things:\nExclude the caffeine dependency Maven pom.xml snippet\n\u003cdependencies\u003e \u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003cexclusions\u003e \u003cexclusion\u003e \u003cgroupId\u003ecom.github.ben-manes.caffeine\u003c/groupId\u003e \u003cartifactId\u003ecaffeine\u003c/artifactId\u003e \u003c/exclusion\u003e \u003c/exclusions\u003e \u003c/dependency\u003e \u003c/dependencies\u003e Gradle snippet\nimplementation('nl.basjes.parse.useragent:yauaa:8.0.0') { exclude group: 'com.github.ben-manes.caffeine', module: 'caffeine' } Make sure the used caching library is always the Java 8 compatible one. Either by only running on Java 8 Or by forcing the caching to always use the Java 8 with something like this: UserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .useJava8CompatibleCaching() .withCache(10000) .build(); Logging dependencies The Yauaa engine uses Log4j2 API as the logging framework.\nTo minimize the complexity of the dependency handling I have chosen to simply not include ANY logging framework and expect the consuming system to provide what ever fits best. Even the required log4j-api 2.x dependency is configured as provided to avoid any needless version conflicts.\nTo use Yauaa you must provide the desired version of log4j-api and either an implementation or a bridge for Apache Log4j2 to route the logging to where you want it.\nSo it all depends on your exact context (i.e. which logging framework are you going to use) what the best solution is for you to make all of this logging work as intended.\nIn case you are using Apache Log4j2 you should have these dependencies in addition to Yauaa in your project\n\u003c!-- The default logging implementation for Yauaa --\u003e \u003cdependency\u003e \u003cgroupId\u003eorg.apache.logging.log4j\u003c/groupId\u003e \u003cartifactId\u003elog4j-core\u003c/artifactId\u003e \u003cversion\u003e${log4j2.version}\u003c/version\u003e \u003c/dependency\u003e Regarding the Log4J2 issues The Yauaa analyzer uses the Log4J2 API to do the logging.\nTL;DR:\nThe core of Yauaa is safe as it does not include any logging dependencies and expects the application to provide everything. In normal operations user input is not logged. The Snowflake UDF is affected by these problems (due to shading the dependencies in). NO batteries included By design the Yauaa library expects the application in which it is used to provide the actual logging dependencies and configuration. If you do not provide the needed logging classes it will simply fail at startup.\nSo by design the Yauaa library expects all of these frameworks to be provided (and configured) and does not include any of them or any configuration for them.\nThis is true for most of the released artifacts (including the base library) except for the Snowflake UDF which does include almost all dependencies. So the Snowflake UDF IS affected by this issue and all users are recommended to update.\nMinimal logging Note that Yauaa does not log any user input and/or analysis results from user input during normal operation. Only during development and during unit tests the Useragents are logged.\nThis is because it was designed to run in very large scale batch and streaming situations (very large as in “Let’s analyze these 10^10 records”).\nBring your own batteries To assist in running Yauaa without the logj4-core jar an example was created that only uses SLF4J 1.x and and example that only uses SLF4J 2.x.\nSerialization If your application needs to serialize the instance of the UserAgentAnalyzer then both the standard Java serialization and Kryo are supported. Note that with Kryo 5.x you need to register all classes and configure Kryo correctly.\nTo facilitate doing this correctly the static method configureKryo was created. So in general your code should look something like this:\nKryo kryo = new Kryo(); UserAgentAnalyzer.configureKryo(kryo); Note that both the serializing and the deserializing instance of Kryo must be configured in the same way.\nAvoid using it as a static member If you make the UserAgentAnalyzer a static member of a class then cleaning it up after use may be a problem. One case where this happens is in the context of something like Tomcat where a webapp is loaded and then unloaded. If the analyzer is a static member of your servlet then this unloading may retain a lot of the memory used for the internal data structures.\nCache size setting I recommend you leave the cache to a size that is roughly the unique number of useragents your site finds in a limited timespan. Something like 15/30/60 minutes usually gives you a fine cache size. On a very busy website I see ~50K-60K distinct useragents per day and ~10K per hour. So in my opinion a cache size of 5K-10K elements is a good choice.\nReducing the memory footprint Limiting to only certain fields In some scenarios you only want a specific field and all others are unwanted. This can be achieved by creating the analyzer in Java like this:\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .withField(\"DeviceClass\") .withField(\"AgentNameVersionMajor\") .build(); One important effect is that this speeds up the system because it will kick any rules that do not help in getting the desired fields. The above example showed an approximate 40% speed increase (i.e. times dropped from ~1ms to ~0.6ms).\nDo note that some fields need other fields as input (i.e. intermediate result). For example the DeviceBrand also needs the AgentInformationEmail and AgentInformationUrl because in some cases the actual brand is derived from for example the domainname that usually is present in those. So if you only ask for the DomainBrand you will get those fields also.\nIn the nl.basjes.parse.useragent.UserAgent many (not all!!) of the provided variables are provided as a constant String. You can choose to use these and avoid subtle typos in the requested attribute names.\nUserAgentAnalyzer uaa = UserAgentAnalyzer .newBuilder() .withField(DEVICE_CLASS) .withField(AGENT_NAME_VERSION_MAJOR) .build(); Sharing the config between instances (new in 7.24.0) In some situations you may want to have multiple instances to handle the load within in a single JVM. In those cases you’ll also want the configuration of all instances to be identical.\nIf you are in exactly that scenario you can create a duplicate instance with the exact same configuration and save a few MiB of memory. The currently estimated savings is at about 20-30MiB for each extra instance (depending on the configuration).\nUserAgentAnalyzer extraUaa = uaa.cloneWithSharedAnalyzerConfig(false, true); Building your project with -Xlint:all If you are trying to get rid of all possible problems in your application and set the compiler flag -Xlint:all you will see warnings relating to the Kryo serialization system.\n[WARNING] COMPILATION WARNING : [INFO] ------------------------------------------------------------- [WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer': class file for com.esotericsoftware.kryo.DefaultSerializer not found [WARNING] Cannot find annotation method 'value()' in type 'com.esotericsoftware.kryo.DefaultSerializer' [INFO] 2 warnings The Yauaa analyzer has been prepared in such a way that it can be serialized using both the standard Java serialization and the Kryo serialization library. The Kryo library has been configured as a “provided” dependency because many do not need it, and (to avoid version conflicts) those who do need it have this dependency already.\nIf your project does not use Kryo and you have this warning then there are several ways to work around this:\nDisable the Xlint check that triggers this warning. Apparently this is the “classfile” so try to use -Xlint:all,-classfile instead. Add the otherwise needless Kryo library as a “provided” dependency to your project. \u003cdependency\u003e \u003cgroupId\u003ecom.esotericsoftware\u003c/groupId\u003e \u003cartifactId\u003ekryo\u003c/artifactId\u003e \u003cversion\u003e5.4.0\u003c/version\u003e \u003cscope\u003eprovided\u003c/scope\u003e \u003c/dependency\u003e IMPORTANT: This library is single threaded ! Because the internal analyzer code is not reentrant the main method has been synchronized on the instance. So from the perspective of you the application developer this library is thread safe.\nIf you are in a multi threaded situation you should create a separate instance per thread or accept the speed limitation of the shared synchronized instance.\nNote that you should really instantiate it only once per thread (and use a ThreadPool or something similar) because starting a new instance takes several seconds.\nEclipse users Be aware of there is a bug in Eclipse which will show you errors in perfectly valid Java code: https://bugs.eclipse.org/bugs/show_bug.cgi?id=527475 The errors you see are related to the inheritance model used by the Builders in this project and the fact that Eclipse does not interpret it correctly.\nScala usage When using this library from a Scala application the way the Builders have been constructed turns out to be very unfriendly to use.\nStarting with Yauaa version 5.14 the rewritten builders (contributed by Robert Stoll) will become available which will make it a lot easier for Scala users to use:\nval uaa = UserAgentAnalyzer.newBuilder .withCache(10000) .hideMatcherLoadStats .withField(\"DeviceClass\") .build Snapshots Occasionally I publish a snapshot version. If you want to use such a version then the repository can be configured in your maven with something like this\n\u003crepositories\u003e \u003crepository\u003e \u003cid\u003esonatype-oss-snapshots\u003c/id\u003e \u003cname\u003eSonatype OSS Snapshots\u003c/name\u003e \u003curl\u003ehttps://oss.sonatype.org/content/repositories/snapshots\u003c/url\u003e \u003creleases\u003e\u003cenabled\u003efalse\u003c/enabled\u003e\u003c/releases\u003e \u003csnapshots\u003e\u003cenabled\u003etrue\u003c/enabled\u003e\u003c/snapshots\u003e \u003c/repository\u003e \u003c/repositories\u003e",
    "description": "Using the analyzer To use this analyzer you can use it either directly in your Java based applications or use one of the User Defined Functions that are available for many of Apache bigdata tools (Hive, Flink, Beam, …) as described here.\nUsing in Java applications To use the library you must first add it as a dependency to your application. The library has been published to maven central so that should work in almost any environment.",
    "tags": [],
    "title": "Using the analyzer",
    "uri": "/using/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e What to expect",
    "content": "It only analyzes the provided string This system is based on analyzing the useragent string and looking for the patterns in the useragent string as they have been defined by parties like Google, Microsoft, Samsung and many others. These have been augmented with observations how developers apparently do things. There are really no (ok, very limited) lookup tables that define if a certain device name is a Phone or a Tablet. This makes this system very maintainable because there is no need to have a list of all possible devices.\nAs a consequence if a useragent does not follow these patterns the analysis will yield the ‘wrong’ answer. Take for example these two (both were found exactly as shown here in the logs of a live website):\nMozilla/5.0 (Linux; Android 5.1; SAMSUNG-T805s Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.94 Mobile Safari/537.36 Mozilla/5.0 (Linux; Android 4.4.2; SAMSUNG-T805S Build/KOT49H) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.89 Safari/537.36 The difference between “Mobile Safari” and “Safari” has been defined for Google Chrome as the difference between “Phone” and “Tablet” (see the Chrome documentation on this).\nAnd as you can see in this example: we sometimes get it wrong (The Samsung T805s is in reality a Tablet). The impact in this case is however very limited: Of the 445 visitors I found using this device only 2 were classified wrong all others were correct.\nUnexpected differences Some cases that seem very similar to the previous example are in a way correct.\nTake for example the Samsung Galaxy S8 (SM-G950F) which is a Phone.\nIn normal use the Useragent looks like this:\nMozilla/5.0 (Linux; Android 9; SM-G950F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Mobile Safari/537.36 when this device is connected to a computer screen then “Samsung Dex” (Dex = Desktop Experience) takes over and the screen layout and usage of the phone changes dramatically.\nMozilla/5.0 (Linux; Android 9; SM-G950F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36 This time the change (from Mobile Safari to just Safari) indicates the device is to be treated as a Tablet because the screen size and ways of interacting have changed.\nApple iPads are a “Desktop” Since about February 2025 the Apple iPads no longer are reported as a Tablet because their useragent has switched to reporting a Desktop:\nA known device which was previously reporting these\nMozilla/5.0 (iPad; CPU OS 18_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 Mozilla/5.0 (iPad; CPU OS 18_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) is now reporting this\nMozilla/5.0 (Macintosh; Intel Mac OS 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Safari/605.1.15 This last one is identical to an Apple Mac Desktop and this makes it impossible to determine that this is really a Tablet.\nCurrently (April 2025) it seems that this effect is different depending on the used browser. Browsers like Chrome, Edge, Opera, Aloha and Yandex still report iPad Tablet, but browsers like Safari, Brave, Firefox, DuckDuckGo and Arc Search report MacOS Desktop\nSome are simply incorrect When the Samsung Browser is installed on a non-Samsung device (in this example a Google Nexus 6) you get this:\nMozilla/5.0 (Linux; Android 7.0; SAMSUNG Nexus 6 Build/NBD92G) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/5.4 Chrome/51.0.2704.106 Mobile Safari/537.36 As you can see this browser assumes it is only installed on Samsung devices so they ‘force’ the word Samsung in there. In this case you will see this being reported as a “Samsung Nexus 6”, which is obviously wrong.\nNote that this specific case with the SamsungBrowser has now been fixed with a set of additional rules so this one is now correctly reported as a Google Nexus 6.\nDevice Name and Device Brand The detection of the brand and name of the device are the most brittle and unreliable part of the output.\nThere are a few reasons for this:\nThere are a LOT of different devices from a LOT of vendors. To give you an impression; In november 2018 I did a count on the index page of DeviceAtlas and found over 4100 brands and a total of over 55000 different devices. In most cases the useragent string ONLY include the model of the device and NOT the brand. So you need to be able to determine JUST from the model what brand it was. This system tries to limit the number of lookup tables and rely on patterns as much as possible. As a consequence I really do not want to have a complete list of all devices in here. So what are the patterns in the mapping from model to brand? I did an analysis on some of these brands and found that Acer, Lenovo, LG and QMobile all have a device called ‘A200’. So if the useragent only contains ‘A200’ there is no way to determine what device it really was. So as a consequence I have chosen to limit this detection to\nBrands that are included as the first word in the appropriate field. Special cases (like robots) The “most used brands” as good as possible. WARNING: The detection of DeviceBrand will therefore never be complete and accurate.",
    "description": "It only analyzes the provided string This system is based on analyzing the useragent string and looking for the patterns in the useragent string as they have been defined by parties like Google, Microsoft, Samsung and many others. These have been augmented with observations how developers apparently do things. There are really no (ok, very limited) lookup tables that define if a certain device name is a Phone or a Tablet. This makes this system very maintainable because there is no need to have a list of all possible devices.",
    "tags": [],
    "title": "Limitations",
    "uri": "/expect/limitations/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Development",
    "content": "Detecting new useragent patterns When you find a useragent for which one or more of the fields are wrong there is the need to change the patterns and rules that are used by this system for classifying these attributes. In order to write rules this first described how the system works and what tools have been created to make writing new rules easier.\nBase problem: They all lie When looking at useragents it is clear that almost all of them include the name of predecessors/competitors with which they are supposed to be compatible with.\nSo in general there is a ranking in the patterns; some are more true than others.\nSolution overview The way this system solves all of this is by employing several steps:\nThe user agent string is parsed into a tree using Antlr4. This tree is matched against a set of “Matchers” A matcher is a set of patterns that must be present in the tree a set of field/value combinations with a ‘weight’ the value can be either a fixed value or a part of the tree. For all matchers where ALL required patterns were present the field/value/weight results are all combined. For fields where multiple values were present the value with the highest weight ‘wins’ All matchers are with tests placed in yaml files in the UserAgents directory. Because of the system with the weights the order of the matchers is not checked or guaranteed in any way. So if the two matchers may set the same field to a different value then better make sure they have different weights.\nThe anatomy of a matcher A matcher consists of 3 parts require extract options\nThe “require” part holds the patterns that must all result in a non-null value. The IsNull operator is intended to check that a specific value actually IS null. The “extract” part is to send either a fixed string or an extracted pattern into a field with a certain numerical confidence.\nThere are a few possible option flags:\ninit This means the init output for this matcher must be shown. This is the same effect when running it without any extract values verbose This means that a LOT of debug output will be shown in the output. only This means that ONLY this test must be run. No others.\nOnly IFF all require AND all extract patterns yielded a non-null value then will all of the extracted values be added to the end result. In general a field will receive a value from multiple matchers; the value with the highest confidence value will be in the output.\nThe overall structure is this:\n# $schema: https://yauaa.basjes.nl/v1/YauaaConfig.json config: - lookup: name: 'lookupname' map: \"From1\" : \"To1\" \"From2\" : \"To2\" \"From3\" : \"To3\" - set: name: 'setname' merge: - 'nameOtherSet' - 'nameOtherLookup' values: - 'foo' - 'bar' - matcher: options: - 'verbose' variable: - 'VariableName : Extract pattern' - 'VariableName : Extract pattern' require: - 'Require pattern' - 'Require pattern' extract: - 'FieldName : Confidence : Extract pattern' - 'FieldName : Confidence : Extract pattern' - test: options: - 'verbose' - 'init' - 'only' input: user_agent_string: 'Useragent' expected: FieldName1 : 'ExpectedValue1' FieldName2 : 'ExpectedValue2' FieldName3 : 'ExpectedValue3' A require pattern must simply yield a non-null value. The IsNull operator only makes sense in the context of a require as with this you can check that a pattern may not exist.\nFor example to do checks like “The last product in the list must be named foo” you can write this\n- matcher: require: - 'IsNull[agent.product.name=\"foo\"^\u003e]' An extract pattern is either a fixed string “foo” or a path expression as explained later in this document.\nWhere the rules are located Under the main resources there is a folder called UserAgents . In the folder a collection of yaml files are located. Each of those files contains matchers, lookups, tests or any combination of them in any order. This means that in many cases you’ll find a relevant test case close to the rules.\nUseragent parse tree model According to RFC-2616 a useragent consists of set of products. Each with an (optional) version and an (optional) comment block.\nhttps://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.8 https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43\nAfter much analysis the model that this parser uses it as follows:\nThe whole string (the ‘agent’) is mostly cut into ‘product’ and ’text’ parts. Each child node in the tree is numbered (1,2,3,…) within the context of the parent. A product has zero or more ‘version’ fields and zero or more ‘comments’ fields. Each comments’ has one or more ’entry’: In a comment block like this ‘foo/1.0 (one; two three; four)’ we will have 3 entries (they are ; separated).\nFrom there the system recurses down within limitations.\nFlattened form of the tree If we take this useragent as an example the tree is flattened into a set of ‘breadcrumb’ type paths.\nI put some spaces in various places so you can see what happens with those (in most places they are trimmed):\nfoo/1.0 ( one ; two three; four ) bar/2.0 (five;six seven) will result in these paths (with their textual value)\nagent=\"foo/1.0 ( one ; two three; four ) bar/2.0 (five;six seven)\" agent.(1)product=\"foo/1.0 ( one ; two three; four )\" agent.(1)product[1-1]=\"foo\" agent.(1)product[1-2]=\"foo/1\" agent.(1)product[2-2]=\"1\" agent.(1)product[1-3]=\"foo/1.0\" agent.(1)product[3-3]=\"0\" agent.(1)product.(1)name=\"foo\" agent.(1)product.(1)name[1-1]=\"foo\" agent.(1)product.(1)version=\"1.0\" agent.(1)product.(1)version[1-1]=\"1\" agent.(1)product.(1)version[1-2]=\"1.0\" agent.(1)product.(1)version[2-2]=\"0\" agent.(1)product.(1)comments=\"( one ; two three; four )\" agent.(1)product.(1)comments.(1)entry=\"one\" agent.(1)product.(1)comments.(1)entry[1-1]=\"one\" agent.(1)product.(1)comments.(1)entry.(1)text=\"one\" agent.(1)product.(1)comments.(1)entry.(1)text[1-1]=\"one\" agent.(1)product.(1)comments.(2)entry=\"two three\" agent.(1)product.(1)comments.(2)entry[1-1]=\"two\" agent.(1)product.(1)comments.(2)entry[1-2]=\"two three\" agent.(1)product.(1)comments.(2)entry[2-2]=\"three\" agent.(1)product.(1)comments.(2)entry.(1)text=\"two three\" agent.(1)product.(1)comments.(2)entry.(1)text[1-1]=\"two\" agent.(1)product.(1)comments.(2)entry.(1)text[1-2]=\"two three\" agent.(1)product.(1)comments.(2)entry.(1)text[2-2]=\"three\" agent.(1)product.(1)comments.(3)entry=\"four\" agent.(1)product.(1)comments.(3)entry[1-1]=\"four\" agent.(1)product.(1)comments.(3)entry.(1)text=\"four\" agent.(1)product.(1)comments.(3)entry.(1)text[1-1]=\"four\" agent.(2)product=\"bar/2.0 (five;six seven)\" agent.(2)product[1-1]=\"bar\" agent.(2)product[1-2]=\"bar/2\" agent.(2)product[2-2]=\"2\" agent.(2)product[1-3]=\"bar/2.0\" agent.(2)product[3-3]=\"0\" agent.(2)product.(1)name=\"bar\" agent.(2)product.(1)name[1-1]=\"bar\" agent.(2)product.(1)version=\"2.0\" agent.(2)product.(1)version[1-1]=\"2\" agent.(2)product.(1)version[1-2]=\"2.0\" agent.(2)product.(1)version[2-2]=\"0\" agent.(2)product.(1)comments=\"(five;six seven)\" agent.(2)product.(1)comments.(1)entry=\"five\" agent.(2)product.(1)comments.(1)entry[1-1]=\"five\" agent.(2)product.(1)comments.(1)entry.(1)text=\"five\" agent.(2)product.(1)comments.(1)entry.(1)text[1-1]=\"five\" agent.(2)product.(1)comments.(2)entry=\"six seven\" agent.(2)product.(1)comments.(2)entry[1-1]=\"six\" agent.(2)product.(1)comments.(2)entry[1-2]=\"six seven\" agent.(2)product.(1)comments.(2)entry[2-2]=\"seven\" agent.(2)product.(1)comments.(2)entry.(1)text=\"six seven\" agent.(2)product.(1)comments.(2)entry.(1)text[1-1]=\"six\" agent.(2)product.(1)comments.(2)entry.(1)text[1-2]=\"six seven\" agent.(2)product.(1)comments.(2)entry.(1)text[2-2]=\"seven\" As you can see there are a few special operators that allow comparing and extracting specific words.\nWalking around the tree In many cases we want to get the version of the product with a specific name. This means we should look to the product with that name and from there go ‘up’ to the product and from there select the ‘version’.\nFor this purpose a special language has been created that allows walking through a tree from the point where a match was found and do additional compare and string manipulation actions to obtain the value we are looking for.\nThis language also supports lookups (hashmaps) that do a case INsensitive lookup.\nNote that for finding a matching pattern the system will recurse through the parse tree from left to right. The FIRST matching pattern is used for the end result.\nFor demonstrating the operators I’m using this user agent to explain the effects:\nfoo faa/1.0 2.3 (one; two three four) bar baz/2.0 3.0 (five; six seven) Available operators:\nWalking around the tree\nOperation Symbol Example Result value (if applicable) Up to parent ^ agent.(1)product.name^ agent.(1)product Next Sibling \u003e agent.(1)product\u003e agent.(2)product Previous Sibling \u003c agent.(2)product\u003c agent.(1)product Down to child .name agent.(1)product.version Down to specific child .(2)version agent.(1)product.(2)version Down to specific child range .(2-3)version agent.(1)product.(2-3)version Down to specific child range .(2-)version agent.(1)product.(2-)version Down to specific child range .(-5)version agent.(1)product.(-5)version Comparing values in the tree\nOperation Symbol Example Result value (if applicable) Explain Equals = agent.(1)product.version=“2.3” agent.(1)product.(2)version The second version is “2.3” Not equals != agent.(1)product.version!=“1.0” agent.(1)product.(2)version The second version is the first one when backtracking that is not “1.0” Contains ~ agent.product.name~“ar” agent.(2)product.(1)name=“bar baz” The first product name when backtracking that contains “ar” Starts with { agent.product.name{“b” agent.(2)product.(1)name=“bar baz” The first product name when backtracking that starts with “b” Ends with } agent.product.name}“z” agent.(2)product.(1)name=“bar baz” The first product name when backtracking that ends with “z” (Key)set contains ? agent.product.name?mySetOfValues agent.(3)product.(1)name The name of the third product was present in the defined set of values. This set may be a “set” or a “lookup” in the last case only the keys of this lookup will be evaluated (Key)set does NOT contain !? agent.product.name!?mySetOfValues agent.(3)product.(1)name The name of the third product was NOT present in the defined set of values. This set may be a “set” or a “lookup” in the last case only the keys of this lookup will be evaluated Extracting substrings\nNote this fact agent.(1)product.(1)comments.(2)entry.(1)text=“one two three four five”\nOperation Symbol Example Value First N Words [-N] agent.(1)product.(1)comments.(2)entry.(1)text[-3] one two three Single Word at position N [N] agent.(1)product.(1)comments.(2)entry.(1)text[3] three A range of words N-M [N-M] agent.(1)product.(1)comments.(2)entry.(1)text[2-4] two three four All words to the end starting at N [N-] agent.(1)product.(1)comments.(2)entry.(1)text[3-] three four five Back to full value @ agent.(1)product.(1)comments.(2)entry.(1)text[2]=“three” agent.(1)product.(1)comments.(2)entry.(1)text[2]=“three”@ three one two three four five Special operations\nOperation Symbol Example Result value (if applicable) Check if the expresssion resulted in a null ’no match’ value. IsNull[expression] IsNull[agent.(1)product.(3)name] true Return the result or the provided default value in case the expression was a null ’no match’ value. DefaultIfNull[expression;defaultvalue] DefaultIfNull[agent.(1)product.(3)name;“Something”] Cleanup the version from an _ separated to a . separated string CleanVersion[expression] CleanVersion[“1_2_3”] 1.2.3 Is the provided value something that we think can be considered a “Valid Version” IsValidVersion[expression] IsValidVersion[“FooBar”] null Replace every occurrence of a String with another String (fixed text and case sensitive!) ReplaceString[expression;search;replace] ReplaceString[“onefoofootwo”;“foo”;“bar”] onebarbartwo LookUp the value against a lookup table LookUp[lookupname;expression] LookUp[OSNames;agent.product.entry.text] LookUp the value against a lookup table (with fallback in case no match) LookUp[lookupname;expression;defaultvalue] LookUp[OSNames;agent.product.entry.text;“Unknown”] LookUp the value against a lookup table and return the original value if a matching prefix is present. IsInLookUp[lookupname;expression] IsInLookUp[OSNames;agent.product.entry.text] LookUp the lookupname in the lookup table that the value contains LookUpContains[lookupname;expression] LookUpContains[OSNames;agent.product.entry.text] LookUp the lookupname in the lookup table that the value contains (with fallback in case no match) LookUpContains[lookupname;expression;defaultvalue] LookUpContains[OSNames;agent.product.entry.text;“Unknown”] LookUp the lookupname in the lookup table that the value contains and return the original value if a matching prefix is present. IsInLookUpContains[lookupname;expression] IsInLookUpContains[OSNames;agent.product.entry.text] LookUp the lookupname in the lookup table that the value contains and return the original value if a matching prefix is NOT present. IsNotInLookUpContains[lookupname;expression] IsNotInLookUpContains[OSNames;agent.product.entry.text] LookUp the value against a lookup table and return the value where the key is the longest matching prefix of the value. LookUpPrefix[lookupname;expression] LookUpPrefix[OSNames;agent.product.entry.text] LookUp the value against a lookup table and return the value where the key is the longest matching prefix of the value (with fallback in case no match). LookUpPrefix[lookupname;expression;defaultvalue] LookUpPrefix[OSNames;agent.product.entry.text;“Unknown”] LookUp the value against a lookup table and return the value if there is NO matching prefix of the key. LookUpIsNotInPrefix[lookupname;expression] LookUpIsNotInPrefix[OSNames;agent.product.entry.text] LookUp the value against a lookup table and return the original value if a matching prefix is present. IsInLookUpPrefix[lookupname;expression] IsInLookUpPrefix[OSNames;agent.product.entry.text] Put a fixed string before an expression Concat[value;expression] Concat[“Something”;agent.product.entry.text] Put a fixed string after an expression Concat[expression;value] Concat[agent.product.entry.text;“Something”] Surround the expression with both a prefix and a postfix Concat[value;expression;value] Concat[“Something”;agent.product.entry.text;“Something”] Chaining operators An extensive example of walking around to get the right value.\nfoo faa/1.0/2.3 (one; two three four) bar baz/2.0/3.0 (five; six seven) Expression Current path Value agent.product.(1)comments.entry.(1)text[2]=“seven” agent.(2)product.(1)comments.(2)entry.(1)text[2] seven agent.product.(1)comments.entry.(1)text[2]=“seven”^ agent.(2)product.(1)comments.(2)entry six seven agent.product.(1)comments.entry.(1)text[2]=“seven”^^ agent.(2)product.(1)comments (five; six seven) agent.product.(1)comments.entry.(1)text[2]=“seven”^^^ agent.(2)product bar baz/2.0/3.0 (five; six seven) agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c agent.(1)product foo faa/1.0/2.3 (one; two three four) agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name agent.(1)product.(1)name foo faa agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa” agent.(1)product.(1)name foo faa agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^ agent.(1)product foo faa/1.0/2.3 (one; two three four) agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^.comments agent.(1)product.(1)comments (one; two three four) agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^.comments.entry agent.(1)product.(1)comments.(1)entry one agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^.comments.entry.text[2]=“three” agent.(1)product.(1)comments.(2)entry[2] three agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^.comments.entry.text[2]=“three”@ agent.(1)product.(1)comments.(2)entry two three four agent.product.(1)comments.entry.(1)text[2]=“seven”^^^\u003c.name=“foo faa”^.comments.entry.text[2]=“three”@[1] agent.(1)product.(1)comments.(2)entry[1] two Note that the first possible match is returned. If a child sibling or check fails the backtracking continues until the entire parse tree has been examined.\nI created a test that shows all of the debug output of this example: unit test and yaml file\nThis can also be run from the commandline using:\nmvn -Dtest=DocumentationExample -DfailIfNoTests=false test Creating a new rule Assume we got this useragent\nMozilla/5.0 (compatible; Foo/3.1; Bar) and let’s just assume we want to set a field called MinorFooVersion if the minor version of Foo is 1\nTo start we put the agent as a new test in one of the yaml files. If we choose to create a new file make sure is starts with “config:”\n- test: input: user_agent_string: 'Mozilla/5.0 (compatible; Foo/3.1; Bar)' Now we run the unit test “TestPredefinedBrowsers”. On a normal computer this will take only about 1-5 seconds.\nThe output contains all the field values for this useragent in the exact form of a unit test.\nSo once you are happy with the result you can simply copy and past this into the yaml file.\nIn this case is looks something like this:\n- test: # options: # - 'verbose' # - 'init' # - 'only' input: user_agent_string: 'Mozilla/5.0 (compatible; Foo/3.1; Bar)' expected: DeviceClass : 'Unknown' DeviceName : 'Unknown' OperatingSystemClass : 'Unknown' OperatingSystemName : 'Unknown' OperatingSystemVersion : '??' LayoutEngineClass : 'Browser' LayoutEngineName : 'Mozilla' LayoutEngineVersion : '5.0' LayoutEngineVersionMajor : '5' LayoutEngineNameVersion : 'Mozilla 5.0' LayoutEngineNameVersionMajor : 'Mozilla 5' AgentClass : 'Browser' AgentName : 'Foo' AgentVersion : '3.1' AgentVersionMajor : '3' AgentNameVersion : 'Foo 3.1' AgentNameVersionMajor : 'Foo 3' The output also contains all hard checked paths in the tree in the rough form of a matcher.\n- matcher: # options: # - 'verbose' require: # - '__SyntaxError__=\"false\"' # - 'agent=\"Mozilla/5.0 (compatible; Foo/3.1; Bar)\"' # - 'agent.(1)product=\"Mozilla/5.0 (compatible; Foo/3.1; Bar)\"' # - 'agent.(1)product[1-1]=\"Mozilla\"' # - 'agent.(1)product[1-2]=\"Mozilla/5\"' # - 'agent.(1)product[2-2]=\"5\"' # - 'agent.(1)product[1-3]=\"Mozilla/5.0\"' # - 'agent.(1)product[3-3]=\"0\"' # - 'agent.(1)product.(1)name=\"Mozilla\"' # - 'agent.(1)product.(1)name[1-1]=\"Mozilla\"' # - 'agent.(1)product.(1)version=\"5.0\"' # - 'agent.(1)product.(1)version[1-1]=\"5\"' # - 'agent.(1)product.(1)version[1-2]=\"5.0\"' # - 'agent.(1)product.(1)version[2-2]=\"0\"' # - 'agent.(1)product.(1)comments=\"(compatible; Foo/3.1; Bar)\"' # - 'agent.(1)product.(1)comments.(1)entry=\"compatible\"' # - 'agent.(1)product.(1)comments.(1)entry[1-1]=\"compatible\"' # - 'agent.(1)product.(1)comments.(1)entry.(1)text=\"compatible\"' # - 'agent.(1)product.(1)comments.(1)entry.(1)text[1-1]=\"compatible\"' # - 'agent.(1)product.(1)comments.(2)entry=\"Foo/3.1\"' # - 'agent.(1)product.(1)comments.(2)entry[1-1]=\"Foo\"' # - 'agent.(1)product.(1)comments.(2)entry[1-2]=\"Foo/3\"' # - 'agent.(1)product.(1)comments.(2)entry[2-2]=\"3\"' # - 'agent.(1)product.(1)comments.(2)entry[1-3]=\"Foo/3.1\"' # - 'agent.(1)product.(1)comments.(2)entry[3-3]=\"1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product=\"Foo/3.1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product[1-1]=\"Foo\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product[1-2]=\"Foo/3\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product[2-2]=\"3\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product[1-3]=\"Foo/3.1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product[3-3]=\"1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)name=\"Foo\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)name[1-1]=\"Foo\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)version=\"3.1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)version[1-1]=\"3\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)version[1-2]=\"3.1\"' # - 'agent.(1)product.(1)comments.(2)entry.(1)product.(1)version[2-2]=\"1\"' # - 'agent.(1)product.(1)comments.(3)entry=\"Bar\"' # - 'agent.(1)product.(1)comments.(3)entry[1-1]=\"Bar\"' # - 'agent.(1)product.(1)comments.(3)entry.(1)text=\"Bar\"' # - 'agent.(1)product.(1)comments.(3)entry.(1)text[1-1]=\"Bar\"' extract: # - 'DeviceClass : 1:' # - 'DeviceBrand : 1:' # - 'DeviceName : 1:' # - 'OperatingSystemClass : 1:' # - 'OperatingSystemName : 1:' # - 'OperatingSystemVersion: 1:' # - 'LayoutEngineClass : 1:' # - 'LayoutEngineName : 1:' # - 'LayoutEngineVersion : 1:' # - 'AgentClass : 1:' # - 'AgentName : 1:' # - 'AgentVersion : 1:' In our case we are only interested in the second digit of the version of the product named “Foo”\nSo we copy this and make it like this:\n- matcher: extract: - 'MinorFooVersion : 1:agent.(1)product.(1)comments.entry.(1)product.(1)name=\"Foo\"^.version[2]' What this does is that in the first product, in the first set of comments there is at any position an entry that contains as the first element a product who’s name is “Foo” that we go up in the tree and then down to the version of that product and then take the second word.\nNow if we run the unit test again we will see this:\n- test: # options: # - 'verbose' # - 'init' # - 'only' input: user_agent_string: 'Mozilla/5.0 (compatible; Foo/3.1; Bar)' expected: DeviceClass : 'Unknown' DeviceName : 'Unknown' OperatingSystemClass : 'Unknown' OperatingSystemName : 'Unknown' OperatingSystemVersion : '??' LayoutEngineClass : 'Browser' LayoutEngineName : 'Mozilla' LayoutEngineVersion : '5.0' LayoutEngineVersionMajor : '5' LayoutEngineNameVersion : 'Mozilla 5.0' LayoutEngineNameVersionMajor : 'Mozilla 5' AgentClass : 'Browser' AgentName : 'Foo' AgentVersion : '3.1' AgentVersionMajor : '3' AgentNameVersion : 'Foo 3.1' AgentNameVersionMajor : 'Foo 3' MinorFooVersion : '1' As you can see this clearly shows that a new field has been added with the value we wanted.\nIf you want to change or add more rules then simply iterate over the steps until you have the end result you think is good. Then simply copy the end ’test’ into the yaml file and save.\nIf you are detecting a new field or a new value for an existing field then be aware that this may also apply to tests that are already present in the system. For all tests to pass these must be updated also.\nYou can choose to use this in a more “Test Driven Development” model also. Simply run the unit test, copy the ‘raw testcase’ into the yaml file and edit the values to what they should be and work from there.\nIf you run it this way your will get a ‘failed test’ which yields a bit of extra output. For the sake of demo if I simply put this testcase in the yaml file\n- test: input: user_agent_string: 'Mozilla/5.0 (compatible; Foo/3.1; Bar)' expected: AgentClass : 'Browser' AgentName : 'Foo' AgentVersion : '3.1' AgentVersionMajor : '3' AgentNameVersion : 'Foo 3.1' AgentNameVersionMajor : 'Foo 3' MinorFooVersion : '1' This would also show as test output:\n[INFO ] AbstractUserAgentAnalyzerTester : 89: +--------+------------------------------+-------------+---------+------------+------------+ [INFO ] AbstractUserAgentAnalyzerTester : 89: | Result | Field | Actual | Default | Confidence | Expected | [INFO ] AbstractUserAgentAnalyzerTester : 89: +--------+------------------------------+-------------+---------+------------+------------+ [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineClass | Browser | | 3 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineName | Mozilla | | 3 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineVersion | 5.0 | | 3 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineVersionMajor | 5 | | 3 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineNameVersion | Mozilla 5.0 | | 3 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | LayoutEngineNameVersionMajor | Mozilla 5 | | 3 | \u003c\u003cabsent\u003e\u003e | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentClass | Browser | | 10 | | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentName | Foo | | 10 | | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentVersion | 3.1 | | 10 | | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentVersionMajor | 3 | | 10 | | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentNameVersion | Foo 3.1 | | 10 | | [INFO ] AbstractUserAgentAnalyzerTester : 89: | | AgentNameVersionMajor | Foo 3 | | 10 | | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | AgentLanguage | Bavarian | | 500006 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | AgentLanguageCode | bar | | 500006 | \u003c\u003cabsent\u003e\u003e | [ERROR] AbstractUserAgentAnalyzerTester : 109: | -FAIL- | MinorFooVersion | ?? | Default | -1 | 1 | [INFO ] AbstractUserAgentAnalyzerTester : 89: +--------+------------------------------+-------------+---------+------------+------------+ As you can see the system will fail on missing fields, unexpected fields and wrong values.\nIf you create rules that in one of the test cases produce for the same field different values with the same confidence then the test will fail with messages like this:\n- *********************************************************** - *** REALLY IMPORTANT ERRORS IN THE RULESET *** - *** YOU MUST CHANGE THE CONFIDENCE LEVELS OF YOUR RULES *** - *********************************************************** - Found different value for \"OperatingSystemName\" with SAME confidence 10: \"RIM OS\" and \"BlackBerry\" - Found different value for \"OperatingSystemName\" with SAME confidence 10: \"RIM OS\" and \"BlackBerry\" - Found different value for \"OperatingSystemName\" with SAME confidence 10: \"RIM OS\" and \"BlackBerry\" - Found different value for \"OperatingSystemVersion\" with SAME confidence 10: \"RIM OS\" and \"??\" - Found different value for \"OperatingSystemVersion\" with SAME confidence 10: \"RIM OS\" and \"??\" - Found different value for \"OperatingSystemVersion\" with SAME confidence 10: \"RIM OS\" and \"??\" Note that these do not need to be the ‘winning’ value. The existence of the ambiguity is enough to fail.\nThe Known, the Unknown and the faker In most cases an extract will put a value (Mozilla) into a field with a confidence.\nIn addition to this normal case there are two additional cases that need to be covered:\nWe use the special value \u003c\u003c\u003cnull\u003e\u003e\u003e if we do not know the value (i.e. the end result should say Unknown or ??) and we do want the post processing to try and fill the field with an alternative.\nThis is then labeled as Default. Example: We do not know the DeviceBrand and as a fall back the hostname in the URL (if any) is used. We simply use something like Unknown or ?? if we do not know the value (i.e. the end result should say Unknown or ??) and we are sure we do NOT want any post processing to try and find something better.\nThis is then labeled as not Default. Example: We do not know the DeviceBrand because it matched the pattern of a GoogleBot immitator and we do not want to see Google as the brand. Wiping values In some cases a previously defined value needs to be erased with a higher confidence. To achieve this simply set the value to \u003c\u003c\u003cnull\u003e\u003e\u003e\nIn addition there is a way to set all variables to a certain value by setting the special value __Set_ALL_Fields__\nBecause the ordering is defined by the confidence numbers you must make sure the confidence of the new values are at least 1 higher than the confidence of the __Set_ALL_Fields__.\nBoth of these can be combined into\nextract: - '__Set_ALL_Fields__ : 99:\"\u003c\u003c\u003cnull\u003e\u003e\u003e\"' Note that ALL fields with a confidence below 99 will be wiped. So the field values you set in this matcher must all be 1 higher than this or it will wipe itself too.\nPerformance considerations Note that in order to optimize the performance the paths that lead directly to a point in the tree are placed in a hashmap for very fast lookup.\nOnly if all ‘direct paths’ in a matcher are found only then the walking of those rules is attempted.\nSo one of the rules looks like this\n- matcher: require: - 'agent.product.(1)name=\"Chrome\"' - 'LookUp[ChromeLayoutEngineName;agent.product.(1)name=\"Chrome\"^.version[1]]' - 'agent.product.(1)name=\"AppleWebKit\"^.version[1]=\"537\"' - 'agent.product.(1)version[1]=\"537\"' # This is a matching speedup trick extract: - 'LayoutEngineClass : 1000:\"Browser\"' - 'LayoutEngineName : 1000:\"AppleWebKit\"' - 'LayoutEngineVersion : 1000:agent.product.(1)name=\"AppleWebKit\"^.version' The agent.product.(1)version[1]=“537” is found immediately while walking through the parsed tree. So if this one is not present then the other check “Is the version of AppleWebKit equals to 537” and the lookup are not even attempted. These kinds of tricks will speedup parsing.\nVariables There is the option of predefining a value which is then usable by all rules in a matcher.\nA variable is simply a named point in the tree that is found only once and the reused as-is by the other rules within the same matcher. A variable is also always in essence a ‘require’, it must be present for the matcher as a whole to continue. You can only reference a variable by name in a later variable. This is because they are evaluated in the order in which they appear in the definition in the file. The variable name follows a similar pattern as variable names in languages like Java: [a-zA-Z][a-zA-Z0-9]+ When referencing a variable (by means of @name) in an expression you must see it as a point in the tree that happens to have a name.\nThis looks like this:\n- matcher: variable: - 'Chrome : agent.product.(1)name=\"Chrome\"' - 'AppleWebKitVersion : agent.product.(1)name=\"AppleWebKit\"^.version' require: - 'LookUp[ChromeLayoutEngineName;@Chrome^.version[1]]' - '@AppleWebKitVersion[1]=\"537\"' - 'agent.product.(1)version[1]=\"537\"' # This is a matching speedup trick extract: - 'LayoutEngineClass : 1000:\"Browser\"' - 'LayoutEngineName : 1000:\"AppleWebKit\"' - 'LayoutEngineVersion : 1000:@AppleWebKitVersion' Note that the backtracking stops when the variable finds its first match. So when defined like this:\nextract: - 'Something: 1: agent.product.(1)name=\"AppleWebKit\"^.version' it may find after backtracking that the 5th product matches\nagent.(5)product.(1)version Yet when defined like this\nvariable: - 'productname: agent.product.(1)name' extract: - 'Something: 1: @productname=\"AppleWebKit\"^.version' it will stay at the first product and never find the 5th product at all.",
    "description": "Detecting new useragent patterns When you find a useragent for which one or more of the fields are wrong there is the need to change the patterns and rules that are used by this system for classifying these attributes. In order to write rules this first described how the system works and what tools have been created to make writing new rules easier.\nBase problem: They all lie When looking at useragents it is clear that almost all of them include the name of predecessors/competitors with which they are supposed to be compatible with.",
    "tags": [],
    "title": "Making new rules",
    "uri": "/developer/makingnewrules/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "Several external computation systems support the concept of a User Defined Function (UDF). A UDF is simply a way of making functionality (in this case the analysis of useragents) available in such a system.\nFor several systems (tools used within bol.com (where I work)) I have written such a UDF which are all part of this project.\nApache Beam Apache Beam SQL Apache Drill Apache Flink Apache Flink Table/SQL Apache Hive Apache Nifi Apache Pig Commandline usage Elastic LogStash Elasticsearch LogParser Snowflake Snowplow Trino",
    "description": "Several external computation systems support the concept of a User Defined Function (UDF). A UDF is simply a way of making functionality (in this case the analysis of useragents) available in such a system.\nFor several systems (tools used within bol.com (where I work)) I have written such a UDF which are all part of this project.\nApache Beam Apache Beam SQL Apache Drill Apache Flink Apache Flink Table/SQL Apache Hive Apache Nifi Apache Pig Commandline usage Elastic LogStash Elasticsearch LogParser Snowflake Snowplow Trino",
    "tags": [],
    "title": "User Defined Functions",
    "uri": "/udf/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "These pages explain the internals of the system and contains the guidelines on how to extend it with your own rules.\nBuilding from source Base Design Making new rules Shading dependencies Reporting issues",
    "description": "These pages explain the internals of the system and contains the guidelines on how to extend it with your own rules.\nBuilding from source Base Design Making new rules Shading dependencies Reporting issues",
    "tags": [],
    "title": "Development",
    "uri": "/developer/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e What to expect",
    "content": "Privacy Useragents have had a lot of information about the device and the browser in it. This has been so detailed in the past that there were many situations where the useragents could be used for tracking visitors very reliably.\nReducing/Freezing the UserAgent So a few years ago in several browsers projects started to reduce the level of information in the UserAgent. As a direct consequence the analysis results will become less usefull over time as browsers will start taking away more and more information.\nhttps://www.chromium.org/updates/ua-reduction https://www.chromestatus.com/feature/5704553745874944 The (Q1 2022) DRAFT proposal of the User-Agent Client Hints is intended to contain the information needed in a cleaner way.\nhttps://wicg.github.io/ua-client-hints/ https://github.com/WICG/ua-client-hints At this point in time (Q1 2022):\nThis is not a standard yet Not all browsers support this Chromium based browsers support this. Firefox 97 does not. Compatibility Also (as I have written a long time ago in this article) the UserAgents set values to show to websites what they are compatible with.\nIn 2021 several browsers stopped updating the version number of the underlying operating system because of compatibility problems with poorly written websites.\nAlso several browsers are reaching version 100 which makes the version 3 digits; which leads to parsing problems if a website expects a 2 digit version.\nThis has led to some testing flags for website builders like chrome://flags/#force-major-version-to-100\nForce major version to 100 in User-Agent\nForce the Chrome major version in the User-Agent string to 100, which allows testing the 3-digit major version number before the actual M100 release. This flag is only available from M96-M99. – Mac, Windows, Linux, Chrome OS, Android, Fuchsia\nand also chrome://flags/#force-minor-version-to-100\nForce the minor version to 100 in the User-Agent string\nForce the Chrome minor version in the User-Agent string to 100, which allows testing a 3-digit minor version number. Currently, the minor version is always reported as 0, but due to potential breakage with the upcoming major version 100, this flag allows us to test whether setting the major version in the minor version part of the User-Agent string would be an acceptable alternative. If force-major-version-to-100 is set, then this flag has no effect. See crbug.com/1278459 for details. – Mac, Windows, Linux, Chrome OS, Android, Fuchsia\nHold on: They are testing if they can set the major version in the minor version position … to work around broken websites?\nIn Chrome/Edge 99 has actually implemented this flag:\nchrome://flags/#force-major-version-to-minor\nPut major version in minor version position in User-Agent\nLock the Microsoft Edge major version in the User-Agent string to 99, and force the major version number to the minor version position. This flag is a backup plan for unexpected site-compatibility breakage with a three digit major version. – Mac, Windows, Linux, Chrome OS, Android, Fuchsia\nSo you get the effect:\nChrome/99.0.1150.25 = Chrome 99 Chrome/99.123.1150.25 = Chrome 123 Don’t worry: Yauaa actually detects and handles this and reports the correct version.\nThere is no MacOS 11 Both Chromium (=Chrome, Edge, …) and Firefox have frozen the version of MacOS X to 10.15(.7) and as a consequence MacOS 11 … simply does not appear in any of their UserAgents. As a consequence these specific versions are reported as unknown version (??).\nBack ground information:\nAlways 10_15_7 since Chrome 90. Always 10.15 since Firefox 87. There is no Windows 11 in Chromium/Chrome/Edge/… Microsoft has documented here https://docs.microsoft.com/en-us/microsoft-edge/web-platform/how-to-detect-win11\nThere are two approaches for sites to access user agent information:\nUser-Agent strings (legacy). User-Agent Client Hints (recommended). Websites can differentiate between users on Windows 11 and Windows 10 by using User-Agent Client Hints (UA-CH).`\nand\nUser-Agent strings won’t be updated to differentiate between Windows 11 and Windows 10. We don’t recommend using User-Agent strings to retrieve user agent data. Browsers that don’t support User-Agent Client Hints won’t be able to differentiate between Windows 11 and Windows 10.\nAnd thus the Chrome UserAgent on Windows 11 looks like this:\nMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36\nWhich clealy says: Windows 10.0\nThere is no Windows 11 in Firefox Firefox has an explicit issue called Cap the Windows version in the User-Agent to 10.0..\nTheir code comment clearly describes why\nCap the reported Windows version to 10.0. This way, Microsoft doesn’t get to change Web compat-sensitive values without our veto. The compat-sensitivity keeps going up as 10.0 stays as the current value for longer and longer. If the system-reported version ever changes, we’ll be able to take our time to evaluate the Web compat impact instead of having to scamble to react like happened with macOS changing from 10.x to 11.x.",
    "description": "Privacy Useragents have had a lot of information about the device and the browser in it. This has been so detailed in the past that there were many situations where the useragents could be used for tracking visitors very reliably.\nReducing/Freezing the UserAgent So a few years ago in several browsers projects started to reduce the level of information in the UserAgent. As a direct consequence the analysis results will become less usefull over time as browsers will start taking away more and more information.",
    "tags": [],
    "title": "Manipulations",
    "uri": "/expect/manipulations/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Using Yauaa",
    "content": "The system relies heavily on HashMaps to quickly find the rules that need to be fired.\nSome fields only require a handful of rules where others have a lot of them. This means that it depends on the fields that have been requested how many rules are kept in the system and thus how much memory is used to store the rules in. To get an idea of the relative memory impact of the rules needed for a specific field.\nThis table was constructed by running all testcases against the engine where we only request 1 field. Then after forcing a GC in the JVM we retrieve the memory footprint. The DeviceClass field is always extracted and as such can be seen as the baseline against not having this engine running at all.\nBecause most rules determine several fields there is a lot of overlap in the rules used. If you keep all rules we see that version 5.6 uses about 37 MiB of memory for all rules on top of the rules for the DeviceClass (which is always extracted).\nExtracting everything will currently have a memory impact (without caching!) of about 114 MiB\nField Relative Memory usage DeviceClass (required) 90.8 MiB DeviceName 10.0 MiB DeviceBrand 9.1 MiB DeviceCpu 0.7 MiB DeviceCpuBits 0.5 MiB DeviceFirmwareVersion 1.1 MiB DeviceVersion 0.4 MiB OperatingSystemClass 1.2 MiB OperatingSystemName 1.3 MiB OperatingSystemVersion 1.3 MiB OperatingSystemVersionMajor 1.5 MiB OperatingSystemNameVersion 2.0 MiB OperatingSystemNameVersionMajor 2.2 MiB OperatingSystemVersionBuild 0.4 MiB LayoutEngineClass 2.8 MiB LayoutEngineName 2.8 MiB LayoutEngineVersion 2.8 MiB LayoutEngineVersionMajor 3.0 MiB LayoutEngineNameVersion 3.2 MiB LayoutEngineNameVersionMajor 3.4 MiB LayoutEngineBuild 0.6 MiB AgentClass 5.0 MiB AgentName 5.2 MiB AgentVersion 5.1 MiB AgentVersionMajor 5.3 MiB AgentNameVersion 5.7 MiB AgentNameVersionMajor 5.8 MiB AgentBuild 0.5 MiB AgentLanguage 0.4 MiB AgentLanguageCode 0.4 MiB AgentInformationEmail 0.1 MiB AgentInformationUrl 0.1 MiB AgentSecurity 0.2 MiB AgentUuid 0.3 MiB WebviewAppName 1.0 MiB WebviewAppVersion 1.0 MiB WebviewAppVersionMajor 1.0 MiB WebviewAppNameVersionMajor 1.1 MiB FacebookCarrier 0.2 MiB FacebookDeviceClass 0.2 MiB FacebookDeviceName 0.2 MiB FacebookDeviceVersion 0.2 MiB FacebookFBOP 0.2 MiB FacebookFBSS 0.5 MiB FacebookOperatingSystemName 0.5 MiB FacebookOperatingSystemVersion 0.5 MiB Anonymized 0.1 MiB HackerAttackVector 0.1 MiB HackerToolkit 0.1 MiB KoboAffiliate 0.1 MiB KoboPlatformId 0.1 MiB IECompatibilityVersion 0.4 MiB IECompatibilityVersionMajor 0.4 MiB IECompatibilityNameVersion 0.4 MiB IECompatibilityNameVersionMajor 0.4 MiB Carrier 0.2 MiB GSAInstallationID 0.1 MiB NetworkType 0.1 MiB",
    "description": "The system relies heavily on HashMaps to quickly find the rules that need to be fired.\nSome fields only require a handful of rules where others have a lot of them. This means that it depends on the fields that have been requested how many rules are kept in the system and thus how much memory is used to store the rules in. To get an idea of the relative memory impact of the rules needed for a specific field.",
    "tags": [],
    "title": "Memory usage",
    "uri": "/using/memoryusage/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Development",
    "content": "Introduction This is a summary of the reasons WHY I have done the shading in this project the way it is now.\nIf someone has suggestions/hint on how this can be done better I’m really curious what the ‘right’ way of doing this is.\nThe base structure of this project is we have a module with the functionality and a set of ‘UDFs’ that wrap this functionality so that it can be used in external processing frameworks (like Flink, Hive, etc.)\nBase goal This library and the UDFs should be easy to use for all downstream users that want to use this in their projects.\nProblem 1: Problematic dependencies Some of the dependencies (Antlr4, Spring and SnakeYaml) have proven to be problematic for downstream users who need different versions of these in the same application.\nSolution 1: Shade and relocate So for only these we include and relocate the used classes into the main jar.\nIn the pom.xml\n\u003cplugin\u003e \u003cgroupId\u003eorg.apache.maven.plugins\u003c/groupId\u003e \u003cartifactId\u003emaven-shade-plugin\u003c/artifactId\u003e \u003cconfiguration\u003e \u003cminimizeJar\u003etrue\u003c/minimizeJar\u003e \u003ccreateDependencyReducedPom\u003etrue\u003c/createDependencyReducedPom\u003e \u003crelocations\u003e \u003crelocation\u003e \u003cpattern\u003eorg.springframework\u003c/pattern\u003e \u003cshadedPattern\u003enl.basjes.shaded.org.springframework\u003c/shadedPattern\u003e \u003c/relocation\u003e \u003crelocation\u003e \u003cpattern\u003eorg.antlr\u003c/pattern\u003e \u003cshadedPattern\u003enl.basjes.shaded.org.antlr\u003c/shadedPattern\u003e \u003c/relocation\u003e \u003crelocation\u003e \u003cpattern\u003eorg.yaml.snakeyaml\u003c/pattern\u003e \u003cshadedPattern\u003enl.basjes.shaded.org.yaml.snakeyaml\u003c/shadedPattern\u003e \u003c/relocation\u003e \u003c/relocations\u003e \u003c/configuration\u003e \u003cexecutions\u003e \u003cexecution\u003e \u003cid\u003einject-problematic-dependencies\u003c/id\u003e \u003cphase\u003epackage\u003c/phase\u003e \u003cgoals\u003e \u003cgoal\u003eshade\u003c/goal\u003e \u003c/goals\u003e \u003cconfiguration\u003e \u003cartifactSet\u003e \u003cincludes\u003e \u003cinclude\u003eorg.antlr:antlr4-runtime\u003c/include\u003e \u003cinclude\u003eorg.springframework:spring-core\u003c/include\u003e \u003cinclude\u003eorg.yaml:snakeyaml\u003c/include\u003e \u003c/includes\u003e \u003c/artifactSet\u003e \u003c/configuration\u003e \u003c/execution\u003e \u003c/executions\u003e \u003c/plugin\u003e Problem 2: Transitive dependencies Turns out that a shaded jar still contains the original pom.xml that references the shaded dependencies. As a consequence the downstream users (like the udfs in this project) still include the entire set of dependencies (not used by the code) in addition to the shaded versions (used by the code).\nThis is a known problem in the Maven shade plugin: https://issues.apache.org/jira/browse/MSHADE-36\nFor which I’ve put up a pull request: https://github.com/apache/maven-shade-plugin/pull/25\nSolution 2: Inject the dependency-reduced-pom.xml into the final jar This way building an external project no longer includes things like Antlr a second time.\nWith the maven-shade-plugin version 3.3.0 (2022-03-24) this is now a built-in feature:\n\u003cuseDependencyReducedPomInJar\u003etrue\u003c/useDependencyReducedPomInJar\u003e Problem 3: The other modules look at the original pom.xml So after solution 2 it is all fine for external projects using the created jar file because they look at the pom.xml in that jar file.\nThe remaining problem is that any other module in this (multi module) project will look at the original pom.xml instead of the cleaned one in the jar file.\nAs a consequence the Hive UDF jar file contains\n$ unzip -l udfs/hive/target/yauaa-hive-5.12-SNAPSHOT-udf.jar | fgrep org/springframework/core/io/ResourceLoader.class 494 2019-08-23 12:26 nl/basjes/shaded/org/springframework/core/io/ResourceLoader.class 487 2019-02-13 05:32 org/springframework/core/io/ResourceLoader.class I filed a bug report/ missing feature for this in the Maven shade plugin: https://issues.apache.org/jira/browse/MSHADE-326\nFor which I’ve put up a pull request: https://github.com/apache/maven-shade-plugin/pull/26\nSolution 3: Manually exclude them So we exclude these 4 shaded dependencies in all modules in this project so they are no longer included double in the final jars.\nProblem 4: No such classfile … Which gives rise to a new problem: When building/developing these modules the code will complain about missing dependencies. The dependencies have been shaded, relocated and excluded … which means that any code looking for the ‘original’ class name will find it to be missing.\nSolution 4: Include as ‘provided’ The final step I had to take was to include these 4 dependencies again as ‘provided’ in all modules in this project.\nAdditional notes Immediately setting these dependencies to ‘provided’ causes them not to be included by the shade plugin. Using the optional setting on the dependency caused “missing classes” errors in IntelliJ The open issue at the maven/maven-shade-plugin end for problems 3 and 4: https://issues.apache.org/jira/browse/MSHADE-326",
    "description": "Introduction This is a summary of the reasons WHY I have done the shading in this project the way it is now.\nIf someone has suggestions/hint on how this can be done better I’m really curious what the ‘right’ way of doing this is.\nThe base structure of this project is we have a module with the functionality and a set of ‘UDFs’ that wrap this functionality so that it can be used in external processing frameworks (like Flink, Hive, etc.)",
    "tags": [],
    "title": "Shading dependencies",
    "uri": "/developer/shadingdependencies/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Development",
    "content": "Introduction All software has bugs and things that it should do better.\nYauaa is no exception; there are bugs, inaccuracies and there is lots of room for improvement.\nSo if you find something please report it via the issue tracker.\nHowever…\nThese are not bugs I get quite a few bug reports and questions that Yauaa is not extracting the right version number from the provided User-Agent.\nKey thing to know There are so many manipulations and lies in the User-Agents that simply looking at the User-Agent will yield the wrong answer. Yauaa will try to give the best possible answer and some classes of lies are reported as such.\nSo in addition to simply looking at the User-Agent it will also overrule these values if a documented manipulations is detected.\nMost incorrect reports are about a Chromium/Chrome/Edge/… browser that shows ?? as the version of the Operating System but just looking at it you can clearly read a version. The Chromium team have clearly documented that they are removing information from the User-Agent header and replace parts with fixed values that are almost meaningless.\nSee: https://www.chromium.org/updates/ua-reduction/\nFrozen Windows versions Take for example this User-Agent:\nMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.0.0 Safari/537.36 Most people expect to get\nOperatingSystemNameVersion : 'Windows 10.0' AgentNameVersion : 'Chrome 100.0.0.0' but instead they get\nOperatingSystemNameVersion : 'Windows NT ??' AgentNameVersion : 'Chrome 100' and then report that as a bug.\nThis is not a bug.\nThis example was recorded on a Windows 7 system and there is nothing in the User-Agent to extract this anymore.\nFrozen Android version A similar effect is with\nMozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Mobile Safari/537.36 Most people expect to get\nOperatingSystemNameVersion : 'Android 10' but instead they get\nOperatingSystemNameVersion : 'Android ??' Again: This is not a bug.\nThis example was recorded on an Android 11 system and there is nothing in the User-Agent to extract this anymore.\nYour best workaround At this point in time (mid 2022) the best way around much of these manipulations and lies is by asking for and recording the User-Agent Client Hints on your website.\nIf you ask for these User-Agent Client Hints you can get something like these extra request headers in addition to the User-Agent from the browser.\nHeader Value Sec-Ch-Ua \" Not A;Brand\";v=“99”, “Chromium”;v=“100”, “Google Chrome”;v=“100” Sec-Ch-Ua-Arch “x86” Sec-Ch-Ua-Full-Version-List \" Not A;Brand\";v=“99.0.0.0”, “Chromium”;v=“100.0.4896.75”, “Google Chrome”;v=“100.0.4896.75” Sec-Ch-Ua-Mobile ?0 Sec-Ch-Ua-Model \"\" Sec-Ch-Ua-Platform “Windows” Sec-Ch-Ua-Platform-Version “0.1.0” Sec-Ch-Ua-Wow64 ?0 With all of this extra information Yauaa can now correctly report the above mentioned Windows 7 example as:\nOperatingSystemNameVersion : 'Windows 7' AgentNameVersion : 'Chrome 100.0.4896.75'",
    "description": "Introduction All software has bugs and things that it should do better.\nYauaa is no exception; there are bugs, inaccuracies and there is lots of room for improvement.\nSo if you find something please report it via the issue tracker.\nHowever…\nThese are not bugs I get quite a few bug reports and questions that Yauaa is not extracting the right version number from the provided User-Agent.\nKey thing to know There are so many manipulations and lies in the User-Agents that simply looking at the User-Agent will yield the wrong answer. Yauaa will try to give the best possible answer and some classes of lies are reported as such.",
    "tags": [],
    "title": "Reporting issues",
    "uri": "/developer/reportingissues/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e What to expect",
    "content": "You can try it online with your own browser here: https://try.yauaa.basjes.nl/.\nNOTES\nThis runs on a very slow and rate limited machine. If you really like this then run it on your local systems. It’s much faster that way. A Kubernetes ready Docker image is provided. See this page about the WebServlet for more information.",
    "description": "You can try it online with your own browser here: https://try.yauaa.basjes.nl/.\nNOTES\nThis runs on a very slow and rate limited machine. If you really like this then run it on your local systems. It’s much faster that way. A Kubernetes ready Docker image is provided. See this page about the WebServlet for more information.",
    "tags": [],
    "title": "Try it!",
    "uri": "/expect/tryit/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Using Yauaa",
    "content": "Part of the distribution is a war file that is a servlet that has a webinterface and some APIs that allow you to try things out.\nThis servlet can be downloaded via\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-webapp\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003ctype\u003ewar\u003c/type\u003e \u003c/dependency\u003e NOTE that this is a DEMONSTRATION servlet!\nIt is simply the library in a servlet, no optimizations or smart memory settings have been done at all.\nDocker Starting with version 5.14.1 the webservlet is also published to the central docker registry.\nhttps://hub.docker.com/r/nielsbasjes/yauaa So with docker installed and running on your (Linux) desktop you should be able to so something as simple as\ndocker pull nielsbasjes/yauaa:8.0.0 docker run -p8080:8080 nielsbasjes/yauaa:8.0.0 and then open\nhttp://localhost:8080/ in your browser to get the output of the servlet.\nCustom rules The servlet supports loading your own custom rules, which can be useful to classify internal monitoring systems. It does this by looking in the folder that start with UserAgents for yaml files (i.e. file:UserAgents*/*.yaml ).\nBased on the docker image this can be easily done with an additional layer where your entire Dockerfile looks like this\nFROM nielsbasjes/yauaa:8.0.0 ADD InternalTraffic.yaml UserAgents/ When you build that docker image and run it the logging should contain something like this:\nLoading 1 rule files using expression: file:UserAgents*/*.yaml - Preparing InternalTraffic.yaml (9608 bytes) - Loaded 1 files in 11 msec using expression: file:UserAgents*/*.yaml Doing queries REST The webservlet has a set of REST endpoints that allow analyzing the UserAgent headers and there you can select in what kind of format you want the information returned.\nAlthough very useful in many cases it does not support analyzing the User-Agent Client Hints.\nGraphQL Since 7.4.0 the webservlet now also has initial support for GraphQL which also supports analyzing the User-Agent Client Hints.\nBecause Yauaa allows the addition of more analysis rules it is to be expected that the list of fields that can be extracted is changed using configuration.\nThis poses 2 problems:\nThe GraphQl standard does not have the concept of a Map/Hash/Dictionary. The GraphQl library currently used has problems with dynamically creating the Schema (see also: https://github.com/spring-projects/spring-graphql/issues/452 ). Base query The base query for analyzing a User-Agent with everything on it looks like this:\nquery { analyze(requestHeaders: { userAgent : \"Mozilla\\/5.0 (X11; Linux x86_64) AppleWebKit\\/537.36 (KHTML, like Gecko) Chrome\\/103.0.0.0 Safari\\/537.36\" secChUa : \"\\\".Not\\/A)Brand\\\";v=\\\"99\\\", \\\"Google Chrome\\\";v=\\\"103\\\", \\\"Chromium\\\";v=\\\"103\\\"\" secChUaArch : \"\\\"x86\\\"\" secChUaBitness : \"\\\"64\\\"\" secChUaFullVersion : \"\\\"103.0.5060.134\\\"\" secChUaFullVersionList : \"\\\".Not\\/A)Brand\\\";v=\\\"99.0.0.0\\\", \\\"Google Chrome\\\";v=\\\"103.0.5060.134\\\", \\\"Chromium\\\";v=\\\"103.0.5060.134\\\"\" secChUaMobile : \"?0\" secChUaModel : \"\\\"\\\"\" secChUaPlatform : \"\\\"Linux\\\"\" secChUaPlatformVersion : \"\\\"5.13.0\\\"\" secChUaWoW64 : \"?0\" }) { deviceClass deviceName deviceBrand deviceCpu deviceCpuBits deviceFirmwareVersion deviceVersion operatingSystemClass operatingSystemName operatingSystemVersion operatingSystemVersionMajor operatingSystemNameVersion operatingSystemNameVersionMajor layoutEngineClass layoutEngineName layoutEngineVersion layoutEngineVersionMajor layoutEngineNameVersion layoutEngineNameVersionMajor agentClass agentName agentVersion agentVersionMajor agentNameVersion agentNameVersionMajor remarkablePattern } } which results in\n{ \"data\": { \"analyze\": { \"deviceClass\": \"Desktop\", \"deviceName\": \"Linux Desktop\", \"deviceBrand\": \"Unknown\", \"deviceCpu\": \"Intel x86_64\", \"deviceCpuBits\": \"64\", \"operatingSystemClass\": \"Desktop\", \"operatingSystemName\": \"Linux\", \"operatingSystemVersion\": \"5.13.0\", \"operatingSystemVersionMajor\": \"5\", \"operatingSystemNameVersion\": \"Linux 5.13.0\", \"operatingSystemNameVersionMajor\": \"Linux 5\", \"layoutEngineClass\": \"Browser\", \"layoutEngineName\": \"Blink\", \"layoutEngineVersion\": \"103.0\", \"layoutEngineVersionMajor\": \"103\", \"layoutEngineNameVersion\": \"Blink 103.0\", \"layoutEngineNameVersionMajor\": \"Blink 103\", \"agentClass\": \"Browser\", \"agentName\": \"Chrome\", \"agentVersion\": \"103.0.5060.134\", \"agentVersionMajor\": \"103\", \"agentNameVersion\": \"Chrome 103.0.5060.134\", \"agentNameVersionMajor\": \"Chrome 103\", \"remarkablePattern\": \"Unknown\" } } } Accessing all (including custom) fields To get to all the other fields you can simply ask for all of them:\n{ analyze(requestHeaders: { userAgent: \"TestApplication/1.2.3 (node123.datacenter.example.nl; 1234; d71922715c2bfe29343644b14a4731bf5690e66e)\" }) { allFields:fields{ fieldName value } } } gives (summary, not entire list):\n{ \"data\": { \"analyze\": { \"allFields\": [ { \"fieldName\": \"AgentClass\", \"value\": \"Special\" }, { \"fieldName\": \"AgentInformationEmail\", \"value\": \"Unknown\" }, { \"fieldName\": \"AgentInformationUrl\", \"value\": \"node123.datacenter.example.nl\" }, { \"fieldName\": \"AgentName\", \"value\": \"TestApplication\" }, { \"fieldName\": \"AgentNameVersion\", \"value\": \"TestApplication 1.2.3\" }, ... } } } Accessing some (including custom) fields { analyze(requestHeaders: { userAgent: \"TestApplication/1.2.3 (node123.datacenter.example.nl; 1234; d71922715c2bfe29343644b14a4731bf5690e66e)\" }) { someFields:fields(fieldNames: [ \"DeviceClass\", \"AgentName\", \"ApplicationName\" , \"ApplicationVersion\", \"ApplicationInstance\", \"ApplicationGitCommit\", \"ServerName\"]){ fieldName value } } } gives\n{ \"data\": { \"analyze\": { \"someFields\": [ { \"fieldName\": \"DeviceClass\", \"value\": \"Robot\" }, { \"fieldName\": \"AgentName\", \"value\": \"TestApplication\" }, { \"fieldName\": \"ApplicationName\", \"value\": \"TestApplication\" }, { \"fieldName\": \"ApplicationVersion\", \"value\": \"1.2.3\" }, { \"fieldName\": \"ApplicationInstance\", \"value\": \"1234\" }, { \"fieldName\": \"ApplicationGitCommit\", \"value\": \"d71922715c2bfe29343644b14a4731bf5690e66e\" }, { \"fieldName\": \"ServerName\", \"value\": \"node123.datacenter.example.nl\" } ] } } } Accessing individual (including custom) fields { analyze(requestHeaders: { userAgent: \"TestApplication/1.2.3 (node123.datacenter.example.nl; 1234; d71922715c2bfe29343644b14a4731bf5690e66e)\" }) { DeviceClass: field(fieldName: \"DeviceClass\") { value } AgentName: field(fieldName: \"AgentName\") { value } ApplicationName: field(fieldName: \"ApplicationName\") { value } ApplicationVersion: field(fieldName: \"ApplicationVersion\") { value } ApplicationInstance: field(fieldName: \"ApplicationInstance\") { value } ApplicationGitCommit: field(fieldName: \"ApplicationGitCommit\") { value } ServerName: field(fieldName: \"ServerName\") { value } } } gives\n{ \"data\": { \"analyze\": { \"DeviceClass\": { \"value\": \"Robot\" }, \"AgentName\": { \"value\": \"TestApplication\" }, \"ApplicationName\": { \"value\": \"TestApplication\" }, \"ApplicationVersion\": { \"value\": \"1.2.3\" }, \"ApplicationInstance\": { \"value\": \"1234\" }, \"ApplicationGitCommit\": { \"value\": \"d71922715c2bfe29343644b14a4731bf5690e66e\" }, \"ServerName\": { \"value\": \"node123.datacenter.example.nl\" } } } } Version information { version { gitCommitId gitCommitIdDescribeShort buildTimeStamp projectVersion copyright license url targetJREVersion } } gives\n{ \"data\": { \"version\": { \"gitCommitId\": \"19e651d9c5a364f8aa8630c47420f47e4b0bcadb\", \"gitCommitIdDescribeShort\": \"v7.3.0-63-dirty\", \"buildTimeStamp\": \"2022-08-01T14:45:59Z\", \"projectVersion\": \"7.3.1-SNAPSHOT\", \"copyright\": \"Copyright (C) 2013-2026 Niels Basjes\", \"license\": \"License Apache 2.0\", \"url\": \"https://yauaa.basjes.nl\", \"targetJREVersion\": \"1.8\" } } }",
    "description": "Part of the distribution is a war file that is a servlet that has a webinterface and some APIs that allow you to try things out.\nThis servlet can be downloaded via\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-webapp\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003ctype\u003ewar\u003c/type\u003e \u003c/dependency\u003e NOTE that this is a DEMONSTRATION servlet!\nIt is simply the library in a servlet, no optimizations or smart memory settings have been done at all.\nDocker Starting with version 5.14.1 the webservlet is also published to the central docker registry.",
    "tags": [],
    "title": "The demonstration webservlet",
    "uri": "/using/webservlet/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Using Yauaa",
    "content": "I’ve been playing around with Kubernetes and the code below “works on my cluster”.\nBasic Service First create a dedicated namespace and a very basic deployment to run this image 3 times and exposes it as a Service that simply does http.\napiVersion: v1 kind: Namespace metadata: name: yauaa --- apiVersion: apps/v1 kind: Deployment metadata: name: yauaa namespace: yauaa spec: selector: matchLabels: app: yauaa replicas: 3 template: metadata: labels: app: yauaa spec: containers: - name: yauaa image: nielsbasjes/yauaa:8.0.0 ports: - containerPort: 8080 name: yauaa protocol: TCP livenessProbe: httpGet: path: /liveness port: yauaa initialDelaySeconds: 2 periodSeconds: 3 readinessProbe: httpGet: path: /readiness port: yauaa initialDelaySeconds: 10 periodSeconds: 10 --- apiVersion: v1 kind: Service metadata: name: yauaa namespace: yauaa spec: selector: app: yauaa ports: - name: default protocol: TCP port: 80 targetPort: 8080 type: ClusterIP Custom rules in Kubernetes In some cases you’ll have internal systems with custom useragents. You can write your own rules and include them in the deployment.\nFirst define your rules and store them as a configmap in k8s.\nYou can do this by putting the config files in a folder ‘foo’ and doing something like: kubectl create -n yauaa configmap niels-yauaa-rules --from-file=foo\nOr you can include them directly in the kubectl config file like this:\napiVersion: v1 kind: ConfigMap metadata: name: niels-yauaa-rules namespace: yauaa data: MyCustomRules.yaml: | config: - matcher: require: - 'agent.product.name=\"NielsBasjes\"' extract: - 'CustomRuleDemonstrationName : 42 :\"A Simple demonstration of a custom rule\"' - 'CustomRuleDemonstrationWebsite : 42 :\"https://yauaa.basjes.nl\"' - test: input: user_agent_string: 'NielsBasjes/42 (https://niels.basjes.nl)' expected: DeviceClass : 'Robot' DeviceName : 'Basjes Robot' DeviceBrand : 'Basjes' OperatingSystemClass : 'Cloud' OperatingSystemName : 'Cloud' OperatingSystemVersion : '??' OperatingSystemVersionMajor : '??' OperatingSystemNameVersion : 'Cloud ??' OperatingSystemNameVersionMajor : 'Cloud ??' LayoutEngineClass : 'Unknown' LayoutEngineName : 'Unknown' LayoutEngineVersion : '??' LayoutEngineVersionMajor : '??' LayoutEngineNameVersion : 'Unknown ??' LayoutEngineNameVersionMajor : 'Unknown ??' AgentClass : 'Special' AgentName : 'NielsBasjes' AgentVersion : '42' AgentVersionMajor : '42' AgentNameVersion : 'NielsBasjes 42' AgentNameVersionMajor : 'NielsBasjes 42' AgentInformationUrl : 'https://niels.basjes.nl' CustomRuleDemonstrationName : 'A Simple demonstration of a custom rule' CustomRuleDemonstrationWebsite : 'https://yauaa.basjes.nl' Then the deployment must turn this config map into a volume and mount it in the pods. Note that the folder under which it is mounted must be at the root level and the name must start with “UserAgent”.\nSo the deployment becomes something like this\napiVersion: apps/v1 kind: Deployment metadata: name: yauaa namespace: yauaa spec: selector: matchLabels: app: yauaa replicas: 3 template: metadata: labels: app: yauaa spec: volumes: - name: niels-yauaa-rules-volume configMap: name: niels-yauaa-rules containers: - name: yauaa image: nielsbasjes/yauaa:8.0.0 volumeMounts: - name: niels-yauaa-rules-volume # NOTE 1: The directory name MUST start with \"/UserAgents\" !! # NOTE 2: It MUST be exactly 1 subdirectory deep (i.e. no multi level deep) # NOTE 3: You can have multiple as long as the mountPaths are all different. mountPath: /UserAgents-Niels ports: - containerPort: 8080 name: yauaa protocol: TCP livenessProbe: httpGet: path: /liveness port: yauaa initialDelaySeconds: 2 periodSeconds: 3 readinessProbe: httpGet: path: /readiness port: yauaa initialDelaySeconds: 10 periodSeconds: 10 Available outside the cluster (HTTP) Depending on your Kubernetes cluster you may have the option to change the .spec.type of the above Service to LoadBalancer or you may choose to expose it via an Ingress.\nI have been able to get it working with the helm chart for stable/nginx-ingress where I have enabled SSL.\nSimply putting up an Ingress works something like this\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: yauaa namespace: yauaa annotations: kubernetes.io/ingress.class: nginx spec: rules: - host: yauaa.example.nl http: paths: - path: / pathType: Prefix backend: service: name: yauaa port: number: 80 Available outside the cluster (HTTPS) Now I wanted to use https:// instead of http://.\nBefore you can start this you need the SSL (TLS actually) certificate and key for the hostname you have.\nI created the required secret (in the correct namespace) with a command similar to this (I have letsencrypt):\nkubectl -n yauaa create secret tls yauaa-cert --key=/etc/letsencrypt/live/example.nl/privkey.pem --cert=/etc/letsencrypt/live/example.nl/fullchain.pem After the secret has been put into place the Ingress can be created with SSL (official K8S documentation on this).\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: yauaa namespace: yauaa annotations: kubernetes.io/ingress.class: nginx nginx.ingress.kubernetes.io/force-ssl-redirect: \"true\" spec: tls: - hosts: - yauaa.example.nl secretName: yauaa-cert rules: - host: yauaa.example.nl http: paths: - path: / pathType: Prefix backend: service: name: yauaa port: number: 80",
    "description": "I’ve been playing around with Kubernetes and the code below “works on my cluster”.\nBasic Service First create a dedicated namespace and a very basic deployment to run this image 3 times and exposes it as a Service that simply does http.\napiVersion: v1 kind: Namespace metadata: name: yauaa --- apiVersion: apps/v1 kind: Deployment metadata: name: yauaa namespace: yauaa spec: selector: matchLabels: app: yauaa replicas: 3 template: metadata: labels: app: yauaa spec: containers: - name: yauaa image: nielsbasjes/yauaa:8.0.0 ports: - containerPort: 8080 name: yauaa protocol: TCP livenessProbe: httpGet: path: /liveness port: yauaa initialDelaySeconds: 2 periodSeconds: 3 readinessProbe: httpGet: path: /readiness port: yauaa initialDelaySeconds: 10 periodSeconds: 10 --- apiVersion: v1 kind: Service metadata: name: yauaa namespace: yauaa spec: selector: app: yauaa ports: - name: default protocol: TCP port: 80 targetPort: 8080 type: ClusterIP Custom rules in Kubernetes In some cases you’ll have internal systems with custom useragents. You can write your own rules and include them in the deployment.",
    "tags": [],
    "title": "Kubernetes",
    "uri": "/using/kubernetes/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e Using Yauaa",
    "content": "Apache License Version 2.0, January 2004 https://www.apache.org/licenses/\nTERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION Definitions. License shall mean the terms and conditions for use, reproduction, and distribution as defined by Sections 1 through 9 of this document.\nLicensor shall mean the copyright owner or entity authorized by the copyright owner that is granting the License.\nLegal Entity shall mean the union of the acting entity and all other entities that control, are controlled by, or are under common control with that entity. For the purposes of this definition, control means (i) the power, direct or indirect, to cause the direction or management of such entity, whether by contract or otherwise, or (ii) ownership of fifty percent (50%) or more of the outstanding shares, or (iii) beneficial ownership of such entity.\nYou (or Your) shall mean an individual or Legal Entity exercising permissions granted by this License.\nSource form shall mean the preferred form for making modifications, including but not limited to software source code, documentation source, and configuration files.\nObject form shall mean any form resulting from mechanical transformation or translation of a Source form, including but not limited to compiled object code, generated documentation, and conversions to other media types.\nWork shall mean the work of authorship, whether in Source or Object form, made available under the License, as indicated by a copyright notice that is included in or attached to the work (an example is provided in the Appendix below).\nDerivative Works shall mean any work, whether in Source or Object form, that is based on (or derived from) the Work and for which the editorial revisions, annotations, elaborations, or other modifications represent, as a whole, an original work of authorship. For the purposes of this License, Derivative Works shall not include works that remain separable from, or merely link (or bind by name) to the interfaces of, the Work and Derivative Works thereof.\nContribution shall mean any work of authorship, including the original version of the Work and any modifications or additions to that Work or Derivative Works thereof, that is intentionally submitted to Licensor for inclusion in the Work by the copyright owner or by an individual or Legal Entity authorized to submit on behalf of the copyright owner. For the purposes of this definition, submitted means any form of electronic, verbal, or written communication sent to the Licensor or its representatives, including but not limited to communication on electronic mailing lists, source code control systems, and issue tracking systems that are managed by, or on behalf of, the Licensor for the purpose of discussing and improving the Work, but excluding communication that is conspicuously marked or otherwise designated in writing by the copyright owner as Not a Contribution.\nContributor shall mean Licensor and any individual or Legal Entity on behalf of whom a Contribution has been received by Licensor and subsequently incorporated within the Work.\nGrant of Copyright License. Subject to the terms and conditions of this License, each Contributor hereby grants to You a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare Derivative Works of, publicly display, publicly perform, sublicense, and distribute the Work and such Derivative Works in Source or Object form.\nGrant of Patent License. Subject to the terms and conditions of this License, each Contributor hereby grants to You a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable (except as stated in this section) patent license to make, have made, use, offer to sell, sell, import, and otherwise transfer the Work, where such license applies only to those patent claims licensable by such Contributor that are necessarily infringed by their Contribution(s) alone or by combination of their Contribution(s) with the Work to which such Contribution(s) was submitted. If You institute patent litigation against any entity (including a cross-claim or counterclaim in a lawsuit) alleging that the Work or a Contribution incorporated within the Work constitutes direct or contributory patent infringement, then any patent licenses granted to You under this License for that Work shall terminate as of the date such litigation is filed.\nRedistribution. You may reproduce and distribute copies of the Work or Derivative Works thereof in any medium, with or without modifications, and in Source or Object form, provided that You meet the following conditions:\n(a) You must give any other recipients of the Work or Derivative Works a copy of this License; and\n(b) You must cause any modified files to carry prominent notices stating that You changed the files; and\n(c) You must retain, in the Source form of any Derivative Works that You distribute, all copyright, patent, trademark, and attribution notices from the Source form of the Work, excluding those notices that do not pertain to any part of the Derivative Works; and\n(d) If the Work includes a “NOTICE” text file as part of its distribution, then any Derivative Works that You distribute must include a readable copy of the attribution notices contained within such NOTICE file, excluding those notices that do not pertain to any part of the Derivative Works, in at least one of the following places: within a NOTICE text file distributed as part of the Derivative Works; within the Source form or documentation, if provided along with the Derivative Works; or, within a display generated by the Derivative Works, if and wherever such third-party notices normally appear. The contents of the NOTICE file are for informational purposes only and do not modify the License. You may add Your own attribution notices within Derivative Works that You distribute, alongside or as an addendum to the NOTICE text from the Work, provided that such additional attribution notices cannot be construed as modifying the License.\nYou may add Your own copyright statement to Your modifications and may provide additional or different license terms and conditions for use, reproduction, or distribution of Your modifications, or for any such Derivative Works as a whole, provided Your use, reproduction, and distribution of the Work otherwise complies with the conditions stated in this License.\nSubmission of Contributions. Unless You explicitly state otherwise, any Contribution intentionally submitted for inclusion in the Work by You to the Licensor shall be under the terms and conditions of this License, without any additional terms or conditions. Notwithstanding the above, nothing herein shall supersede or modify the terms of any separate license agreement you may have executed with Licensor regarding such Contributions.\nTrademarks. This License does not grant permission to use the trade names, trademarks, service marks, or product names of the Licensor, except as required for reasonable and customary use in describing the origin of the Work and reproducing the content of the NOTICE file.\nDisclaimer of Warranty. Unless required by applicable law or agreed to in writing, Licensor provides the Work (and each Contributor provides its Contributions) on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied, including, without limitation, any warranties or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A PARTICULAR PURPOSE. You are solely responsible for determining the appropriateness of using or redistributing the Work and assume any risks associated with Your exercise of permissions under this License.\nLimitation of Liability. In no event and under no legal theory, whether in tort (including negligence), contract, or otherwise, unless required by applicable law (such as deliberate and grossly negligent acts) or agreed to in writing, shall any Contributor be liable to You for damages, including any direct, indirect, special, incidental, or consequential damages of any character arising as a result of this License or out of the use or inability to use the Work (including but not limited to damages for loss of goodwill, work stoppage, computer failure or malfunction, or any and all other commercial damages or losses), even if such Contributor has been advised of the possibility of such damages.\nAccepting Warranty or Additional Liability. While redistributing the Work or Derivative Works thereof, You may choose to offer, and charge a fee for, acceptance of support, warranty, indemnity, or other liability obligations and/or rights consistent with this License. However, in accepting such obligations, You may act only on Your own behalf and on Your sole responsibility, not on behalf of any other Contributor, and only if You agree to indemnify, defend, and hold each Contributor harmless for any liability incurred by, or claims asserted against, such Contributor by reason of your accepting any such warranty or additional liability.\nEND OF TERMS AND CONDITIONS APPENDIX: How to apply the Apache License to your work. To apply the Apache License to your work, attach the following boilerplate notice, with the fields enclosed by brackets “[]” replaced with your own identifying information. (Don’t include the brackets!) The text should be enclosed in the appropriate comment syntax for the file format. We also recommend that a file or class name and description of purpose be included on the same “printed page” as the copyright notice for easier identification within third-party archives.\nCopyright [yyyy] [name of copyright owner] Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at https://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.",
    "description": "Apache License Version 2.0, January 2004 https://www.apache.org/licenses/\nTERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION Definitions. License shall mean the terms and conditions for use, reproduction, and distribution as defined by Sections 1 through 9 of this document.\nLicensor shall mean the copyright owner or entity authorized by the copyright owner that is granting the License.\nLegal Entity shall mean the union of the acting entity and all other entities that control, are controlled by, or are under common control with that entity. For the purposes of this definition, control means (i) the power, direct or indirect, to cause the direction or management of such entity, whether by contract or otherwise, or (ii) ownership of fifty percent (50%) or more of the outstanding shares, or (iii) beneficial ownership of such entity.",
    "tags": [],
    "title": "Licence",
    "uri": "/using/license/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "Blogpost Related projects",
    "description": "Blogpost Related projects",
    "tags": [],
    "title": "Other",
    "uri": "/other/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Beam\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-beam\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Usage Assume you have a PCollection with your records. In most cases I see (clickstream data) these records (In this example this class is called “TestRecord”) contain the useragent string in a field and the parsed results must be added to these fields.\nNow you must do two things:\nDetermine the names of the fields you need. Add an instance of the (abstract) UserAgentAnalysisDoFn function and implement the functions as shown in the example below. Use the YauaaField annotation to get the setter for the requested fields. Note that the name of the setters is not important, the system looks at the annotation.\nExample: Only User-Agent .apply(\"Extract Elements from Useragent and Client Hints\", ParDo.of(new UserAgentAnalysisDoFn\u003cTestRecord\u003e(15000) { // Setting the cacheSize @Override public String getUserAgentString(TestRecord record) { return record.useragent; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"OperatingSystemNameVersion\") public void setOSNV(TestRecord record, String value) { record.operatingSystemNameVersion = value; } }) ) Example: User-Agent Client Hints The only difference with the “Only User-Agent” implementation is that the getRequestHeaders is overridden. The resulting map should have the original request header names as keys and the actual header value as the value.\nTo illustrate:\nMap\u003cString, String\u003e requestHeaders = new TreeMap\u003c\u003e(); requestHeaders.put(\"User-Agent\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.0.0 Safari/537.36\"); requestHeaders.put(\"Sec-Ch-Ua\", \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Arch\", \"\\\"x86\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Full-Version-List\", \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.75\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.75\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Mobile\", \"?0\"); requestHeaders.put(\"Sec-Ch-Ua-Model\", \"\\\"\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform\", \"\\\"Windows\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform-Version\", \"\\\"0.1.0\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Wow64\", \"?0\"); Using the analyzer whould then be something like this:\n.apply(\"Extract Elements from Useragent and Client Hints\", ParDo.of(new UserAgentAnalysisDoFn\u003cTestRecord\u003e(15000) { // Setting the cacheSize @Override public Map\u003cString, String\u003e getRequestHeaders(TestRecord element) { return element.getHeaders(); } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"OperatingSystemNameVersion\") public void setOSNV(TestRecord record, String value) { record.operatingSystemNameVersion = value; } }) ) Immutable instances in Apache Beam Apache Beam requires a DoFn to never modify the provided instance and to always return a new instance that is then passed to the next processing step. To handle this in a generic way UserAgentAnalysisDoFn has a “clone” method that does this by means of doing a round trip through serialization. If you can do a more efficient way for your specific class then please override the clone method.\nNOTES on defining it as an anonymous class An anonymous inner class in Java is by default private.\nIf you define it as an anonymous inner class as shown above then the system will try to make this class to become public by means of the method .setAccessible(true). There are situations in which this will fail (amongst others the SecurityManager can block this). If you run into such a scenario then simply ’not’ define it inline as an anonymous class and define it as a named (public) class instead.\nSo the earlier example will look something like this:\npublic class MyUserAgentAnalysisDoFn extends UserAgentAnalysisDoFn\u003cTestRecord\u003e { @Override public String getUserAgentString(TestRecord record) { return record.useragent; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } } and then in the topology simply do this\n.apply(\"Extract Elements from Useragent\", ParDo.of(new MyUserAgentAnalysisDoFn()));",
    "description": "Introduction This is a User Defined Function for Apache Beam\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-beam\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Usage Assume you have a PCollection with your records. In most cases I see (clickstream data) these records (In this example this class is called “TestRecord”) contain the useragent string in a field and the parsed results must be added to these fields.",
    "tags": [],
    "title": "Apache Beam",
    "uri": "/udf/apache-beam/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Beam SQL.\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-beam-sql\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Available functions Getting a single value To get a single value from the parse result use this one:\nParseUserAgentField(userAgent, 'DeviceClass') AS deviceClassField to give\nPhone Getting several values as a Map (requires Apache Beam 2.30.0 or newer) You can ask for all fields and return the full map with all of them in there.\nParseUserAgent(userAgent) AS allFields If you want to make use of the support for the User-Agent Client Hints you must call the function from your SQL with a list of header name and value. The header names must be the same as what a browser would send to the webserver (see: Specification).\nEssentially two forms are now possible:\nParseUserAgent ( \u003cuseragent\u003e , [\u003cheader name\u003e,\u003cvalue\u003e]+ ) and the variant which requires the presense of a User-Agent header.\nParseUserAgent ( [\u003cheader name\u003e,\u003cvalue\u003e]+ ) For example:\nParseUserAgent( 'User-Agent', useragent, 'Sec-CH-UA-Platform', chPlatform, 'Sec-CH-UA-Platform-Version', chPlatformVersion ) AS parsedUseragent If you need multiple fields but not all of them you can ask for only those specific fields:\nParseUserAgent(userAgent, 'DeviceClass', 'AgentNameVersion') AS someFields With such a map you can then extract the field you really need with SQL syntax similar to this:\nParseUserAgent(userAgent, 'DeviceClass')['DeviceClass'] AS deviceClass ParseUserAgent(userAgent)['AgentNameVersion'] AS agentNameVersion Because a Beam SQL UDF cannot have a constructor there is no performance gain from limiting the required fields during the analysis phase. It does make the returned set smaller and thus in terms of transport and serialization a bit faster.\nIf you als want the client hints all of these parameters can be combined like this:\nParseUserAgent( 'user-Agent', userAgent, 'sec-CH-UA-Platform', chPlatform, 'sec-CH-UA-Platform-Version', chPlatformVersion 'DeviceClass', 'AgentNameVersionMajor', 'OperatingSystemNameVersion', ) which is equivalent to (i.e. the ordering of the “wanted fields” and the “request headers with value” can be shuffled):\nParseUserAgent( 'DeviceClass', 'user-Agent', userAgent, 'AgentNameVersionMajor', 'sec-CH-UA-Platform', chPlatform, 'OperatingSystemNameVersion', 'sec-CH-UA-Platform-Version', chPlatformVersion ) Getting several values as JSon Assuming the input\nMozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36 To parse this input value into all possible values and returns the complete result as a single JSon string use this:\nParseUserAgentJson(userAgent) to give (single line)\n{\"Useragent\":\"Mozilla\\/5.0 (Linux; Android 7.0; Nexus 6 Build\\/NBD90Z) AppleWebKit\\/537.36 (KHTML, like Gecko) Chrome\\/53.0.2785.124 Mobile Safari\\/537.36\", \"DeviceClass\":\"Phone\",\"DeviceName\":\"Google Nexus 6\",\"DeviceBrand\":\"Google\", \"OperatingSystemClass\":\"Mobile\",\"OperatingSystemName\":\"Android\",\"OperatingSystemVersion\":\"7.0\",\"OperatingSystemVersionMajor\":\"7\",\"OperatingSystemNameVersion\":\"Android 7.0\",\"OperatingSystemNameVersionMajor\":\"Android 7\",\"OperatingSystemVersionBuild\":\"NBD90Z\", \"LayoutEngineClass\":\"Browser\",\"LayoutEngineName\":\"Blink\",\"LayoutEngineVersion\":\"53.0\",\"LayoutEngineVersionMajor\":\"53\",\"LayoutEngineNameVersion\":\"Blink 53.0\",\"LayoutEngineNameVersionMajor\":\"Blink 53\", \"AgentClass\":\"Browser\",\"AgentName\":\"Chrome\",\"AgentVersion\":\"53.0.2785.124\",\"AgentVersionMajor\":\"53\",\"AgentNameVersion\":\"Chrome 53.0.2785.124\",\"AgentNameVersionMajor\":\"Chrome 53\"} To get a JSon with only specific fields you can do (up to 10 fields van be requested this way)\nParseUserAgentJson(userAgent, 'DeviceClass', 'AgentNameVersion') to give\n{\"DeviceClass\":\"Phone\",\"AgentNameVersion\":\"Chrome 53.0.2785.124\"} Note that the Client Hints model also applies here so this works too:\nParseUserAgentJson( 'DeviceClass', 'user-Agent', userAgent, 'AgentNameVersionMajor', 'sec-CH-UA-Platform', chPlatform, 'OperatingSystemNameVersion', 'sec-CH-UA-Platform-Version', chPlatformVersion ) Example usage Assume you have a PCollection with your records.\nPCollection\u003cRow\u003e input = ... You can then put that through an SQL statement to transform it. You have to name the input (in this example we call it InputStream), and you have to register the UDF classes you want to use with the name you want to have in your SQL statement.\nPCollection\u003cRow\u003e result = // This way we give a name to the input stream for use in the SQL PCollectionTuple.of(\"InputStream\", input) // Apply the SQL with the UDFs we need. .apply(\"Execute SQL\", SqlTransform .query( \"SELECT\" + \" userAgent AS userAgent, \" + \" ParseUserAgent(userAgent, 'DeviceClass', 'AgentNameVersion') AS parsedUserAgentMap, \" + \" ParseUserAgentJson(userAgent) AS parsedUserAgentJson, \" + \" ParseUserAgentField(userAgent, 'DeviceClass') AS deviceClass, \" + \" ParseUserAgentField(userAgent, 'AgentNameVersion') AS agentNameVersion \" + \"FROM InputStream\") .registerUdf(\"ParseUserAgent\", ParseUserAgent.class) .registerUdf(\"ParseUserAgentJson\", ParseUserAgentJson.class) .registerUdf(\"ParseUserAgentField\", ParseUserAgentField.class) ); Limitations / Future The ParseUserAgent and ParseUserAgentJson have a limitation of at most 10 fieldnames because Calcite does not yet support variable arguments for UDFs. If you need more than 10 fields you currently need to get all fields and then extract the fields you need from there.\nhttps://issues.apache.org/jira/browse/CALCITE-2772",
    "description": "Introduction This is a User Defined Function for Apache Beam SQL.\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-beam-sql\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Available functions Getting a single value To get a single value from the parse result use this one:\nParseUserAgentField(userAgent, 'DeviceClass') AS deviceClassField to give\nPhone Getting several values as a Map (requires Apache Beam 2.30.0 or newer) You can ask for all fields and return the full map with all of them in there.",
    "tags": [],
    "title": "Apache Beam SQL",
    "uri": "/udf/apache-beam-sql/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is UDF for Apache Drill. This function was originally created by Charles S. Givre and was imported into the main Yauaa project to ensure users would have a prebuilt and up-to-date version available.\nThis function is now also packaged as part of Apache Drill itself: documentation.\nNotable changes With Yauaa 7.0.0\nthe code for this UDF has been copied back from the Drill project to ensure it keeps working as expected. the parse_user_agent_field has been removed and parse_user_agent supports the same input/output now. Usage I have copied/implemented the functions\nparse_user_agent ( \u003cuseragent\u003e ) parse_user_agent ( \u003cuseragent\u003e , \u003cdesired fieldname\u003e ) to support the analysis of the Client Hints it now also supports\nparse_user_agent ( \u003cuseragent\u003e , [\u003cheader name\u003e,\u003cvalue\u003e]+ ) or the variant which requires the presense of a User-Agent header.\nparse_user_agent ( [\u003cheader name\u003e,\u003cvalue\u003e]+ ) Installation By default, Apache Drill has a version of this udf built in (part of the drill-udfs-*.jar)\nIn order to update the version of Yauaa in your drill installation you’ll need to replace the yauaa related jars with the latest versions. This includes not only updating yauaa-8.0.0.jar and yauaa-logparser-8.0.0.jar but also the rellevant dependencies.\nIf you want to replace it completely you’ll also need to remove the drill-udfs-*.jar and copy the yauaa-drill-8.0.0.jar and all relevant dependencies to \u003cdrill-path\u003e/jars/3rdparty.\nSimilar:\nmvn -DgroupId=nl.basjes.parse.useragent -DartifactId=yauaa-drill -Dversion=8.0.0 dependency:get -DoutputDirectory=\"./deps/\" Make sure you replace \u003cdrill-path\u003e with your actual path to your drill installation. NOTE: You do not need the yauaa-drill-8.0.0-sources.jar to run in drill.\nUsage and examples Working queries with a direct value\nSELECT parse_user_agent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.82 Safari/537.36', 'AgentNameVersion') AS ANV from (values(1)); +---------------------+ | ANV | +---------------------+ | Chrome 48.0.2564.82 | +---------------------+ Or for the entire set of all values as a Drill map\nSELECT parse_user_agent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.82 Safari/537.36') AS UA from (values(1)); which is shown as a JSon in the commandline client:\n+----------------------------------------------------------------------------------+ | UA | +----------------------------------------------------------------------------------+ | {\"DeviceClass\":\"Desktop\",\"DeviceName\":\"Linux Desktop\",\"DeviceBrand\":\"Unknown\",\"DeviceCpu\":\"Intel x86_64\", \"DeviceCpuBits\":\"64\",\"DeviceFirmwareVersion\":\"??\",\"DeviceVersion\":\"??\",\"OperatingSystemClass\":\"Desktop\",\"OperatingSystemName\":\"Linux\",\"OperatingSystemVersion\":\"??\",\"OperatingSystemVersionMajor\":\"??\",\"OperatingSystemNameVersion\":\"Linux ??\",\"OperatingSystemNameVersionMajor\":\"Linux ??\",\"OperatingSystemVersionBuild\":\"??\",\"LayoutEngineClass\":\"Browser\",\"LayoutEngineName\":\"Blink\",\"LayoutEngineVersion\":\"48.0\",\"LayoutEngineVersionMajor\":\"48\",\"LayoutEngineNameVersion\":\"Blink 48.0\",\"LayoutEngineNameVersionMajor\":\"Blink 48\",\"LayoutEngineBuild\":\"Unknown\",\"AgentClass\":\"Browser\",\"AgentName\":\"Chrome\",\"AgentVersion\":\"48.0.2564.82\",\"AgentVersionMajor\":\"48\",\"AgentNameVersion\":\"Chrome 48.0.2564.82\",\"AgentNameVersionMajor\":\"Chrome 48\",\"AgentBuild\":\"Unknown\",\"AgentLanguage\":\"Unknown\",\"AgentLanguageCode\":\"Unknown\",\"AgentInformationEmail\":\"Unknown\",\"AgentInformationUrl\":\"Unknown\",\"AgentSecurity\":\"Unknown\",\"AgentUuid\":\"Unknown\",\"WebviewAppName\":\"Unknown\",\"WebviewAppVersion\":\"??\",\"WebviewAppVersionMajor\":\"??\",\"WebviewAppNameVersion\":\"Unknown ??\",\"WebviewAppNameVersionMajor\":\"Unknown ??\",\"FacebookCarrier\":\"Unknown\",\"FacebookDeviceClass\":\"Unknown\",\"FacebookDeviceName\":\"Unknown\",\"FacebookDeviceVersion\":\"??\",\"FacebookFBOP\":\"Unknown\",\"FacebookFBSS\":\"Unknown\",\"FacebookOperatingSystemName\":\"Unknown\",\"FacebookOperatingSystemVersion\":\"??\",\"Anonymized\":\"Unknown\",\"HackerAttackVector\":\"Unknown\",\"HackerToolkit\":\"Unknown\",\"KoboAffiliate\":\"Unknown\",\"KoboPlatformId\":\"Unknown\",\"IECompatibilityVersion\":\"??\",\"IECompatibilityVersionMajor\":\"??\",\"IECompatibilityNameVersion\":\"Unknown ??\",\"IECompatibilityNameVersionMajor\":\"Unknown ??\",\"Carrier\":\"Unknown\",\"GSAInstallationID\":\"Unknown\",\"NetworkType\":\"Unknown\",\"__SyntaxError__\":\"false\"} | +----------------------------------------------------------------------------------+ The function returns a Drill map, so you can access any of the fields using Drill’s table.map.key notation. For example, the query below illustrates how to extract a field from this map and summarize it:\nSELECT uadata.ua.AgentNameVersion AS Browser, COUNT( * ) AS BrowserCount FROM ( SELECT parse_user_agent( columns[0] ) AS ua FROM dfs.`/tmp/testcase.tsv` ) AS uadata GROUP BY uadata.ua.AgentNameVersion ORDER BY BrowserCount DESC; +----------------------+---------------+ | Browser | BrowserCount | +----------------------+---------------+ | Chrome 48.0.2564.82 | 1 | | Googlebot 2.1 | 1 | +----------------------+---------------+ Full example analyzing with the User-Agent Client Hints Assume an Apache Httpd webserver with the following LogFormat config:\nLogFormat \"%a %l %u %t \\\"%r\\\" %\u003es %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" \\\"%{Sec-CH-UA}i\\\" \\\"%{Sec-CH-UA-Arch}i\\\" \\\"%{Sec-CH-UA-Bitness}i\\\" \\\"%{Sec-CH-UA-Full-Version}i\\\" \\\"%{Sec-CH-UA-Full-Version-List}i\\\" \\\"%{Sec-CH-UA-Mobile}i\\\" \\\"%{Sec-CH-UA-Model}i\\\" \\\"%{Sec-CH-UA-Platform}i\\\" \\\"%{Sec-CH-UA-Platform-Version}i\\\" \\\"%{Sec-CH-UA-WoW64}i\\\" %V\" combinedhintsvhost Behind this Apache Httpd webserver is a website that returns the header\nAccept-CH: Sec-CH-UA, Sec-CH-UA-Arch, Sec-CH-UA-Bitness, Sec-CH-UA-Full-Version, Sec-CH-UA-Full-Version-List, Sec-CH-UA-Mobile, Sec-CH-UA-Model, Sec-CH-UA-Platform, Sec-CH-UA-Platform-Version, Sec-CH-UA-WoW64 With all of this in place: these are two of the lines that are found in the access log of this Apache Httpd webserver:\n45.138.228.54 - - [02/May/2022:12:25:10 +0200] \"GET / HTTP/1.1\" 200 16141 \"-\" \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36\" \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"\" \"\\\"x86\\\"\" \"\\\"64\\\"\" \"\\\"100.0.4896.127\\\"\" \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.127\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.127\\\"\" \"?0\" \"\\\"\\\"\" \"\\\"Linux\\\"\" \"\\\"5.13.0\\\"\" \"?0\" try.yauaa.basjes.nl 45.138.228.54 - - [02/May/2022:12:25:34 +0200] \"GET / HTTP/1.1\" 200 15376 \"-\" \"Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.0.0 Mobile Safari/537.36\" \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"101\\\", \\\"Google Chrome\\\";v=\\\"101\\\"\" \"\\\"\\\"\" \"-\" \"\\\"101.0.4951.41\\\"\" \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"101.0.4951.41\\\", \\\"Google Chrome\\\";v=\\\"101.0.4951.41\\\"\" \"?1\" \"\\\"Nokia 7.2\\\"\" \"\\\"Android\\\"\" \"\\\"11.0.0\\\"\" \"?0\" try.yauaa.basjes.nl For this example the name of this file is access.hints\nI start by doing a query on this data and ONLY use the User-Agent as the input:\nSELECT uadata.ua.DeviceClass AS DeviceClass, uadata.ua.AgentNameVersionMajor AS AgentNameVersionMajor, uadata.ua.OperatingSystemNameVersion AS OperatingSystemNameVersion FROM ( SELECT parse_user_agent(`request_user-agent`) AS ua FROM table( dfs.`/tmp/access.hints` ( type =\u003e 'httpd', logFormat =\u003e '%a %l %u %t \"%r\" %\u003es %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Sec-CH-UA}i\" \"%{Sec-CH-UA-Arch}i\" \"%{Sec-CH-UA-Bitness}i\" \"%{Sec-CH-UA-Full-Version}i\" \"%{Sec-CH-UA-Full-Version-List}i\" \"%{Sec-CH-UA-Mobile}i\" \"%{Sec-CH-UA-Model}i\" \"%{Sec-CH-UA-Platform}i\" \"%{Sec-CH-UA-Platform-Version}i\" \"%{Sec-CH-UA-WoW64}i\" %V', flattenWildcards =\u003e true ) ) ) AS uadata; which produces\n+-------------+-----------------------+----------------------------+ | DeviceClass | AgentNameVersionMajor | OperatingSystemNameVersion | +-------------+-----------------------+----------------------------+ | Desktop | Chrome 100 | Linux ?? | | Phone | Chrome 101 | Android ?? | +-------------+-----------------------+----------------------------+ 2 rows selected (0.183 seconds) The first example here does not have the exact version of the operating system as part of the User-Agent and this results in Linux ??.\nThe second example shows Android 10 but was recognized as being a reduced variant of the User-Agent, this means that the version 10 is an invalid standard value that is not true. So here you see Android ??.\nNow let’s repeat the same and use the recorded User-Agent Client Hint header values:\nSELECT uadata.ua.DeviceClass AS DeviceClass, uadata.ua.AgentNameVersionMajor AS AgentNameVersionMajor, uadata.ua.OperatingSystemNameVersion AS OperatingSystemNameVersion FROM ( SELECT parse_user_agent( 'User-Agent' , `request_user-agent`, 'sec-ch-ua', `request_header_sec-ch-ua`, 'sec-ch-ua-arch', `request_header_sec-ch-ua-arch`, 'sec-ch-ua-bitness', `request_header_sec-ch-ua-bitness`, 'sec-ch-ua-full-version', `request_header_sec-ch-ua-full-version`, 'sec-ch-ua-full-version-list', `request_header_sec-ch-ua-full-version-list`, 'sec-ch-ua-mobile', `request_header_sec-ch-ua-mobile`, 'sec-ch-ua-model', `request_header_sec-ch-ua-model`, 'sec-ch-ua-platform', `request_header_sec-ch-ua-platform`, 'sec-ch-ua-platform-version', `request_header_sec-ch-ua-platform-version`, 'sec-ch-ua-wow64', `request_header_sec-ch-ua-wow64` ) AS ua FROM table( dfs.`/tmp/access.hints` ( type =\u003e 'httpd', logFormat =\u003e '%a %l %u %t \"%r\" %\u003es %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{Sec-CH-UA}i\" \"%{Sec-CH-UA-Arch}i\" \"%{Sec-CH-UA-Bitness}i\" \"%{Sec-CH-UA-Full-Version}i\" \"%{Sec-CH-UA-Full-Version-List}i\" \"%{Sec-CH-UA-Mobile}i\" \"%{Sec-CH-UA-Model}i\" \"%{Sec-CH-UA-Platform}i\" \"%{Sec-CH-UA-Platform-Version}i\" \"%{Sec-CH-UA-WoW64}i\" %V', flattenWildcards =\u003e true ) ) ) AS uadata; which produces\n+-------------+-----------------------+----------------------------+ | DeviceClass | AgentNameVersionMajor | OperatingSystemNameVersion | +-------------+-----------------------+----------------------------+ | Desktop | Chrome 100 | Linux 5.13.0 | | Phone | Chrome 101 | Android 11.0.0 | +-------------+-----------------------+----------------------------+ 2 rows selected (0.275 seconds) The improvement after adding the Client Hints is evident.",
    "description": "Introduction This is UDF for Apache Drill. This function was originally created by Charles S. Givre and was imported into the main Yauaa project to ensure users would have a prebuilt and up-to-date version available.\nThis function is now also packaged as part of Apache Drill itself: documentation.\nNotable changes With Yauaa 7.0.0\nthe code for this UDF has been copied back from the Drill project to ensure it keeps working as expected. the parse_user_agent_field has been removed and parse_user_agent supports the same input/output now. Usage I have copied/implemented the functions",
    "tags": [],
    "title": "Apache Drill",
    "uri": "/udf/apache-drill/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Flink\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-flink\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Usage Assume you have a DataSet or DataStream with your records. In most cases I see (clickstream data) these records (In this example this class is called “TestRecord”) contain the useragent string in a field and the parsed results must be added to these fields.\nNow you must do two things:\nDetermine the names of the fields you need. Add an instance of the (abstract) UserAgentAnalysisMapper mapper and implement the functions as shown in the example below. Use the Field annotation to get the setter for the requested fields. Note that the name of the setters is not important, the system looks at the annotation.\nExample: Only User-Agent .map(new UserAgentAnalysisMapper\u003cTestRecord\u003e(15000) { // Setting the cacheSize @Override public String getUserAgentString(TestRecord record) { return record.useragent; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"OperatingSystemNameVersion\") public void setOSNV(TestRecord record, String value) { record.operatingSystemNameVersion = value; } }) Example: User-Agent Client Hints The only difference with the “Only User-Agent” implementation is that the getRequestHeaders is overridden. The resulting map should have the original request header names as keys and the actual header value as the value.\nTo illustrate:\nMap\u003cString, String\u003e requestHeaders = new TreeMap\u003c\u003e(); requestHeaders.put(\"User-Agent\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.0.0 Safari/537.36\"); requestHeaders.put(\"Sec-Ch-Ua\", \"\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Arch\", \"\\\"x86\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Full-Version-List\", \"\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.75\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.75\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Mobile\", \"?0\"); requestHeaders.put(\"Sec-Ch-Ua-Model\", \"\\\"\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform\", \"\\\"Windows\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Platform-Version\", \"\\\"0.1.0\\\"\"); requestHeaders.put(\"Sec-Ch-Ua-Wow64\", \"?0\"); Using the analyzer whould then be something like this:\n.map(new UserAgentAnalysisMapper\u003cTestRecord\u003e(15000) { // Setting the cacheSize @Override public Map\u003cString, String\u003e getRequestHeaders(TestRecord element) { return element.getHeaders(); } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"OperatingSystemNameVersion\") public void setOSNV(TestRecord record, String value) { record.operatingSystemNameVersion = value; } }) NOTES on defining it as an anonymous class An anonymous inner class in Java is by default private.\nIf you define it as an anonymous inner class as shown above then the system will try to make this class to become public by means of the method .setAccessible(true). There are situations in which this will fail (amongst others the SecurityManager can block this). If you run into such a scenario then simply ’not’ define it inline as an anonymous class and define it as a named (public) class instead.\nSo the earlier example will look something like this:\npublic class MyUserAgentAnalysisMapper extends UserAgentAnalysisMapper\u003cTestRecord\u003e { @Override public Map\u003cString, String\u003e getRequestHeaders(TestRecord element) { return element.getHeaders(); } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"DeviceClass\") public void setDC(TestRecord record, String value) { record.deviceClass = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"AgentNameVersion\") public void setANV(TestRecord record, String value) { record.agentNameVersion = value; } @SuppressWarnings(\"unused\") // Called via the annotation @YauaaField(\"OperatingSystemNameVersion\") public void setOSNV(TestRecord record, String value) { record.operatingSystemNameVersion = value; } } and then in the topology simply do this\n.map(new MyUserAgentAnalysisMapper())",
    "description": "Introduction This is a User Defined Function for Apache Flink\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-flink\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Usage Assume you have a DataSet or DataStream with your records. In most cases I see (clickstream data) these records (In this example this class is called “TestRecord”) contain the useragent string in a field and the parsed results must be added to these fields.",
    "tags": [],
    "title": "Apache Flink",
    "uri": "/udf/apache-flink/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Flink Table\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-flink-table\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Syntax Assume you register this function under the name ParseUserAgent Then the generic usage in your SQL is\nParseUserAgent(\u003cuseragent\u003e) This returns a Map\u003cString, String\u003e with all the requested values in one go.\nIf you want to make use of the support for the User-Agent Client Hints you must call the function from your SQL with a list of header name and value. The header names must be the same as what a browser would send to the webserver (see: Specification).\nEssentially two forms are now possible:\nParseUserAgent ( \u003cuseragent\u003e , [\u003cheader name\u003e,\u003cvalue\u003e]+ ) and the variant which requires the presense of a User-Agent header.\nParseUserAgent ( [\u003cheader name\u003e,\u003cvalue\u003e]+ ) For example:\nParseUserAgent( 'User-Agent', useragent, 'Sec-CH-UA-Platform', chPlatform, 'Sec-CH-UA-Platform-Version', chPlatformVersion ) AS parsedUseragent Example usage (Java) Assume you have either a BatchTableEnvironment or a StreamTableEnvironment in which you have defined your records as a table. In most cases I see (clickstream data) these records contain the useragent string in a column.\n// Give the stream a Table Name tableEnv.registerDataStream(\"AgentStream\", inputStream, \"timestamp, url, useragent\"); Now you must do four things:\nDetermine the names of the fields you need. Register the function with the full list of all the fields you want under the name you want. Use the function in your SQL to do the parsing and extract the fields from that. Run the query // Register the function with all the desired fieldnames and optionally the size of the cache tableEnv.registerFunction(\"ParseUserAgent\", new AnalyzeUseragentFunction(15000, \"DeviceClass\", \"AgentNameVersionMajor\")); // Define the query. String sqlQuery = \"SELECT useragent,\"+ \" ParseUserAgent(useragent) as parsedUseragent\" + \"FROM AgentStream\"; Table resultTable = tableEnv.sqlQuery(sqlQuery); // A String and the Map with all results TypeInformation\u003cRow\u003e tupleType = new RowTypeInfo(STRING, MAP(STRING, STRING)); DataStream\u003cRow\u003e resultSet = tableEnv.toAppendStream(resultTable, tupleType); or something like this\n// Register the function with all the desired fieldnames and optionally the size of the cache tableEnv.registerFunction(\"ParseUserAgent\", new AnalyzeUseragentFunction(15000, \"DeviceClass\", \"AgentNameVersionMajor\")); // Define the query. String sqlQuery = \"SELECT useragent,\"+ \" parsedUseragent['DeviceClass'] AS deviceClass,\" + \" parsedUseragent['AgentNameVersionMajor'] AS agentNameVersionMajor \" + \"FROM ( \" + \" SELECT useragent,\" + \" ParseUserAgent(useragent) AS parsedUseragent\" + \" FROM AgentStream \" + \")\"; Table resultTable = tableEnv.sqlQuery(sqlQuery); // 3 Strings TypeInformation\u003cRow\u003e tupleType = new RowTypeInfo(STRING, STRING, STRING); DataStream\u003cRow\u003e resultSet = tableEnv.toAppendStream(resultTable, tupleType);",
    "description": "Introduction This is a User Defined Function for Apache Flink Table\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency to your project.\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-flink-table\u003c/artifactId\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Syntax Assume you register this function under the name ParseUserAgent Then the generic usage in your SQL is\nParseUserAgent(\u003cuseragent\u003e) This returns a Map\u003cString, String\u003e with all the requested values in one go.",
    "tags": [],
    "title": "Apache Flink Table/SQL",
    "uri": "/udf/apache-flink-table/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Hive\nNOTE: Since Apache Hive 4.1.0 it needs Java 17 to build and run.\nGetting the UDF You can get the prebuilt UDF from maven central (yauaa-hive-8.0.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-hive-8.0.0-udf.jar\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-hive\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Building Simply install the normal build tools for a Java project (i.e. maven and jdk) and then simply do:\nmvn clean package Example usage First the jar file must be ‘known’ Either by doing\nADD JAR hdfs:///yauaa-hive-8.0.0-udf.jar or by defining it as a permanent function\nCREATE FUNCTION ParseUserAgent AS 'nl.basjes.parse.useragent.hive.ParseUserAgent' USING JAR 'hdfs:///yauaa-hive-8.0.0-udf.jar'; If you are using a recent version of Hive you can also do\nCREATE FUNCTION ParseUserAgent AS 'nl.basjes.parse.useragent.hive.ParseUserAgent' USING JAR 'ivy://nl.basjes.parse.useragent:yauaa-hive:8.0.0?classifier=udf'; or installing it locally with the Hive Server\nTODO: Document installation\nVerify if it has been installed\nDESCRIBE FUNCTION ParseUserAgent; +-----------------------------------------------------------------------+ | tab_name | +-----------------------------------------------------------------------+ | ParseUserAgent(str) - Parses the UserAgent into all possible pieces. | +-----------------------------------------------------------------------+ \u003e DESCRIBE FUNCTION EXTENDED ParseUserAgent; +---------------------------------------------------------------------------+ | tab_name | +---------------------------------------------------------------------------+ | parseuseragent(str) - Parses the UserAgent into all possible pieces. | | Synonyms: default.parseuseragent | | Example: | | \u003e SELECT ParseUserAgent(useragent).DeviceClass, | | ParseUserAgent(useragent).OperatingsystemNameVersion, | | ParseUserAgent(useragent).AgentNameVersionMajor | | FROM clickLogs; | | +---------------+-----------------------------+------------------------+ | | | deviceclass | operatingsystemnameversion | agentnameversionmajor | | | +---------------+-----------------------------+------------------------+ | | | Phone | Android 6.0 | Chrome 46 | | | | Tablet | Android 5.1 | Chrome 40 | | | | Desktop | Linux ?? | Chrome 59 | | | | Game Console | Windows 10.0 | Edge 13 | | | +---------------+-----------------------------+------------------------+ | | | +---------------------------------------------------------------------------+ Basic test it works (trimmed the output here)\n\u003e SELECT ParseUserAgent('Mozilla/5.0 (Linux\\; Android 6.0\\; Nexus 6 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36'); +----------------------------------------------------+ | _c0 | +----------------------------------------------------+ | { \"deviceclass\":\"Phone\", \"devicename\":\"Google Nexus 6\", \"devicebrand\":\"Google\", ... \"operatingsystemnameversion\":\"Android 6.0\", ... \"layoutenginenameversion\":\"Blink 46.0\", ... \"agentclass\":\"Browser\", ... \"agentnameversion\":\"Chrome 46.0.2490.76\", ... } | +----------------------------------------------------+ 1 row selected (5.682 seconds) Usage example:\nCREATE TABLE useragents (useragent STRING COMMENT 'The useragent string'); INSERT INTO TABLE useragents VALUES ('Mozilla/5.0 (Linux\\; Android 6.0\\; Nexus 6 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.76 Mobile Safari/537.36'); INSERT INTO TABLE useragents VALUES ('Mozilla/5.0 (Linux\\; Android 5.1\\; Nexus 10 Build/LMY47D) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.109 Safari/537.36'); INSERT INTO TABLE useragents VALUES ('Mozilla/5.0 (X11\\; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36'); INSERT INTO TABLE useragents VALUES ('Mozilla/5.0 (Windows NT 10.0\\; Win64\\; x64\\; Xbox\\; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2486.0 Safari/537.36 Edge/13.10553'); SELECT ParseUserAgent(useragent).DeviceClass, ParseUserAgent(useragent).OperatingsystemNameVersion, ParseUserAgent(useragent).AgentName, ParseUserAgent(useragent).AgentNameVersionMajor from useragents; +---------------+-----------------------------+------------+------------------------+ | deviceclass | operatingsystemnameversion | agentname | agentnameversionmajor | +---------------+-----------------------------+------------+------------------------+ | Phone | Android 6.0 | Chrome | Chrome 46 | | Tablet | Android 5.1 | Chrome | Chrome 40 | | Desktop | Linux ?? | Chrome | Chrome 59 | | Game Console | Windows 10.0 | Edge | Edge 13 | +---------------+-----------------------------+------------+------------------------+ ClientHints example If you pass only a single parameter it is assumed to be the “User-Agent”.\nIf you want to make use of the support for the User-Agent Client Hints you must call the function from your SQL with a list of header name and value. The header names must be the same as what a browser would send to the webserver (see: Specification).\nExample:\nSELECT 'CLIENTHINTS', parsedUseragentAllFields.DeviceClass AS deviceClass, parsedUseragentAllFields.AgentNameVersionMajor AS agentNameVersionMajor, parsedUseragentAllFields.OperatingSystemNameVersion AS operatingSystemNameVersion FROM ( SELECT ParseUserAgent( 'user-Agent', useragent, 'sec-CH-UA-Platform', chPlatform, 'sec-CH-UA-Platform-Version', chPlatformVersion ) AS parsedUseragentAllFields FROM clickLogs ) ParsedSubSelect;",
    "description": "Introduction This is a User Defined Function for Apache Hive\nNOTE: Since Apache Hive 4.1.0 it needs Java 17 to build and run.\nGetting the UDF You can get the prebuilt UDF from maven central (yauaa-hive-8.0.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-hive-8.0.0-udf.jar\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-hive\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Building Simply install the normal build tools for a Java project (i.e. maven and jdk) and then simply do:",
    "tags": [],
    "title": "Apache Hive",
    "uri": "/udf/apache-hive/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Apache Nifi\nIntroduction This is an Apache Nifi Processor for parsing User Agent Strings.\nGetting the Processor You can get the prebuilt NAR file from maven central.\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-nifi\u003c/artifactId\u003e \u003ctype\u003enar\u003c/type\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Installation To install this function put the nar file in the \u003cnifi-path\u003e/lib directory.\ncp ./udfs/nifi/nifi-nar/target/yauaa-nifi-\u003cversion\u003e.nar \u003cnifi-path\u003e/lib Make sure you replace \u003cnifi-path\u003e with your actual path to your nifi installation. After you have added this nar file you will find the ParseUserAgent processor in the list.\nUsage and examples First you make sure that the FlowFile going into this processor has the attributes needed as input.\nIn the configuration specify which attributes contain the values of the Request Headers that were logged. The only mandatory one is RequestHeader.UserAgent. The other properties refer to the original User-Agent Client Hints request header names. In the configuration enable the fields you need for analysis. By default none have been selected. The output FlowFile will now have additional attributes for all of the selected attributes that are named Useragent.SelectedField.\nKey: 'Useragent.DeviceClass' Value: 'Phone' Key: 'Useragent.OperatingSystemNameVersion' Value: 'Android 4.1.2' In this log example the XXsomethingXX attributes are the input values and the Useragent.something are the outputs:",
    "description": "Introduction This is a User Defined Function for Apache Nifi\nIntroduction This is an Apache Nifi Processor for parsing User Agent Strings.\nGetting the Processor You can get the prebuilt NAR file from maven central.\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-nifi\u003c/artifactId\u003e \u003ctype\u003enar\u003c/type\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Installation To install this function put the nar file in the \u003cnifi-path\u003e/lib directory.\ncp ./udfs/nifi/nifi-nar/target/yauaa-nifi-\u003cversion\u003e.nar \u003cnifi-path\u003e/lib Make sure you replace \u003cnifi-path\u003e with your actual path to your nifi installation. After you have added this nar file you will find the ParseUserAgent processor in the list.",
    "tags": [],
    "title": "Apache Nifi",
    "uri": "/udf/apache-nifi/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "DEPRECATED Apache Pig is no longer used. So with Yauaa 7 this UDF has been dropped. Version 6.12 is the last released version which still has the Apache Pig in it.\nIntroduction This is a User Defined Function for Apache Pig\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-pig\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e6.12\u003c/version\u003e \u003c/dependency\u003e Example usage -- Import the UDF jar file so this script can use it REGISTER ../target/*-udf.jar; ------------------------------------------------------------------------ -- Define a more readable name for the UDF and pass optional parameters -- First parameter is ALWAYS the cache size (as a text string!) -- The parameters after that are the requested fields. ---------- -- If you simply want 'everything' -- DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent; ---------- -- If you just want to set the cache -- DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent('10000'); ---------- -- If you want to set the cache and only retrieve the specified fields DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent('10000', 'DeviceClass', 'DeviceBrand' ); rawData = LOAD 'testcases.txt' USING PigStorage() AS ( useragent: chararray ); UaData = FOREACH rawData GENERATE useragent, -- Do NOT specify a type for this field as the UDF provides the definitions ParseUserAgent(useragent) AS parsedAgent;",
    "description": "DEPRECATED Apache Pig is no longer used. So with Yauaa 7 this UDF has been dropped. Version 6.12 is the last released version which still has the Apache Pig in it.\nIntroduction This is a User Defined Function for Apache Pig\nGetting the UDF You can get the prebuilt UDF from maven central.\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-pig\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e6.12\u003c/version\u003e \u003c/dependency\u003e Example usage -- Import the UDF jar file so this script can use it REGISTER ../target/*-udf.jar; ------------------------------------------------------------------------ -- Define a more readable name for the UDF and pass optional parameters -- First parameter is ALWAYS the cache size (as a text string!) -- The parameters after that are the requested fields. ---------- -- If you simply want 'everything' -- DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent; ---------- -- If you just want to set the cache -- DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent('10000'); ---------- -- If you want to set the cache and only retrieve the specified fields DEFINE ParseUserAgent nl.basjes.parse.useragent.pig.ParseUserAgent('10000', 'DeviceClass', 'DeviceBrand' ); rawData = LOAD 'testcases.txt' USING PigStorage() AS ( useragent: chararray ); UaData = FOREACH rawData GENERATE useragent, -- Do NOT specify a type for this field as the UDF provides the definitions ParseUserAgent(useragent) AS parsedAgent;",
    "tags": [],
    "title": "Apache Pig",
    "uri": "/udf/apache-pig/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "",
    "description": "",
    "tags": [],
    "title": "Categories",
    "uri": "/categories/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction With version 6.0 the dedicated commandline tool was removed.\nPrimary reason is that it was not getting any attention, and it did not perform well (mainly due to the relatively big startup overhead).\nSo if you have the need to use Yauaa from a commandline perspective the easiest way to do this is by starting the docker based webservlet locally (and leave it running “for a long time”) and use something like curl to get the information you are looking for.\nInitial startup Simply start the webservlet using docker and run it in the background (takes a few seconds):\ndocker pull nielsbasjes/yauaa:8.0.0 docker run --detach -p8080:8080 nielsbasjes/yauaa:8.0.0 Doing a single value AGENT=\"Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36\" curl -X POST \\ -H \"Content-Type: text/plain\" \\ http://localhost:8080/yauaa/v1/analyze/yaml \\ --data-binary \"${AGENT}\" Which outputs this:\n- test: input: user_agent_string: 'Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36' expected: DeviceClass : 'Phone' DeviceName : 'Google Nexus 6' DeviceBrand : 'Google' OperatingSystemClass : 'Mobile' OperatingSystemName : 'Android' OperatingSystemVersion : '7.0' OperatingSystemVersionMajor : '7' OperatingSystemNameVersion : 'Android 7.0' OperatingSystemNameVersionMajor : 'Android 7' OperatingSystemVersionBuild : 'NBD90Z' LayoutEngineClass : 'Browser' LayoutEngineName : 'Blink' LayoutEngineVersion : '53.0' LayoutEngineVersionMajor : '53' LayoutEngineNameVersion : 'Blink 53.0' LayoutEngineNameVersionMajor : 'Blink 53' AgentClass : 'Browser' AgentName : 'Chrome' AgentVersion : '53.0.2785.124' AgentVersionMajor : '53' AgentNameVersion : 'Chrome 53.0.2785.124' AgentNameVersionMajor : 'Chrome 53' Doing a large number of values You can upload a file with useragents to the rest interface (there is a size limitation for this).\ncurl -X POST \\ -H \"Content-Type: text/plain\" \\ http://localhost:8080/yauaa/v1/analyze/yaml \\ --data-binary \"@useragents.txt\"",
    "description": "Introduction With version 6.0 the dedicated commandline tool was removed.\nPrimary reason is that it was not getting any attention, and it did not perform well (mainly due to the relatively big startup overhead).\nSo if you have the need to use Yauaa from a commandline perspective the easiest way to do this is by starting the docker based webservlet locally (and leave it running “for a long time”) and use something like curl to get the information you are looking for.",
    "tags": [],
    "title": "Commandline usage",
    "uri": "/udf/commandline/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction User Defined Function (Filter plugin) for Elastic Logstash\nSTATUS: … DROPPED … With Yauaa 7.18.0 the logstash UDF has been dropped.\nThe primary reason is that 3 years after Elastic announced Java UDF support as “GA” they have not published the needed dependencies. The workaround I came up with is starting to cause more and more problems so I’m dropping it.\nStill want it? Get the sources from the latest tag that still had it and build it yourself. https://github.com/nielsbasjes/yauaa/tree/v7.17.1/udfs/elastic/logstash\nSee for more information:\nhttps://github.com/logstash-plugins/logstash-filter-java_filter_example https://github.com/elastic/logstash/issues/9215 https://github.com/nielsbasjes/yauaa/issues/146 https://github.com/elastic/logstash/issues/11002 Installing the filter You only need to install it into your logstash once per installation\nlogstash-plugin remove logstash-filter-yauaa logstash-plugin install ./udfs/logstash/target/logstash-filter-yauaa-8.0.0.gem Example usage You need to specify\nThe source field which maps the fields in the record to their original request headers. For each Yauaa field you need the logstash field in which it needs to be placed. filter { yauaa { source =\u003e { \"ua\" =\u003e \"User-Agent\" \"uap\" =\u003e \"Sec-CH-UA-Platform\" \"uapv\" =\u003e \"Sec-CH-UA-Platform-Version\" } fields =\u003e { \"DeviceClass\" =\u003e \"uaDC\" \"DeviceName\" =\u003e \"uaDN\" \"DeviceBrand\" =\u003e \"uaDB\" \"OperatingSystemClass\" =\u003e \"uaOSC\" \"OperatingSystemNameVersion\" =\u003e \"uaOSNV\" \"LayoutEngineClass\" =\u003e \"uaLEC\" \"LayoutEngineNameVersion\" =\u003e \"uaLENV\" \"AgentClass\" =\u003e \"uaAC\" \"AgentName\" =\u003e \"uaAN\" \"AgentNameVersion\" =\u003e \"uaAANV\" \"AgentNameVersionMajor\" =\u003e \"uaANVM\" } } } When running this example I get output like this (sorted the fields for readbility) that has the new fields:\n{ \"@timestamp\" =\u003e 2022-04-24T09:30:11.051Z, \"@version\" =\u003e \"1\", \"host\" =\u003e \"b9bf088b8c92\", \"message\" =\u003e \"HeartBeat event to trigger the test\", \"ua\" =\u003e \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36\", \"uap\" =\u003e \"\\\"macOS\\\"\", \"uapv\" =\u003e \"\\\"12.3.1\\\"\", \"uaDC\" =\u003e \"Desktop\", \"uaDN\" =\u003e \"Apple Macintosh\", \"uaDB\" =\u003e \"Apple\", \"uaOSC\" =\u003e \"Desktop\", \"uaOSNV\" =\u003e \"Mac OS 12.3.1\", \"uaLEC\" =\u003e \"Browser\", \"uaLENV\" =\u003e \"Blink 100.0\", \"uaAC\" =\u003e \"Browser\", \"uaAN\" =\u003e \"Chrome\", \"uaANVM\" =\u003e \"Chrome 100\", \"uaAANV\" =\u003e \"Chrome 100.0.4896.60\" }",
    "description": "Introduction User Defined Function (Filter plugin) for Elastic Logstash\nSTATUS: … DROPPED … With Yauaa 7.18.0 the logstash UDF has been dropped.\nThe primary reason is that 3 years after Elastic announced Java UDF support as “GA” they have not published the needed dependencies. The workaround I came up with is starting to cause more and more problems so I’m dropping it.\nStill want it? Get the sources from the latest tag that still had it and build it yourself. https://github.com/nielsbasjes/yauaa/tree/v7.17.1/udfs/elastic/logstash",
    "tags": [],
    "title": "Elastic LogStash",
    "uri": "/udf/elastic-logstash/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction User Defined Function (ingest processor) for Elasticsearch\nSTATUS: … EXPERIMENTAL … The ElasticSearch ingest plugin is very new.\nAnd yes it is similar to https://www.elastic.co/guide/en/elasticsearch/reference/master/user-agent-processor.html\nGetting the UDF Starting with 7.31.0 the prebuilt UDF is no longer distributed by me.\nThe ONLY reason for this change is that ElasticSearch is VERY picky about the version of ES the Plugin was built for. If you have a Yauaa Plugin that was built against ES 8.17.1 then that plugin will not load in ES 8.17.2.\nThe way now for you to get the right version of the plugin for your installation is to build de UDF yourself.\nGet a Linux machine (I use Ubuntu 24.04 LTS) with docker and git installed. Running this in a VM or a recent WSL (running on Windows 11) is fine.\nGet the sourcecode and open the latest released version\ngit clone https://github.com/nielsbasjes/yauaa cd yauaa git checkout v8.0.0 Change to the exact version you need. Edit in the pom.xml the property for the version you need. Assume you want it for ES 8.17.3 then change the elasticsearch-8.version property to that version. This command does that:\nsed -i 's@\u003celasticsearch-8.version\u003e[^\u003c]\\+\u003c/elasticsearch-8.version\u003e@\u003celasticsearch-8.version\u003e8.17.3\u003c/elasticsearch-8.version\u003e@g' pom.xml In this example it will look like this \u003celasticsearch-8.version\u003e8.17.3\u003c/elasticsearch-8.version\u003e.\nStart the docker based build environment.\n./start-docker.sh In this environment build the plugin\nmvn package -pl :yauaa-devtools,:yauaa-elasticsearch-8 Exit the docker based environment again\nexit Now you should have the file udfs/elastic/elasticsearch-8/target/yauaa-elasticsearch-8-8.0.0.zip which you can install on your installation.\nReplace elasticsearch-8 with elasticsearch-9 in the above example in case you have an ElasticSearch 9.x installation.\nInstalling the plugin You only need to install it into your ElasticSearch once\nOn Elasticsearch 8.x\nbin/elasticsearch-plugin install file:///path/to/yauaa-elasticsearch-8-8.0.0.zip On Elasticsearch 9.x\nbin/elasticsearch-plugin install file:///path/to/yauaa-elasticsearch-9-8.0.0.zip Usage This plugin is intended to be used in an ingest pipeline.\nYou have to specify the name of the input field and the place where the possible configuration flags are:\nName Mandatory/Optional Description Default Example field_to_header_mapping M The mapping from the input field name to the original request header name of this field - \"field_to_header_mapping\" : { \"ua\": \"User-Agent\" } target_field M The name of the output structure that will be filled with the parse results \"user_agent\" \"parsed_ua\" fieldNames O A list of Yauaa fieldnames that are desired. When specified the system will limit processing to what is needed to get these. This means faster and less memory used. All possible fields [ \"DeviceClass\", \"DeviceBrand\", \"DeviceName\", \"AgentNameVersionMajor\" ] cacheSize O The number of entries in the LRU cache of the parser 10000 100 preheat O How many testcases are put through the parser at startup to warmup the JVM 0 1000 extraRules O A yaml expression that is a set of extra rules and testcases. - \"config:\\n- matcher:\\n extract:\\n - '\"'\"'FirstProductName : 1 :agent.(1)product.(1)name'\"'\"'\\n\" Example usage Basic pipeline Create a pipeline that just extracts everything using the default settings:\ncurl -H 'Content-Type: application/json' -X PUT 'localhost:9200/_ingest/pipeline/yauaa-test-pipeline_basic' -d ' { \"description\": \"A pipeline to do whatever\", \"processors\": [ { \"yauaa\" : { \"field_to_header_mapping\" : { \"useragent\": \"User-Agent\", \"uach_platform\": \"Sec-CH-UA-Platform\", \"uach_platform_version\": \"Sec-CH-UA-Platform-Version\" }, \"target_field\" : \"parsed\" } } ] } ' Common pipeline In this example a pipeline is created that only gets the fields that are actually desired.\ncurl -H 'Content-Type: application/json' -X PUT 'localhost:9200/_ingest/pipeline/yauaa-test-pipeline_some' -d ' { \"description\": \"A pipeline to do whatever\", \"processors\": [ { \"yauaa\" : { \"field_to_header_mapping\" : { \"useragent\": \"User-Agent\", \"uach_platform\": \"Sec-CH-UA-Platform\", \"uach_platform_version\": \"Sec-CH-UA-Platform-Version\" }, \"target_field\" : \"parsed\", \"fieldNames\" : [ \"DeviceClass\", \"DeviceBrand\", \"DeviceName\", \"AgentNameVersionMajor\", \"FirstProductName\" ], } } ] } ' Advanced pipeline In this example a pipeline is created that includes an example of a custom rule. The hardest part is making the yaml (with quotes, newlines and the needed indentation) encode correctly inside a JSon structure.\ncurl -H 'Content-Type: application/json' -X PUT 'localhost:9200/_ingest/pipeline/yauaa-test-pipeline_full' -d ' { \"description\": \"A pipeline to do whatever\", \"processors\": [ { \"yauaa\" : { \"field_to_header_mapping\" : { \"useragent\": \"User-Agent\", \"uach_platform\": \"Sec-CH-UA-Platform\", \"uach_platform_version\": \"Sec-CH-UA-Platform-Version\" }, \"target_field\" : \"parsed\", \"fieldNames\" : [ \"DeviceClass\", \"DeviceBrand\", \"DeviceName\", \"AgentNameVersionMajor\", \"FirstProductName\" ], \"cacheSize\" : 10, \"preheat\" : 10, \"extraRules\" : \"config:\\n- matcher:\\n extract:\\n - '\"'\"'FirstProductName : 1 :agent.(1)product.(1)name'\"'\"'\\n\" } } ] } ' Put record I put a record in ElasticSearch using the above mentioned Advanced pipeline\ncurl -H 'Content-Type: application/json' -X PUT 'localhost:9200/my-index/my-type/1?pipeline=yauaa-test-pipeline_full' -d ' { \"useragent\" : \"Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36\" } ' which returns\n{\"_index\":\"my-index\",\"_type\":\"my-type\",\"_id\":\"1\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"_seq_no\":0,\"_primary_term\":1} then I retrieve the record from elasticsearch and the additional parse results are now part of the indexed record.\ncurl -s -H 'Content-Type: application/json' -X GET 'localhost:9200/my-index/my-type/1' | python -m json.tool results in\n{ \"_id\": \"1\", \"_index\": \"my-index\", \"_primary_term\": 1, \"_seq_no\": 0, \"_source\": { \"parsed\": { \"AgentName\": \"Chrome\", \"AgentNameVersionMajor\": \"Chrome 53\", \"AgentVersion\": \"53.0.2785.124\", \"AgentVersionMajor\": \"53\", \"DeviceBrand\": \"Google\", \"DeviceClass\": \"Phone\", \"DeviceName\": \"Google Nexus 6\", \"FirstProductName\": \"Mozilla\" }, \"useragent\": \"Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36\" }, \"_type\": \"my-type\", \"_version\": 1, \"found\": true } NOTES for developers The ElasticSearch testing tools are quick to complain about jar classloading issues: “jar hell”.\nTo make it possible to test this in IntelliJ you’ll need to set a custom property\nHelp –\u003e Edit Custom properties Make sure there is a line with idea.no.launcher=true Restart IntelliJ See also https://stackoverflow.com/questions/51045201/using-the-elasticsearch-test-framework-in-intellij-how-to-resolve-the-jar-hell/51045272",
    "description": "Introduction User Defined Function (ingest processor) for Elasticsearch\nSTATUS: … EXPERIMENTAL … The ElasticSearch ingest plugin is very new.\nAnd yes it is similar to https://www.elastic.co/guide/en/elasticsearch/reference/master/user-agent-processor.html\nGetting the UDF Starting with 7.31.0 the prebuilt UDF is no longer distributed by me.\nThe ONLY reason for this change is that ElasticSearch is VERY picky about the version of ES the Plugin was built for. If you have a Yauaa Plugin that was built against ES 8.17.1 then that plugin will not load in ES 8.17.2.",
    "tags": [],
    "title": "Elasticsearch",
    "uri": "/udf/elastic-search/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for LogParser\nGetting the UDF You can get the prebuilt UDF from maven central (yauaa-logparser-8.0.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-logparser-8.0.0-udf.jar\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-logparser\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Client hints Because the logparser can only dissect a single field into multiple pieces it is impossible to extend this to support User-Agent Client Hints.",
    "description": "Introduction This is a User Defined Function for LogParser\nGetting the UDF You can get the prebuilt UDF from maven central (yauaa-logparser-8.0.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-logparser-8.0.0-udf.jar\nIf you use a maven based project simply add this dependency\n\u003cdependency\u003e \u003cgroupId\u003enl.basjes.parse.useragent\u003c/groupId\u003e \u003cartifactId\u003eyauaa-logparser\u003c/artifactId\u003e \u003cclassifier\u003eudf\u003c/classifier\u003e \u003cversion\u003e8.0.0\u003c/version\u003e \u003c/dependency\u003e Client hints Because the logparser can only dissect a single field into multiple pieces it is impossible to extend this to support User-Agent Client Hints.",
    "tags": [],
    "title": "LogParser",
    "uri": "/udf/logparser/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction User Defined Function for Snowflake.\nSTATUS: … EXPERIMENTAL … The Snowflake UDF is very experimental for two reasons:\nSnowflake has marked (last checked on 2021-11-07) Java based UDFs as a Preview Feature. I do not have Snowflake so I do not have any way of testing this other than getting feedback from you. Thanks to Luke Ambrosetti for helping out here!\nSee for more information:\nhttps://docs.snowflake.com/en/developer-guide/udf/java/udf-java.html Installation and usage Download the UDF jar to the local file system and upload into a Snowflake internal or external stage.\nYou can get the prebuilt UDF from maven central (yauaa-snowflake-8.0.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-snowflake-8.0.0-udf.jar\nRegister the function in Snowflake with something like this:\ncreate or replace function parse_useragent(useragent ARRAY) returns object language java imports = ('@cs_stage/yauaa-snowflake-8.0.0-udf.jar') handler='nl.basjes.parse.useragent.snowflake.ParseUserAgent.parse'; NOTE: The argument of the UDF was in Yauaa 6 defined as a VARCHAR, it must now be defined as an ARRAY!\nAnd from there you can use it as a function in your SQL statements select parse_useragent( 'Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD90Z) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.124 Mobile Safari/537.36' ) as ua_obj, ua_obj:AgentClass::string as agent_class; Using User-Agent Client Hints With version 7.0.0 you are now able to analyze the Client Hints aswell.\nNote: The arguments to the function are a single array of values!\nselect parse_useragent( ['User-Agent', 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36', 'Sec-Ch-Ua', '\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"', 'Sec-Ch-Ua-Arch', '\\\"x86\\\"', 'Sec-Ch-Ua-Bitness', '\\\"64\\\"', 'Sec-Ch-Ua-Full-Version', '\\\"100.0.4896.127\\\"', 'Sec-Ch-Ua-Full-Version-List', '\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.127\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.127\\\"', 'Sec-Ch-Ua-Mobile', '?0', 'Sec-Ch-Ua-Model', '\\\"\\\"', 'Sec-Ch-Ua-Platform', '\\\"Linux\\\"', 'Sec-Ch-Ua-Platform-Version', '\\\"5.13.0\\\"', 'Sec-Ch-Ua-Wow64', '?0'] ) as ua_obj, ua_obj:OperatingSystemNameVersion::string as operating_system_name_version; When only examining the User-Agent this returns Linux ??, with the added information in the Client Hints you should get Linux 5.13.0 instead.\nNote that this next form is also supported (the first is the User-Agent, from there it is a list of “header name” and “value”):\nselect parse_useragent( ['Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36', 'Sec-Ch-Ua', '\\\" Not A;Brand\\\";v=\\\"99\\\", \\\"Chromium\\\";v=\\\"100\\\", \\\"Google Chrome\\\";v=\\\"100\\\"', 'Sec-Ch-Ua-Arch', '\\\"x86\\\"', 'Sec-Ch-Ua-Bitness', '\\\"64\\\"', 'Sec-Ch-Ua-Full-Version', '\\\"100.0.4896.127\\\"', 'Sec-Ch-Ua-Full-Version-List', '\\\" Not A;Brand\\\";v=\\\"99.0.0.0\\\", \\\"Chromium\\\";v=\\\"100.0.4896.127\\\", \\\"Google Chrome\\\";v=\\\"100.0.4896.127\\\"', 'Sec-Ch-Ua-Mobile', '?0', 'Sec-Ch-Ua-Model', '\\\"\\\"', 'Sec-Ch-Ua-Platform', '\\\"Linux\\\"', 'Sec-Ch-Ua-Platform-Version', '\\\"5.13.0\\\"', 'Sec-Ch-Ua-Wow64', '?0'] ) as ua_obj, ua_obj:OperatingSystemNameVersion::string as operating_system_name_version;",
    "description": "Introduction User Defined Function for Snowflake.\nSTATUS: … EXPERIMENTAL … The Snowflake UDF is very experimental for two reasons:\nSnowflake has marked (last checked on 2021-11-07) Java based UDFs as a Preview Feature. I do not have Snowflake so I do not have any way of testing this other than getting feedback from you. Thanks to Luke Ambrosetti for helping out here!\nSee for more information:\nhttps://docs.snowflake.com/en/developer-guide/udf/java/udf-java.html Installation and usage Download the UDF jar to the local file system and upload into a Snowflake internal or external stage.",
    "tags": [],
    "title": "Snowflake",
    "uri": "/udf/snowflake/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction If you are a user of the Snowplow Analytics system and would like to use Yauaa in your analysis you are in luck.\nThe people at Snowplow have included Yauaa as a readily available feature in their system.\nThe official documentation: Snowplow Yauaa Enrichment",
    "description": "Introduction If you are a user of the Snowplow Analytics system and would like to use Yauaa in your analysis you are in luck.\nThe people at Snowplow have included Yauaa as a readily available feature in their system.\nThe official documentation: Snowplow Yauaa Enrichment",
    "tags": [],
    "title": "Snowplow",
    "uri": "/udf/snowplow/index.html"
  },
  {
    "breadcrumb": "Yauaa",
    "content": "",
    "description": "",
    "tags": [],
    "title": "Tags",
    "uri": "/tags/index.html"
  },
  {
    "breadcrumb": "Yauaa \u003e User Defined Functions",
    "content": "Introduction This is a User Defined Function for Trino (a.k.a. Presto SQL)\nDEPRECATED Trino is no longer supported because of\nthe continued need to update to the latest non-LST Java version. release 477 no longer released the dependencies needed to run integration tests. So with Yauaa 8 this UDF has been dropped.\nYauaa version 7.32.0 is the last released version which still has it (version 476).\nSTATUS: … EXPERIMENTAL … The Trino plugin is very new. Please tell if it works or not in your case.\nTrino now requires Java 24 (which is non-LTS) which is not readily available for installation in Ubuntu using a normal package manager. This means that I have chosen to no longer let the build fail if you do not have that Java version installed. The CI build runs with the correct version so any breaking API changes should be detected there.\nThis UDF will simply not be built if Java 24 is missing.\nInstallation You can get the prebuilt UDF from maven central (yauaa-trino-7.32.0-udf.jar).\nNOTE: You MUST use the -udf.jar: yauaa-trino-7.32.0-udf.jar\nIn the plugin directory of your Trino server create a subdirectory and copy the yauaa-trino-7.32.0-udf.jar to that new directory.\nIn the trino docker image this is /usr/lib/trino/plugin/ so putting the jar in something like /usr/lib/trino/plugin/yauaa is a fine choice.\nImportant note: This directory may only contain this jar file; no other files may be present!\nUsage This UDF provides two new functions parse_user_agent(\u003cuseragent\u003e) and parse_user_agent(array(\u003cparameters\u003e)).\nThis first function needs one input which is the UserAgent string that needs to be analyzed.\nThe return value is a map(varchar, varchar) which is a key value map of all possible properties.\nThe second function needs a list of header name, value pairs to define the headers on which the provided values were originally received.\nExample : Just the User-Agent string. SELECT parsedUseragent['DeviceClass'] AS DeviceClass, parsedUseragent['AgentNameVersionMajor'] AS AgentNameVersionMajor, parsedUseragent['OperatingSystemNameVersion'] AS OperatingSystemNameVersion FROM ( SELECT useragent, parse_user_agent(useragent) AS parsedUseragent FROM ( SELECT useragent FROM ( VALUES ('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36') ) AS t (useragent) ) ); Outputs:\nDeviceClass | AgentNameVersionMajor | OperatingSystemNameVersion -------------+-----------------------+---------------------------- Desktop | Chrome 100 | Mac OS \u003e=10.15.7 (1 row) Example : User-Agent string and ClientHints. SELECT parsedUseragent['DeviceClass'] AS DeviceClass, parsedUseragent['AgentNameVersionMajor'] AS AgentNameVersionMajor, parsedUseragent['OperatingSystemNameVersion'] AS OperatingSystemNameVersion FROM ( SELECT useragent, chPlatform, chPlatformVersion, parse_user_agent( ARRAY[ 'user-Agent', useragent, 'sec-CH-UA-Platform', chPlatform, 'sec-CH-UA-Platform-Version', chPlatformVersion ] ) AS parsedUseragent FROM ( SELECT useragent, chPlatform, chPlatformVersion FROM ( VALUES ('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36', '\"macOS\"', '\"12.3.1\"') ) AS t (useragent, chPlatform, chPlatformVersion) ) ); Outputs:\nDeviceClass | AgentNameVersionMajor | OperatingSystemNameVersion -------------+-----------------------+---------------------------- Desktop | Chrome 100 | Mac OS 12.3.1 (1 row)",
    "description": "Introduction This is a User Defined Function for Trino (a.k.a. Presto SQL)\nDEPRECATED Trino is no longer supported because of\nthe continued need to update to the latest non-LST Java version. release 477 no longer released the dependencies needed to run integration tests. So with Yauaa 8 this UDF has been dropped.\nYauaa version 7.32.0 is the last released version which still has it (version 476).\nSTATUS: … EXPERIMENTAL … The Trino plugin is very new. Please tell if it works or not in your case.",
    "tags": [],
    "title": "Trino",
    "uri": "/udf/trino/index.html"
  },
  {
    "breadcrumb": "",
    "content": "This is a java library that tries to parse and analyze the useragent string (and when available the User-Agent Client Hints) and extract as many relevant attributes as possible.\nWorks with Java, Scala, Kotlin and provides ready for use UDFs for several processing systems.\nThe full documentation can be found here https://yauaa.basjes.nl\nIf you just want to give it a quick try then you can do that with your own browser here: https://try.yauaa.basjes.nl/ (runs on a very slow and rate limited machine).\nSignificant change happened in Apple iPads Since about February 2025 the Apple iPads no longer are reported as a Tablet because their useragent has switched to reporting a Desktop:\nA known device which was previously reporting these useragents\nMozilla/5.0 (iPad; CPU OS 18_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 Mozilla/5.0 (iPad; CPU OS 18_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) is now reporting this one\nMozilla/5.0 (Macintosh; Intel Mac OS 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Safari/605.1.15 This last one is identical to an Apple Mac Desktop and this makes it impossible to determine that this is really a Tablet.\nCurrently (April 2025) it seems that this effect is different depending on the used browser. Browsers like Chrome, Edge, Opera, Aloha and Yandex still report iPad Tablet, but browsers like Safari, Brave, Firefox, DuckDuckGo and Arc Search report MacOS Desktop\nHIGH Profile release notes: These are only the highlights for the last few releases, the full changelog can be found here.\nNEXT RELEASE New/improved detections: … Version v8.0.0 Analyzer: Needs Java 17 LTS to run (no longer a Multi Release jar!). Support for being used in a native GraalVM application. Build: Needs Java 25 LTS to build. Use a Kotlin based file sorter to fix reproducibility issue. UDFs; Dropping the Trino UDF Dropping the ElasticSearch 7.x UDF (ES7 is EOL) New/improved detections: Robot StatusCake (thanks to https://github.com/bdmendes) Robot DatadogSynthetics (thanks to https://github.com/notflorian) Browsers: HeyTapBrowser, Avira, Samsung Browser for Windows Hacking tools: Assetnote, Openbullet, Acunetix Anonymizer PrivacyWall BugBounty cases Google Gemini App on iOS Handle escaped slashes like “Mozilla/5.0” Partially handle Useragents with removed spaces Detect language code fragments. Tolino eReaders Fitage app (partial because much is hidden in a base64 block) SamsungBrowser starts with “Samsung” but does not imply the brand Samsung Version v7.32.0 Analyzer: Disable using the default constructor (thanks to https://github.com/izeye) Build Require JDK 24 installed for Trino support. Remove workaround for conjars.org going away. New/improved detections: IntelliJ IDEA (now Desktop App on a Desktop) Safari 26 on iOS 26 Electron Desktop App using special format UDFs: Update UDF for Elasticsearch 9 to their API changes Version v7.31.0 New/improved detections: CrowBrowser (LG SmartTV), Robots: Scrapy, HTTPie OpenHarmony ArkWeb (HuaweiOS browser engine) UDFs New UDF for Elasticsearch 9 All Elasticsearch UDFs(Plugins) must be built by the user for their specific version. License I’m publishing this under the Apache 2.0 license because I believe it is the best way to make these kinds of projects available to the world.\nBut do not underestimate how much work went into this. I have spent over a decade tuning this project to what you have now.\nAll I want to see in return is a little bit of gratitude from the people who use this. If you are a home user/hobbyist/small business then a simple star on the project is enough for me. Seeing that people use and like the things I create is what I’m doing this for. What also really helps are bug reports, headers from real/new devices/browsers that I have net yet seen before and discussions on things you think can be done better.\nDespite there not being any obligation (because of the Apache 2.0 license); If you are a big corporation where my code really adds value to the products you make/sell then I would really appreciate it if you could do a small sponsor thing. Buy me lunch (€10), Buy me a game (€100) or what ever you think is the right way to say thank you for the work I have done.\nYet Another UserAgent Analyzer Copyright (C) 2013-2026 Niels Basjes Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License. You may obtain a copy of the License at https://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.",
    "description": "This is a java library that tries to parse and analyze the useragent string (and when available the User-Agent Client Hints) and extract as many relevant attributes as possible.",
    "tags": [],
    "title": "Yauaa: Yet Another UserAgent Analyzer",
    "uri": "/index.html"
  }
]
